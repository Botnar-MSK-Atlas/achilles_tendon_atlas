---
title: "Rounding matrices"
author: "Carla Cohen"
date: "`r Sys.Date()`"
output: html_document
---
For running SCVI I need to use the soupX matrix that was rounded to the nearest integer. 
When I ran it, I left the unrounded values in the soupX matrix. 

One option would be to go back and run soupX again and save the output as a rounded matrix. 

Alternatively, I could try applying the rounding retrospectively using a regular rounding algorithm. 

I will test this on one sample. 

# set up


```{r setup, load packages, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(SingleCellExperiment)
library(SoupX)
library(tidyverse)
library(viridis)

```

# Load data

Read in a sce that already has the soupX matrix calculated but not rounded
```{r}
sce <- readRDS("20231107_08-24_SoupX.dir/RDS_objects.dir/SingleCellExp/MSK0785-Ach-Enth_filtered_soupX_SingleCellExp.rds")
sce
```
Extract the soupX matrix
```{r}
soupX_decimal <- assays(sce)$soupX
head(soupX_decimal)
```

Round the matrix using the function "round"

```{r}
soupX_integer <- round(soupX_decimal, 0)
head(soupX_integer)
```

# Load in the sce without soupX calculated

```{r}
sce_filter_manual <- readRDS("/project/tendonhca/shared/chromium/analysis/20231006_achilles/20231106_15-31_Ambient-doublet.dir/RDS_objects.dir/ambient_filtered_doublet_calculated/MSK0785-Ach-Enth_ambient_filtered_doublet_calculated_SingleCellExp.rds")
sce_raw <-  readRDS("/project/tendonhca/shared/chromium/analysis/20231006_achilles/20231011_14-39_QC-Filter.dir/RDS_objects.dir/raw/MSK0785-Ach-Enth_raw_SingleCellExp.rds")
```

set up the soup channel

```{r}
rownames(sce_raw)  <- rownames(sce_filter_manual)
soup.channel <- SoupChannel(counts(sce_raw), counts(sce_filter_manual))
# add metadata (seurat clusters) to the soup channel
clusters <- setNames(pull(colData(sce_filter_manual)$seurat_clusters),
                              rownames(colData(sce_filter_manual)))
#print("Cluster info")
#print(head(clusters))
#print ("Adding clusters to soup channel")
soup.channel  <- setClusters(soup.channel, clusters)
# add dim reduction to the soup channel
#print ("Adding dim red to soup channel")
soup.channel  <- setDR(soup.channel, reducedDim(sce_filter_manual, "umap"))

# run the estimation
soup.channel  <- autoEstCont(soup.channel)
```

```{r}
# get the count matrix with decimals
adj.matrix  <- adjustCounts(soup.channel, roundToInt = F)
assay(sce_filter_manual, "soupX_decimal") <- adj.matrix

# get the count matrix with integers
adj.matrix  <- adjustCounts(soup.channel, roundToInt = T)
assay(sce_filter_manual, "soupX_integer") <- adj.matrix

# round the soupX_decimal assay within the sce
assay(sce_filter_manual, "soupX_rounded") <- round(assay(sce_filter_manual, "soupX_decimal"), 0)
sce_filter_manual
```
```{r}
# have a look at the matrices
head(assay(sce_filter_manual, "soupX_decimal"))
head(assay(sce_filter_manual, "soupX_integer"))
head(assay(sce_filter_manual, "soupX_rounded"))
```
Are the second two matrices identical?

```{r}
identical(assay(sce_filter_manual, "soupX_integer"), assay(sce_filter_manual, "soupX_rounded"))
```

```{r}
# Create seurat object
so_soupX <- CreateSeuratObject(counts = counts(sce_filter_manual), 
                   project = mainExpName(sce_filter_manual), 
                   assay = "RNA", 
                   meta.data = as.data.frame(colData(sce_filter_manual)))
    
# add the decontX counts
#so_soupX[["decontXcounts"]] <- CreateAssayObject(
#        counts = decontXcounts(sce_filter_manual))
    
# add the soupX counts
so_soupX[["soupX_decimal"]] <- CreateAssayObject(
        counts = assay(sce_filter_manual, "soupX_decimal"))
so_soupX[["soupX_integer"]] <- CreateAssayObject(
        counts = assay(sce_filter_manual, "soupX_integer"))
so_soupX[["soupX_rounded"]] <- CreateAssayObject(
        counts = assay(sce_filter_manual, "soupX_rounded"))

# Add the dim reductions
so_soupX[["PCA"]] <- CreateDimReducObject(
        embeddings = reducedDim(sce_filter_manual,
                                type = "pca"), 
        key = "PC_", 
        assay = "RNA")
    
so_soupX[["UMAP"]] <- CreateDimReducObject(
        embeddings = reducedDim(sce_filter_manual,
                                type = "umap"), 
        key = "UMAP_", 
        assay = "RNA")
    
```
#### Normalise and scale RNA, soupX & decontX counts so that they can be used for plotting
```{r, message = FALSE}


DefaultAssay(object = so_soupX) <- "RNA"
    
so_soupX <- so_soupX %>% 
               NormalizeData() %>%
               FindVariableFeatures() %>% 
               ScaleData()
    
DefaultAssay(object = so_soupX) <- "soupX_decimal"
    
so_soupX <- so_soupX %>% 
               NormalizeData() %>%
               FindVariableFeatures() %>% 
               ScaleData()
    
DefaultAssay(object = so_soupX) <- "soupX_integer"
    
so_soupX <- so_soupX %>% 
               NormalizeData() %>%
               FindVariableFeatures() %>% 
               ScaleData()

DefaultAssay(object = so_soupX) <- "soupX_rounded"
    
so_soupX <- so_soupX %>% 
               NormalizeData() %>%
               FindVariableFeatures() %>% 
               ScaleData()
    


```
```{r, fig.width=12, fig.height=14}

geneName <- c("COL1A1", "COL1A2", "COL3A1", "DCN", "PRG4", "CLIC5", "FAP", "THY1", "PDPN", "POSTN",
              "PECAM1", "PTPRB", "FLT1", "VWF", "VEGFC",
              "NOTCH3", "PDGFRB", "MYO1B", 
              "MMRN1", "PROX1", "KDR", "FLT4", 
              "GPAM", "AQP7", "ADIPOQ", 
              "PTPRC", "CD247", 
              "CD69", "KIT", "CDK15",
              "MS4A1", "CD37", "BLNK", "SDC1", "IGHA1", 
              "CD14", "CD48", "CD163", "MERTK", "MRC1",
              "ASPM", "DIAPH3",
              "IRF7", "CLEC4C", "IL3RA")
# Set the identities to the seurat clusters
    Idents(so_soupX) <- so_soupX$seurat_clusters
    
    DefaultAssay(so_soupX) <- "RNA"
    p_RNA <- DotPlot(so_soupX, 
             features = geneName) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("RNA assay") + 
    coord_flip()
    
    DefaultAssay(so_soupX) <- "soupX_decimal"
    p_soupX_decimal <- DotPlot(so_soupX, 
             features = geneName) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("soupX_decimal") + 
    coord_flip()
    
    DefaultAssay(so_soupX) <- "soupX_integer"
    p_soupX_integer <- DotPlot(so_soupX, 
             features = geneName) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("soupX_integer") + 
    coord_flip()
    
    DefaultAssay(so_soupX) <- "soupX_rounded"
    p_soupX_rounded <- DotPlot(so_soupX, 
             features = geneName) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("soupX_rounded") + 
    coord_flip()

plot_grid(p_RNA, p_soupX_decimal, p_soupX_integer, p_soupX_rounded, ncol = 2)

    
```
```{r, fig.width=12, fig.height=6}
VlnPlot(so_soupX, features = c("nCount_RNA", "nCount_soupX_decimal", "nCount_soupX_integer", "nCount_soupX_rounded"), ncol = 4, 
        same.y.lims = TRUE)

```

