---
title: "Xenium visualisation"
author: "Carla Cohen"
date: "2025-07-02"
output: html_document
---

The aim of this script is to figure out the best visualisations of the findings. 

Load packages and set up
```{r}

library(Seurat)
library(tidyverse)
library(scCustomize)
library(readr)
library(pheatmap)
library(matrixStats)
library(spdep)
library(geojsonR)
library(clustree)
library(yaml)
library(cowplot)
library(RColorBrewer)

wdir <- "/project/wolf1241/xenium/"
set.seed(123)

# make a new output folder for each run, with the date & time in the directory name
date <- Sys.Date() %>% str_replace_all("-", "")
time <- format(Sys.time(), "%X") %>% str_replace_all(":", "-") %>%
    str_sub(1, 5)
directory <- paste0(wdir, date,"_", time, "_Visualisation.dir")
dir.create(directory, showWarnings = FALSE)
dir.create(paste0(directory, "/RDS_objects.dir/"))
dir.create(paste0(directory, "/Cell_numbers/"))
dir.create(paste0(directory, "/UMAPs/"))
dir.create(paste0(directory, "/Images/"))

```

Set the colours

```{r}
# using seaborn colours
broad.colours <- c("COMPhi MMP3hi fibroblasts" =  "#F9BA73",
                   "COMPhi THBS4hi fibroblasts" = "#44BED0",
                   "NEGR1hi COL15A1hi fibroblasts" = "#41A021" ,
                   "NEGR1hi VCANhi fibroblasts" = "#CD2321",
                   "NEGR1hi ITGA6hi fibroblasts" = "#C19C93",
                   "Nervous system cells" = "#F67E00",
                   "Immune cells" = "#A5DAE6",
                   "Endothelial cells"  ="#DC77C3" ,
                   "Adipocytes" = "#DADB89" ,
                   "Skeletal muscle cells" = "#9267BF",
                   "Mural cells" = "#9FDF86",
                   "Chondrocytes" = "#C7C7C7", 
                   "PRG4hi fibroblasts" = "#7F7F7F"
                   )  


seaborn.colours <- c("#3378B6", "#B1C7E9",
                     "#F67E00", "#F9BA73",
                     "#41A021", "#9FDF86", 
                     "#CD2321", "#F89795", 
                     "#9267BF", "#C4B0D6",
                     "#88564A", "#C19C93",
                     "#DC77C3", "#F2B6D2",
                     "#7F7F7F", "#C7C7C7", 
                     "#BBBD00", "#DADB89", 
                     "#44BED0", "#A5DAE6")

```

Read in the seurat object that has fine annotation for all cell subsets

```{r}
so.harmony <- readRDS(paste0(wdir, "20250723_11-47_Muscle_annotation_.dir/RDS_objects.dir/Achilles_integrated_annotated.rds"))


```

## Predicted broad and fine annotations

Predicted broad annotation 

```{r, fig.width=9, fig.height=5}

DimPlot(so.harmony, reduction = "harmony.umap", group.by = "predicted.id_integrated_broad")

ggsave((paste0(directory, "/UMAPs/Xenium_predicted_broad_annotation.png")), 
       width = 8, height = 5)
```

```{r}
df <- so.harmony[[]] %>% select("predicted.id_integrated_broad", "fine_annotation")

# what are the cell numbers for broad annotations ?
df.broad <- df %>% 
  group_by(predicted.id_integrated_broad) %>%  
  summarise(cell_number=n()) %>% 
  mutate(percent_cells=(cell_number/sum(cell_number))*100) %>% 
  arrange(desc(cell_number))

df.broad$predicted.id_integrated_broad <- factor(df.broad$predicted.id_integrated_broad, 
                                        levels = df.broad$predicted.id_integrated_broad)

ggplot(df.broad, aes(y=cell_number, x=predicted.id_integrated_broad))+
    geom_bar(stat = "identity")+
    geom_text(aes(label=cell_number),vjust=-1)+
      theme_classic()+
  ylim(c(0, 5500))+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  theme(axis.title.x = element_blank())+
  ggtitle("Xenium predicted broad")
  
ggsave((paste0(directory, "/Cell_numbers/Xenium_predicted_broad.png")), 
       width = 8, height = 5)

```
Predicted fine annotation

```{r, fig.width=9, fig.height=5}

DimPlot(so.harmony, reduction = "harmony.umap", group.by = "fine_annotation")

ggsave((paste0(directory, "/UMAPs/Xenium_predicted_fine_annotation.png")), 
       width = 8, height = 5)
```

```{r, fig.width=10, fig.height=4}
# what are the cell numbers for fine annotations ?
df.fine <- df %>% 
  group_by(fine_annotation) %>%  
  summarise(cell_number=n()) %>% 
  mutate(percent_cells=(cell_number/sum(cell_number))*100) %>% 
  arrange(desc(cell_number))

df.fine$fine_annotation <- factor(df.fine$fine_annotation, 
                                        levels = df.fine$fine_annotation)

ggplot(df.fine, aes(y=cell_number, x=fine_annotation))+
    geom_bar(stat = "identity")+
    geom_text(aes(label=cell_number),vjust=-1)+
      theme_classic()+
  ylim(c(0, 3500))+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  theme(axis.title.x = element_blank())+
  ggtitle("Xenium predicted fine")

ggsave((paste0(directory, "/Cell_numbers/Xenium_predicted_fine.png")), 
       width = 8, height = 5)

```

### Make an annotation with some of the identities merged in order to focus on the fibroblasts

Make a column "cell_annotation" that has the fine mapping for fibroblasts but not necessarily for other cell types

Chondrocytes --> COMPhi MMP3hi fibroblasts
NK cells --> T cells

Monocytes/CLEC10Ahi DCs --> Monocytes/DCs
METRKhiLYVE1hi macrophages --> Macrophages
Satellite cells --> Skeletal muscle cells  


```{r, fig.width=9, fig.height=5}
Idents(so.harmony) <- so.harmony$fine_annotation

so.harmony <- RenameIdents(so.harmony, 
             `Chondrocytes` = "COMPhi MMP3hi fibroblasts", 
             `NK cells` = "T cells",
             `Monocytes` = "Monocytes/DCs", 
             `CLEC10Ahi DCs` = "Monocytes/DCs", 
             `MERTKhi LYVE1hi macrophages` = "Macrophages", 
             `Satellite cells` = "Skeletal muscle cells")
table(Idents(so.harmony))

so.harmony$cell_annotation <- Idents(so.harmony)

DimPlot(so.harmony, reduction = "harmony.umap", group.by = "cell_annotation")

ggsave((paste0(directory, "/UMAPs/Xenium_medium_annotation.png")), 
       width = 8, height = 5)
```

Cell numbers

```{r, fig.width=10, fig.height=4}
df <- so.harmony[[]] %>% 
  select("cell_annotation") %>% 
  group_by(cell_annotation) %>%  
  summarise(cell_number=n()) %>% 
  mutate(percent_cells=(cell_number/sum(cell_number))*100) %>% 
  arrange(desc(cell_number))

df$cell_annotation <- factor(df$cell_annotation, 
                                        levels = df$cell_annotation)

ggplot(df, aes(y=cell_number, x=cell_annotation))+
    geom_bar(stat = "identity")+
    geom_text(aes(label=cell_number),vjust=-1)+
    theme_classic()+
  ylim(c(0, 3500))+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  theme(axis.title.x = element_blank())+
ggtitle("Xenium predicted medium")

ggsave((paste0(directory, "/Cell_numbers/Xenium_medium_annotation.png")), 
       width = 8, height = 5)

```

Make a column "broad_annotation" that has the fine mapping for fibroblasts but very broad annotation for other cell types

T cells/B cells/Macrophages/Monocytes/DCs/Granulocytes --> Immune cells
LEC & VEC --> Endothelial cells


```{r, fig.width=9, fig.height=5}
Idents(so.harmony) <- so.harmony$cell_annotation

so.harmony <- RenameIdents(so.harmony, 
             `T cells` = "Immune cells", 
             `B cells` = "Immune cells",
             `Monocytes/DCs` = "Immune cells", 
             `Macrophages` = "Immune cells", 
             `Granulocytes` = "Immune cells",
             `Lymphatic endothelial cells` = "Endothelial cells", 
             `Vascular endothelial cells` = "Endothelial cells")
table(Idents(so.harmony))

so.harmony$broad_annotation <- Idents(so.harmony)

DimPlot(so.harmony, reduction = "harmony.umap", group.by = "broad_annotation")

ggsave((paste0(directory, "/UMAPs/Xenium_broad_annotation.png")), 
       width = 8, height = 5)
```


Cell numbers for broad annotation

```{r}
df.broad <- so.harmony[[]] %>% 
  select("broad_annotation")%>% 
  group_by(broad_annotation) %>%  
  summarise(cell_number=n()) %>% 
  mutate(percent_cells=(cell_number/sum(cell_number))*100) %>% 
  arrange(desc(cell_number))

df.broad$broad_annotation <- factor(df.broad$broad_annotation, 
                                        levels = df.broad$broad_annotation)
df.broad

ggplot(df.broad, aes(y=cell_number, x=broad_annotation, fill = broad_annotation))+
    geom_bar(stat = "identity")+
    geom_text(aes(label=cell_number),vjust=-1)+
    theme_classic()+
  ylim(c(0, 3500))+
  scale_fill_manual(values = broad.colours)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  theme(axis.title.x = element_blank())+
  theme(legend.position = "none")

ggsave((paste0(directory, "/Cell_numbers/Xenium_broad_annotation.png")), 
       width = 8, height = 5)
```


Cell numbers for broad annotation split by microanatomy
```{r}
ma.cols <-  c(Enthesis = "#d37504", MB = "#959295", MTJ = "#359c72", Muscle = "#34688d")

#d37504"


df <- so.harmony[[]] %>% 
  select("broad_annotation", "microanatomical_site")%>% 
  group_by(broad_annotation, microanatomical_site) %>%  
  summarise(cell_number=n()) %>% 
  mutate(percent_cells=(cell_number/sum(cell_number))*100)


df$broad_annotation <- factor(df$broad_annotation, 
                                        levels = df.broad$broad_annotation)

ggplot(df, aes(y=cell_number, x=broad_annotation, fill = microanatomical_site))+
    geom_bar(stat = "identity")+
    theme_classic()+
   scale_fill_manual(values = ma.cols)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  theme(axis.title.x = element_blank())

ggsave((paste0(directory, "/Cell_numbers/Xenium_broad_annotation_microanatomy.png")), 
       width = 8, height = 5)

ggplot(df, aes(y=percent_cells, x=broad_annotation, fill = microanatomical_site))+
    geom_bar(stat = "identity")+
    theme_classic()+
   scale_fill_manual(values = ma.cols)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  theme(axis.title.x = element_blank())

ggsave((paste0(directory, "/Cell_numbers/Xenium_broad_annotation_microanatomy_percent.png")), 
       width = 8, height = 5)
```

Plot the broad annotation on the tissue

```{r}
roi_names <- c("ROI1", "ROI1.2", "ROI1.3", "ROI1.4")
ma_names <- c("Enthesis", "MB", "MTJ", "Muscle")

for (i in 1:length(roi_names)){
  ImageDimPlot(so.harmony, fov=roi_names[i], boundaries="segmentation", border.color = "black",group.by = "broad_annotation", 
             cols = broad.colours )
  ggsave(paste0(directory, "/Images/Image_", ma_names[i], "_Predicted_IDs.png"), 
       width = 10, height = 8)
}

```


### Create the same broad annotation in the single nuc data


```{r, fig.width=9, fig.height=5}
so.achilles <- readRDS(paste0(wdir, "data/Achilles_fine_annotation.rds"))

# create the same very broad groups as in the Xenium data
Idents(so.achilles) <- so.achilles$fine_annotation

so.achilles <- RenameIdents(so.achilles, 
                           `NK cells` = "Immune cells",
             `Monocytes` = "Immune cells", 
             `CLEC10Ahi DCs` = "Immune cells", 
             `CLEC9Ahi DCs` = "Immune cells", 
             `MERTKhi LYVE1hi macrophages` = "Immune cells", 
             `Satellite cells` = "Skeletal muscle cells",
             `T cells` = "Immune cells", 
             `B cells` = "Immune cells",
             `Granulocytes` = "Immune cells",
             `Lymphatic endothelial cells` = "Endothelial cells", 
             `vSMC` = "Mural cells", 
             `Slow-twitch skeletal muscle cells` = "Skeletal muscle cells", 
             `Fast-twitch skeletal muscle cells` = "Skeletal muscle cells", 
             `Venular VEC` = "Endothelial cells", 
             `MERKhi LYVE1lo macrophages` = "Immune cells", 
             `MERTKlo PTPRGhi macrophages` = "Immune cells", 
             `Arteriolar VEC` = "Endothelial cells", 
             `Pericytes` = "Mural cells", 
             `Transitional skeletal muscle cells` = "Skeletal muscle cells", 
             `Plasma cells` = "Immune cells"
             )

so.achilles$xenium_annotation <- Idents(so.achilles)
DimPlot(so.achilles, reduction = "umap.scvi", group.by = "xenium_annotation", cols = broad.colours)

ggsave((paste0(directory, "/UMAPs/Single_nuc_Xenium_broad_annotation.png")), 
       width = 8, height = 5)

```


Plot the number of cells 

```{r}

names(ma.cols) = c("Enth", "MB", "MTJ", "muscle")
df <- so.achilles[[]] %>% 
  select("xenium_annotation", "microanatomical_site")%>% 
  group_by(xenium_annotation, microanatomical_site) %>%  
  summarise(cell_number=n()) %>% 
  mutate(percent_cells=(cell_number/sum(cell_number))*100)


my_levels = c(levels(df.broad$broad_annotation), "Chondrocytes", "PRG4hi fibroblasts")
df$xenium_annotation <- factor(df$xenium_annotation, 
                                        levels = my_levels)

ggplot(df, aes(y=cell_number, x=xenium_annotation, fill = xenium_annotation))+
    geom_bar(stat = "identity")+
    theme_classic()+
  scale_fill_manual(values = broad.colours)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  theme(axis.title.x = element_blank())

ggsave((paste0(directory, "/Cell_numbers/Single_nuc_Xenium_broad_annotation.png")), 
       width = 8, height = 5)

ggplot(df, aes(y=cell_number, x=xenium_annotation, fill = microanatomical_site))+
    geom_bar(stat = "identity")+
    theme_classic()+
  scale_fill_manual(values = ma.cols)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  theme(axis.title.x = element_blank())

ggsave((paste0(directory, "/Cell_numbers/Single_nuc_Xenium_broad_annotation_microanatomy.png")), 
       width = 8, height = 5)

my_levels = c("COMPhi MMP3hi fibroblasts", 
              "COMPhi THBS4hi fibroblasts", 
              "NEGR1hi VCANhi fibroblasts", 
              "NEGR1hi COL15A1hi fibroblasts", 
              "NEGR1hi ITGA6hi fibroblasts", 
              "Chondrocytes", 
              "PRG4hi fibroblasts",
              "Nervous system cells", 
              "Skeletal muscle cells", 
              "Mural cells", 
              "Endothelial cells", 
              "Immune cells", 
              "Adipocytes")
df$xenium_annotation <- factor(df$xenium_annotation, 
                                        levels = my_levels)
ggplot(df, aes(y=percent_cells, x=xenium_annotation, fill = microanatomical_site))+
    geom_bar(stat = "identity")+
    theme_classic()+
  scale_fill_manual(values = ma.cols)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  theme(axis.title.x = element_blank())

ggsave((paste0(directory, "/Cell_numbers/Single_nuc_Xenium_broad_annotation_microanatomy_percent.png")), 
       width = 8, height = 5)
```
### Save identities for Xenium Explorer

```{r}
df <- data.frame(cell_id = colnames(so.harmony),
                 group = so.harmony$broad_annotation)
write.table(df, 
          paste0(directory, "/Broad_annotation.csv"),
          quote = FALSE, 
          sep = ",",
          col.names = TRUE,
          row.names = FALSE)

df <- data.frame(cell_id = colnames(so.harmony),
                 group = so.harmony$fine_annotation)
write.table(df, 
          paste0(directory, "/Fine_annotation.csv"),
          quote = FALSE, 
          sep = ",",
          col.names = TRUE,
          row.names = FALSE)

```

### Save objects

```{r}
saveRDS(so.harmony, paste0(directory, "/RDS_objects.dir/Achilles_integrated_annotated.rds"))
saveRDS(so.achilles, paste0(directory, "/RDS_objects.dir/Achilles_snRNAseq_update_annotation.rds"))
```



```{r}
sessionInfo()
```
