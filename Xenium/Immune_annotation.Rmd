---
title: "Immune cell annotation"
author: "Carla Cohen"
date: "2025-07-01"
output: html_document
---

# Immune annotation

The aim of this script is to annotate the clusters after integration, which can be informed by the cell label transfer. 

Might give greater clarify to the annotations. 
Do we see any cell types that are not present in the single nuc data?


Load packages and set up
```{r}

library(Seurat)
library(tidyverse)
library(scCustomize)
library(readr)
library(pheatmap)
library(matrixStats)
library(spdep)
library(geojsonR)
library(clustree)
library(yaml)
library(cowplot)
library(RColorBrewer)

wdir <- "/project/wolf1241/xenium/"
set.seed(123)

# make a new output folder for each run, with the date & time in the directory name
date <- Sys.Date() %>% str_replace_all("-", "")
time <- format(Sys.time(), "%X") %>% str_replace_all(":", "-") %>%
    str_sub(1, 5)
directory <- paste0(wdir, date,"_", time, "_Immune_annotation_.dir")
dir.create(directory, showWarnings = FALSE)
dir.create(paste0(directory, "/RDS_objects.dir/"))
dir.create(paste0(directory, "/Figures/"))
dir.create(paste0(directory, "/Immune"))
dir.create(paste0(directory, "/Immune/Heatmaps"))
dir.create(paste0(directory, "/Immune/Dotplots"))


```

Set the colours

```{r}
achilles.colours <- c(# Broad groups
    "Fibroblasts" = "#B2182B", 
    "Skeletal muscle cells" = "#88419D", 
    "Satellite cells" = "#8C96C6",
    "Mural cells" = "#7FBC41",
    # Immune
    "Macrophages" = "#35978F", 
    "B cells" = "#543005", 
    "T cells" = "#F6E8C3", 
    "Plasma cells" = "#01EBD6", 
    "Granulocytes" = "#80CDC1", 
    # Stromal
    "Vascular endothelial cells" = "#F1B6DA",
    "Lymphatic endothelial cells" = "#C51B7D",
    "Adipocytes" = "#E6F598", 
    "Mural" = "#B8E186", 
    "Nervous system cells" = "#276419", 
    "Ambient" = "grey")

achilles.2fb.colours <- c(achilles.colours, "COMPhi fibroblasts" = "#F4A582", 
                          "NEGR1hi fibroblasts" = "#B2182B")

# Fibroblast colours

fibroblast.colours <- brewer.pal(10, "RdGy")
names(fibroblast.colours) <- c("PRG4hi fibroblasts",
                               "NEGR1hi VCANhi fibroblasts", 
                               "Chondrocytes",
                               "COMPhi THBS4hi fibroblasts",
                               "NEGR1hi ITGA6hi fibroblasts",
                               "unused",
                               "unused",
                               "COMPhi MMP3hi fibroblasts",
                               "NEGR1hi COL15A1hi fibroblasts",
                               "unused")

# fibroblast colours short (matrisome)
fibroblast.colours.short <- brewer.pal(10, "RdGy")
names(fibroblast.colours.short) <- c("PRG4.fb",
                               "NEGR1.VCAN.fb", 
                               "Chondrocytes",
                               "COMP.THBS4.fb",
                               "NEGR1.ITGA6.fb",
                               "unused",
                               "unused",
                               "COMP.MMP3.fb",
                               "NEGR1.COL15A1.fb",
                               "unused")

fibroblast.colours.short <- fibroblast.colours.short[names(fibroblast.colours.short) !="unused"]

# Immune colours
immune.colours <- c(brewer.pal(11, "BrBG"), "#01EBD6")

names(immune.colours) <- c("B cells", 
                           "Monocytes",
                           "CLEC9Ahi DCs", 
                           "MERKhi LYVE1lo macrophages", 
                           "T cells", 
                           "Slow twitch skeletal muscle cells",
                           "CLEC10Ahi DCs",
                           "Granulocytes",
                           "MERTKhi LYVE1hi macrophages",
                           "NK cells", 
                           "MERTKlo PTPRGhi macrophages",
                           "Plasma cells"
)

# Stromal colours
stromal.colours <- c(brewer.pal(10, "PiYG"), brewer.pal(10, "Spectral")[6]) # add a yellow for adipocytes
names(stromal.colours) <- c("Arteriolar VEC", #1
                            "Lymphatic endothelial cells", #2
                            "Venular VEC", #3
                            "unused 3", #4
                            "unused 2", #5
                            "unused 1", #6
                            "vSMC", #7
                            "unused", #8
                            "Pericytes", #9
                            "Nervous system cells", #10
                            "Adipocytes")  #yellow

# Muscle colours
muscle.colours <- brewer.pal(5, "BuPu")
names(muscle.colours) <- c("unused", 
                           "Transitional skeletal muscle cells", 
                           "Satellite cells", 
                           "Fast-twitch skeletal muscle cells", 
                           "Slow-twitch skeletal muscle cells")

# fine annotation colours
achilles.fine.colours <- c(fibroblast.colours, muscle.colours, stromal.colours, immune.colours)

```


Read in the seurat object that has fine annotation for fibroblasts. 

```{r}
so.harmony <- readRDS(paste0(wdir, "20250702_12-14_Fibroblast_annotation.dir/RDS_objects.dir/Achilles_integrated_annotated.rds"))


```

## Subset and recluster immune cells


```{r}
Idents(so.harmony) <- so.harmony$predicted.id_integrated_broad
so.im <- subset(so.harmony, idents = c("T cells", "Macrophages", "Granulocytes"))
```


Tidy up the metadata
```{r}

# remove existing clusters
resolutionList <- grep("snn_res", colnames(so.im[[]]), value = TRUE)

for (resolution in resolutionList){
      so.im[[resolution]] <- NULL
}

so.im[["umap"]] <- NULL

so.im
```

```{r}
DefaultAssay(so.im) <- "XENIUM"

so.im <- SCTransform(so.im, assay = "XENIUM", clip.range = c(-10, 10))
so.im <- RunPCA(so.im)
so.im <- RunUMAP(so.im, dims = 1:20)

```

# Map the identities just using the fibroblast annotations

```{r, fig.width=8, fig.height=6}
so.achilles <- readRDS(paste0(wdir, "data/Achilles_fine_annotation.rds"))
Idents(so.achilles) <- so.achilles$broad_annotation
unique(so.achilles$broad_annotation)
so.immune <- subset(so.achilles, idents = c("T cells", "Macrophages", "Granulocytes", "B cells"))
# remove skeletal muscle cells
Idents(so.immune) <- so.immune$fine_annotation
so.immune <- subset(so.immune, idents = "Slow-twitch skeletal muscle cells", invert = TRUE)
ref <- so.immune
ref <- SCTransform(ref, residual.features =rownames(so.im))
ref <- RunPCA(ref)
ref <- RunUMAP(ref, dims=1:20)

Idents(ref) <- ref$fine_annotation

DimPlot(ref, repel=T, cols = immune.colours)

ggsave(paste0(directory, "/Immune/Achilles_Immune_UMAP_red_features.png"), 
       width = 10, height = 8)
```

```{r, fig.width=10, fig.height=8}
ps <- AggregateExpression(ref, features = rownames(so.im), normalization.method = "LogNormalize", assays="RNA", return.seurat = T)
ps <- ScaleData(ps, features=rownames(ps))
pheatmap(LayerData(ps, layer="scale.data"), show_rownames = F)
```


Transfer labels from the ref to the spatial data

```{r}
anchors <- FindTransferAnchors(reference = ref, 
                               query = so.im, 
                               normalization.method = "SCT")

so.im <- TransferData(anchorset = anchors, 
                       refdata = ref$fine_annotation, 
                       prediction.assay = TRUE,
                       weight.reduction = so.im[["pca"]], 
                       query = so.im, 
                       dims=1:20)

```

```{r, fig.width=10, fig.height=8}

immune.colours.bright <- brewer.pal(7, "Dark2")

names(immune.colours.bright) <- c("B cells", 
                                  "CLEC10Ahi DCs", 
                                  "Granulocytes", 
                                  "MERTKhi LYVE1hi macrophages", 
                                  "Monocytes", 
                                  "NK cells", 
                                  "T cells")

p1 <- DimPlot(so.im, group.by= "predicted.id", cols = immune.colours.bright, reduction = "umap")
ggsave(paste0(directory, "/Immune/UMAP_Predicted_IDs.png"), p1,
       width = 10, height = 8)
p2 <- FeaturePlot(so.im, features = "predicted.id.score", reduction = "umap")+scale_color_viridis()
ggsave(paste0(directory, "/Immune/UMAP_prediction_scores.png"), p2,
       width = 10, height = 8)
p3 <- VlnPlot(so.im, features = "predicted.id.score", group.by = "predicted.id", 
        cols = immune.colours.bright, pt.size = 0)+
  theme(legend.position="none")+
  theme(axis.text.x=element_blank())
ggsave(paste0(directory, "/Immune/Vln_prediction_scores.png"), p3,
       width = 10, height = 6)
pA <- plot_grid(p2, p3)
plot_grid(p1, pA, ncol = 1)
# save these results as new columns in the metadata
so.im$predicted.id_immune_fine <- so.im$predicted.id
so.im$predicted.id.score_immune_fine <- so.im$predicted.id.score

# save the results as csv (to use in Xenium Explorer)
df <- data.frame(cell_id = colnames(so.im),
                 group = so.im$predicted.id)
write.table(df, 
          paste0(directory, "/Immune/Predicted.id.csv"),
          quote = FALSE, 
          sep = ",",
          col.names = TRUE,
          row.names = FALSE)

```

How many cells per annotation?

```{r}
table(so.im$predicted.id_immune_fine)
```
Compare the annotations 
```{r, fig.width=16, fig.height=5}
p1 <- DimPlot(so.im, reduction = "umap", group.by = "predicted.id_integrated_fine", cols = immune.colours.bright)
p2 <- DimPlot(so.im, group.by= "predicted.id_immune_fine", cols = immune.colours.bright, reduction = "umap")
plot_grid(p1, p2, ncol = 2)

```


Only minor changes but looks good. 


```{r, fig.width=15, fig.height=5}

immune_markers <- list("T cell" = c("CD247", "SKAP1", "THEMIS", "PTPRC", "IL7R"), 
                       #"MERTK+LYVE1-mac" = c("CTSL", "CTSB", "TPRG1", "HMOX1","ELL2"),
                       #"MERTK-PTPRG+mac" = c("PTPRG", "MIR99AHG", "PARD3",
                      #                       "KAZN",  "IFI44L"), 
                       "MERTK+LYVE1+mac" = c("CD163", "F13A1","STAB1",
                                             "MERTK", "LYVE1"), 
                       "CLEC10A DC" = c("CLEC10A", "CD1C", "FCER1A", "IL1R2"),
                       "NK cell" = c("NCAM1", "GNLY", "KLRD1", "CCL5", "MCTP2"),
                       "Monocytes" = c("FCN1", "VCAN", "FCGR3A", "LST1", "LILRB2"),
                       "Granulocyte" = c( "KIT", "CPA3", "IL18R1","CDK15", "MS4A2"),
                       #"Plasma" = c("IGHG1", "MZB1", "XBP1", "PRDM1", "JCHAIN"),
                       #"CLEC9Ahi DC" = c("CLEC9A", "CADM1", "IDO1", "CLNK", "ZNF366"),
                       "B cells" = c("MS4A1", "CD37", "BLNK", "FCRL1", "IGHM")
)
Idents(so.im) <- so.im$predicted.id_immune_fine
DotPlot(so.im, features = immune_markers)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  geom_point(aes(size=pct.exp), shape = 21, colour="black", stroke=0.5) +
  scale_colour_gradient2(low = "#f7f3f2", mid = "#f2390a", high = "#6e1e0a", midpoint = 1)
```


### Plot the annotations on the tissue

Predicted IDs from reference mapping

```{r, fig.width=10, fig.height=8}
roi_names <- c("ROI1", "ROI1.2", "ROI1.3", "ROI1.4")
ma_names <- c("Enthesis", "MB", "MTJ", "Muscle")

dir.create(paste0(directory, "/Immune/mapping_IDs/"))

for (i in 1:length(roi_names)){
  ImageDimPlot(so.im, fov=roi_names[i], boundaries="segmentation", border.color = "black",
               group.by = "predicted.id_immune_fine", 
             cols = immune.colours.bright )+
    ggtitle(paste0(ma_names[i], " mapping IDs"))
  ggsave(paste0(directory, "/Immune/mapping_IDs/Image_", ma_names[i], "_ROI_Predicted_FB_IDs.png"), 
       width = 10, height = 8)
}

for (i in 1:length(roi_names)){
  ImageDimPlot(so.im, fov=ma_names[i], 
               group.by = "predicted.id_immune_fine", 
             cols = immune.colours.bright )+
    ggtitle(paste0(ma_names[i], " mapping IDs"))
  ggsave(paste0(directory, "/Immune/mapping_IDs/Image_", ma_names[i], "_full_Predicted_FB_IDs.png"), 
       width = 10, height = 8)
}

```

### Put the annotations back into the full object

Need to determine whether subsetting the immune cells gave different IDs from the fine mapping using the whole object.

```{r}
df <- so.harmony[[]]
df.im <- so.im[[]] %>% select(cell_id, predicted.id_immune_fine)
df <- left_join(df, df.im)
df %>% select(predicted.id_immune_fine, predicted.id_broad, fine_annotation)
# make a new column of fine annotation by filling in the values from the other annotations
df <- df %>% mutate(fine_annotation =
                  case_when(is.na(predicted.id_immune_fine) ~ fine_annotation)) 

df <- df %>% mutate(fine_annotation = coalesce(fine_annotation, predicted.id_immune_fine))

# add this column to the object
so.harmony$fine_annotation <- df$fine_annotation


# compare the annotations 
df.im <- df %>% filter(predicted.id_integrated_broad == "T cells" |
                         predicted.id_integrated_broad==  "Macrophages" | 
                         predicted.id_integrated_broad== "Granulocytes" ) %>% 
  select(predicted.id_integrated_broad, predicted.id_integrated_fine, predicted.id_immune_fine, fine_annotation) #%>%
  #filter(str_detect(predicted.id_integrated_fine, "fibroblasts") | predicted.id_integrated_fine == "Chondrocytes")
table(df.im$predicted.id_immune_fine, df.im$predicted.id_integrated_fine)
```



```{r}
saveRDS(so.im, paste0(directory, "/RDS_objects.dir/Achilles_immune_subset.rds"))

saveRDS(so.harmony, paste0(directory, "/RDS_objects.dir/Achilles_integrated_annotated.rds"))
```


```{r}
sessionInfo()
```
