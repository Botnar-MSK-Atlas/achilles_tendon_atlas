---
title: "Subset and recluster fibroblasts"
author: "Carla Cohen"
date: "`r Sys.Date()`"
output: html_document
---

A script to subset and re-cluster the fibroblast subsets in the Achilles data  
This script is for harmony integration with louvain clustering and no muscle

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r}
library(tidyverse)
library(Seurat)
library(cowplot)
library(yaml)
library(clustree)
library(viridis)
library(EnhancedVolcano)
library(ggVennDiagram)
library(harmony)
library(scales)
reticulate::use_condaenv(condaenv = "reticulate-env", conda = "/project/ancestryhca/ccohen/mamba_installation/conda/condabin/conda", required = F)
reticulate::import(module = 'leidenalg')

# make a new output folder for each run, with the date & time in the directory name
date <- Sys.Date() %>% str_replace_all("-", "")
time <- format(Sys.time(), "%X") %>% str_replace_all(":", "-") %>%
    str_sub(1, 5)
directory <- paste0(date,"_", time, "_Subset_fibroblasts.dir")
dir.create(directory, showWarnings = FALSE)
dir.create(paste0(directory, "/Subset_figures/"))

ini <- read_yaml("subcluster.yml")

```

Print the parameters
```{r}
ini
```
Set up some parameters
```{r}
if (ini$integration_method == "harmony"){
    identities <- paste0("cell_annotation_harmony_", ini$subset_resolution)
    umap_name <- "harmony.umap"
} else if (ini$integration_method == "scVI"){
    identities <- paste0("cell_annotation_scVI_", ini$subset_resolution)
    umap_name <- "umap.scvi"
}
print(identities)
print(umap_name)
```


Read in the Seurat object  
Annotated at resolution 0.2


```{r}
so <- readRDS(ini$seurat_object)
colnames(so[[]])
# add the idents as a column of metadata

Idents(so) <- identities
```

Plot the UMAP  

```{r, fig.width=10, fig.height=7}
p <- DimPlot(so, label = TRUE, repel = TRUE, shuffle = TRUE,reduction = umap_name)
    #scale_colour_viridis_d()
p
```

Subset the fibroblasts

```{r}
so.fibroblasts <- subset(so, idents = ini$subset_clusters)
so.fibroblasts
```
Tidy up the metadata
```{r}
colnames(so[[]])
# remove existing clusters
resolutionList <- grep("snn_res", colnames(so.fibroblasts@meta.data), value = TRUE)

for (resolution in resolutionList){
      so.fibroblasts[[resolution]] <- NULL
      }

```

Re-cluster the fibroblasts
First we need to re-normalise etc

```{r}
DefaultAssay(so.fibroblasts) <- ini$normalisation_assay

so.fibroblasts <- so.fibroblasts %>% 
           NormalizeData() %>%
           FindVariableFeatures(nfeatures = ini$nfeatures) %>% 
           ScaleData() %>%
           RunPCA()

so.harmony <- RunHarmony(so.fibroblasts, 
                         group.by.vars = "patient.seqbatch", 
                         plot_convergence = TRUE, 
                         dims.use = 1:ini$n_dims, 
                         kmeans_init_nstart=20, kmeans_init_iter_max=100)

```


```{r}
so.fibroblasts <- so.fibroblasts %>% 
    FindNeighbors(dims = 1:ini$n_dims, reduction = "harmony") %>%
    RunUMAP(dims = 1:ini$n_dims) 

so.fibroblasts
```
Plot with the original labels.  

```{r}

DimPlot(so.fibroblasts, label = TRUE, repel = TRUE, shuffle = TRUE, reduction = "umap")
ggsave(paste0(directory, "/Subset_figures/UMAP_original_clusters.png"), width = 8, height = 6, bg = "white")
```

```{r}
ElbowPlot(so.fibroblasts, ndims = 50)
ggsave(paste0(directory, "/Subset_figures/Elbow_plot.png"), width = 8, height = 6, bg = "white")
```



Find Clusters at resolutions from 0.05-0.3 
```{r}
if (ini$cluster_method == "louvain"){
    so.fibroblasts <- FindClusters(so.fibroblasts, resolution = seq(0.05, 0.3, 0.05))
} else if (ini$cluster_method == "leiden"){
    so.fibroblasts <- so.fibroblasts %>% FindClusters(resolution = seq(0.05, 0.3, 0.05), 
                                          algorithm = "leiden",
                                          method = "igraph") # needed if running leiden
}



```




Plot the clustree to determine the most appropriate resolution to use
NB doing the re-integration makes essentially no difference. 

```{r, fig.height= 10, fig.width=10}

clustree(so.fibroblasts, node_colour = "sc3_stability") + 
        ggtitle("Fibroblasts Clustree")
ggsave(paste0(directory, "/Subset_figures/Clustree_plot.png"), 
       width = 10, height = 10, bg = "white")
```

Plot UMAP for each clustering resolution

```{r, fig.width=10, fig.height=12}

resolutionList <- grep("soupX_snn_res", colnames(so.fibroblasts@meta.data), value = TRUE)

plot_list <- list()

for (resolution in resolutionList){
      plot_list [[resolution]] <- DimPlot(object = so.fibroblasts, label = TRUE, reduction = "umap", 
                                          group.by = resolution, shuffle = TRUE)
      }

title <- ggdraw() + draw_label("UMAPs of clustering resolutions 0.05-0.3", fontface='bold', size = 24)
p <- plot_grid(plotlist = plot_list, ncol = 2) 
p <- plot_grid(title, p, ncol=1, rel_heights=c(0.05, 1))

ggsave(paste0(directory, "/Subset_figures/UMAP_compare_resolutions.png"), 
       width = 10, height = 12, bg = "white")

p

```


Select resolution 

```{r} 
resolution <- ini$display_resolution
so.fibroblasts[["seurat_clusters"]] <- so.fibroblasts[[paste0("soupX_snn_res.", resolution)]]
Idents(so.fibroblasts) <- so.fibroblasts$seurat_clusters
levels(Idents(so.fibroblasts))
```


UMAP split by microanatomy

```{r, fig.height=8, fig.width=8}
DimPlot(object = so.fibroblasts, label = TRUE, reduction = "umap", shuffle = TRUE, 
             split.by = "microanatomical_site", ncol = 2)+
    theme(panel.background = element_rect(colour = "black", linewidth = 1))+
    ggtitle(paste0("Fibroblast UMAP split my microanatomy at resolution ", resolution))
ggsave(paste0(directory, "/Subset_figures/UMAP_microanatomy.png"), 
       width = 10, height = 10, bg = "white")

```

UMAP split by orig.ident

```{r, fig.height=16, fig.width=8}
DimPlot(object = so.fibroblasts, label = TRUE, reduction = "umap", shuffle = TRUE, 
             split.by = "orig.ident", ncol = 3)+
    theme(panel.background = element_rect(colour = "black", linewidth = 1))+
    ggtitle(paste0("Fibroblast UMAP split by orig.ident at resolution ", resolution))
ggsave(paste0(directory, "/Subset_figures/UMAP_orig.ident.png"), 
       width = 8, height = 16, bg = "white")

```

UMAP split by patient

```{r, fig.height=8, fig.width=10}
DimPlot(object = so.fibroblasts, reduction = "umap", shuffle = TRUE, 
             split.by = "patient", ncol = 3, label = TRUE)+
    theme(panel.background = element_rect(colour = "black", linewidth = 1))+
    ggtitle(paste0("Fibroblast UMAP split by patient at resolution ", resolution))
ggsave(paste0(directory, "/Subset_figures/UMAP_patient.png"), 
       width = 10, height = 10, bg = "white")
```

UMAP split by patient - each cluster separately

```{r, fig.height=6, fig.width=8}
# set the colours
colours <- hue_pal()(length(levels(Idents(so.fibroblasts))))
names(colours) <- levels(Idents(so.fibroblasts))
colours

for (cluster_id in levels(Idents(so.fibroblasts))){
    print(cluster_id)
    so.subset <- subset(so.fibroblasts, idents = cluster_id)
    DimPlot(so.subset, label = TRUE, reduction = "umap", shuffle = TRUE, 
             split.by = "patient", ncol = 3, cols = colours)+
    ggtitle(paste0("Fibroblast UMAP cluster ", cluster_id, " per patient res ", resolution))
    ggsave(paste0(directory, "/Subset_figures/UMAP_cluster_", cluster_id, "_by_microanatomy_", resolution, ".png"), 
       width = 8, height = 6, bg = "white")
}


```

Update the naming of earlier clustering with louvain or leiden

```{r}
# it is not possible to directly change metadata column names
# create a df with new column names
metadata <- so.fibroblasts[[]]
names <- colnames(so.fibroblasts[[]])
if (ini$cluster_method == "louvain"){
    names <- str_replace(names, "^soupX", "louvain_soupX")
    colnames(metadata) <- names
    metadata <- metadata %>% select(starts_with("louvain"))
} else if (ini$cluster_method == "leiden"){
    names <- str_replace(names, "^soupX", "leiden_soupX")
    colnames(metadata) <- names
    metadata <- metadata %>% select(starts_with("leiden"))
}

# remove old columns from metadata

resolutionList <- grep("_snn_res", colnames(so.fibroblasts@meta.data), value = TRUE)

for (resolution in resolutionList){
      so.fibroblasts[[resolution]] <- NULL
      }

# add the newly labelled columns

so.fibroblasts <- AddMetaData(so.fibroblasts, metadata)

colnames(so.fibroblasts[[]])


```



### Visualise QC metrics 

```{r, message = FALSE, fig.width=10, fig.height=15}
p1 <- VlnPlot(so.fibroblasts, features = "sum", assay = "RNA", pt.size = 0)+
    scale_y_log10() +
    scale_fill_viridis_d()+
    theme(legend.position="none")+
    theme_cowplot()+
    ggtitle("nCounts")

p2 <- VlnPlot(so.fibroblasts, features = "detected", assay = "RNA", pt.size = 0)+
    scale_y_log10() +
    scale_fill_viridis_d()+
    theme(legend.position="none")+
    theme_cowplot()+
    ggtitle("nFeatures")

p3 <- VlnPlot(so.fibroblasts, features = "subsets_mito_percent", assay = "RNA", pt.size = 0)+
    scale_fill_viridis_d()+
    theme(legend.position="none")+
    theme_cowplot()+
    ggtitle("Percent mitochondrial reads")

p4 <- VlnPlot(so.fibroblasts, features = "decontX_contamination", assay = "RNA", pt.size = 0)+
    scale_fill_viridis_d()+
    theme(legend.position="none")+
    theme_cowplot()+
    ggtitle("decontX score")

p <- plot_grid(p1, p2, p3, p4, ncol = 1)
ggsave(paste0(directory, "/Subset_figures/QC_metrics_across_clusters.png"), 
       p, device = ini$file_type, width = 10, height = 15, bg = "white")
p

```


Plot QC metrics on UMAP

```{r, fig.height=8, fig.width=10, message = FALSE}
p1<- FeaturePlot(so.fibroblasts, features = "sum", reduction = "umap")+ggtitle ("nCounts")+
    scale_color_continuous(type = "viridis", limits = c(0,10000))
p2<- FeaturePlot(so.fibroblasts, features = "detected", reduction = "umap") + ggtitle("nFeatures")+
    scale_color_continuous(type = "viridis", limits = c(0,5000))
p3<- FeaturePlot(so.fibroblasts, features = "subsets_mito_percent", reduction = "umap") + ggtitle ("Percent mito reads")+
    scale_color_continuous(type = "viridis")
p4<- FeaturePlot(so.fibroblasts, features = "decontX_contamination", reduction = "umap")+
    scale_colour_gradientn(colours = viridis(256, option = "D"), name = "decontX score")+
        ggtitle("decontX_contamination")
p <- plot_grid(p1, p2, p3, p4)

ggsave(paste0(directory, "/Subset_figures/QC_metrics_UMAP.png"), 
       p, device = ini$file_type, width = 10, height = 8, bg = "white")
p

```



Save the object

```{r}
dir.create(paste0(directory, "/RDS_objects.dir/"))
saveRDS(so.fibroblasts, paste0(directory, "/RDS_objects.dir/Achilles_fibroblast_subset.rds"))
sessionInfo()
```

