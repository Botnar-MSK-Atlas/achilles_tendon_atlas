---
title: "Subset and recluster fibroblasts"
author: "Carla Cohen"
date: "`r Sys.Date()`"
output: html_document
---

A script to subset and re-cluster the fibroblast subsets in the Achilles data  


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r}
library(tidyverse)
library(Seurat)
library(cowplot)
library(yaml)
library(clustree)
library(viridis)
library(EnhancedVolcano)
library(ggVennDiagram)
library(harmony)
library(scales)
# use reticulate to access numpy
reticulate::use_condaenv(condaenv = "integration-env", conda = "/project/ancestryhca/ccohen/mamba_installation/conda/condabin/conda", required = F)
np <- reticulate::import("numpy")
reticulate::import(module = 'leidenalg')

# make a new output folder for each run, with the date & time in the directory name
date <- Sys.Date() %>% str_replace_all("-", "")
time <- format(Sys.time(), "%X") %>% str_replace_all(":", "-") %>%
    str_sub(1, 5)
directory <- paste0(date,"_", time, "_Subset_fibroblasts.dir")
dir.create(directory, showWarnings = FALSE)
dir.create(paste0(directory, "/Subset_figures/"))
dir.create(paste0(directory, "/Marker_lists/"))
dir.create(paste0(directory, "/Dotplots"))
dir.create(paste0(directory, "/Heatmaps"))
ini <- read_yaml("subcluster.yml")

```

Print the parameters
```{r}
ini
```
Set up some parameters
```{r}
if (ini$integration_method == "harmony"){
    identities <- paste0("cell_annotation_harmony_", ini$subset_resolution)
    umap_name <- "harmony.umap"
    prefix_name <- "soupX_snn_res."
} else if (ini$integration_method == "scVI"){
    identities <- paste0("cell_annotation_scVI_", ini$subset_resolution)
    umap_name <- "umap.scvi"
    prefix_name <- "X_scVI_snn_res."
}

# fix a typo from earlier seurat object
if (ini$seurat_object =="20240926_13-46_Annotation_update.dir/RDS_objects.dir/Achilles_integrated_annotated.rds"){
    identities <- paste0("cell_annotation_scvi_", ini$subset_resolution)
}
print(identities)
print(umap_name)
print(prefix_name)
```


Read in the Seurat object  
Annotated at resolution 0.2


```{r}
so <- readRDS(ini$seurat_object)
# colnames(so[[]])
# add the idents as a column of metadata
Idents(so) <- identities
# downsample for testing
# so <- so[, sample(colnames(so), size =20000, replace=F)] #actually doesn't really work as we don't get clusters of FB
so
```

Plot the UMAP  

```{r, fig.width=10, fig.height=7}
p <- DimPlot(so, label = TRUE, repel = TRUE, shuffle = TRUE,reduction = umap_name)
    #scale_colour_viridis_d()
p
```

Subset the fibroblasts

```{r}
so.fibroblasts <- subset(so, idents = ini$subset_clusters)
so.fibroblasts
```
Tidy up the metadata
```{r}
# remove existing clusters
resolutionList <- grep("snn_res", colnames(so.fibroblasts@meta.data), value = TRUE)

for (resolution in resolutionList){
      so.fibroblasts[[resolution]] <- NULL
}

# remove the harmony and X_scVI reductions generated from the whole object
if (ini$integration_method == "harmony"){
    so.fibroblasts[["harmony"]] <- NULL
}else if (ini$integration_method == "scVI"){
    so.fibroblasts[["X_scVI"]] <- NULL
}

so.fibroblasts
```

Re-cluster the fibroblasts
First we need to re-normalise etc

```{r}
DefaultAssay(so.fibroblasts) <- ini$normalisation_assay

so.fibroblasts <- so.fibroblasts %>% 
           NormalizeData() %>%
           FindVariableFeatures(nfeatures = ini$nfeatures) %>% 
           ScaleData() %>%
           RunPCA()

if (ini$integration_method == "harmony"){
    
    so.fibroblasts <- RunHarmony(so.fibroblasts, 
                         group.by.vars = "patient.seqbatch", 
                         plot_convergence = TRUE, 
                         dims.use = 1:ini$n_dims, 
                         kmeans_init_nstart=20, kmeans_init_iter_max=100)
    
    so.fibroblasts <- so.fibroblasts %>% 
        FindNeighbors(dims = 1:ini$n_dims, reduction = "harmony") %>%
        RunUMAP(dims = 1:ini$n_dims, reduction = "harmony") 
    
} else if (ini$integration_method == "scVI"){
    
    # import the scVI embeddings
    scVI_embeddings <- np$load(paste0(ini$import_embeddings, "/scVI_embeddings.npy"))
    
    # import the obs
    scVI_obs <- read.table(paste0(ini$import_embeddings, "/Achilles_scVI_obs.txt"), sep = "\t", header = TRUE, row.names = 1)
    
    # check the barcodes match
    table(rownames(scVI_obs) %in% colnames(so.fibroblasts))
    
    # add rownames to the matrix
    rownames(scVI_embeddings) <- rownames(scVI_obs)
    
    # subset for testing
    scVI_embeddings <- scVI_embeddings[colnames(so.fibroblasts),]
    scVI_obs <- scVI_obs[colnames(so.fibroblasts),]
    
    # add the new embeddings to the subsetted object
    so.fibroblasts[["X_scVI"]] <- CreateDimReducObject(embeddings = scVI_embeddings, key = "scVI_", assay = "RNA")
    
    # re-calculate neighbours using the scVI embeddings
    so.fibroblasts <- FindNeighbors(so.fibroblasts, reduction = "X_scVI", dims = 1:ini$n_dims, graph.name = c("X_scVI_nn", "X_scVI_snn"))

    # recalculate the UMAP using scVI embedidngs
    so.fibroblasts <- RunUMAP(so.fibroblasts, reduction = "X_scVI", dims = 1:ini$n_dims)
}

so.fibroblasts

```


Plot with the original labels.  

```{r}

DimPlot(so.fibroblasts, label = TRUE, repel = TRUE, shuffle = TRUE, reduction = "umap.scvi")
DimPlot(so.fibroblasts, label = TRUE, repel = TRUE, shuffle = TRUE, reduction = "umap")
ggsave(paste0(directory, "/Subset_figures/UMAP_original_clusters.png"), width = 8, height = 6, bg = "white")
```

```{r}
ElbowPlot(so.fibroblasts, ndims = 50)
ggsave(paste0(directory, "/Subset_figures/Elbow_plot.png"), width = 8, height = 6, bg = "white")
```



Find Clusters at resolutions from 0.05-0.3
```{r, message = FALSE, warning = FALSE}
if (ini$integration_method == "harmony"){
    
    if (ini$cluster_method == "louvain"){
        so.fibroblasts <- FindClusters(so.fibroblasts, resolution = seq(0.05, 0.3, 0.05))
    } else if (ini$cluster_method == "leiden"){
        so.fibroblasts <- so.fibroblasts %>% FindClusters(resolution = seq(0.05, 0.3, 0.05), 
                                              algorithm = "leiden",
                                              method = "igraph") # needed if running leiden
    }

} else if (ini$integration_method == "scVI"){
    if (ini$cluster_method == "louvain"){
        so.fibroblasts <- FindClusters(so.fibroblasts, resolution = seq(0.05, 0.5, 0.05), 
                                       graph.name = "X_scVI_snn")
    } else if (ini$cluster_method == "leiden"){
        so.fibroblasts <- so.fibroblasts %>% FindClusters(resolution = seq(0.05, 0.5, 0.05), 
                                              algorithm = "leiden",
                                              method = "igraph", 
                                              graph.name = "X_scVI_snn" #this was calc using scVI reduction on RNA assay
                                              ) # needed if running leiden
    }

}

```




Plot the clustree to determine the most appropriate resolution to use
NB doing the re-integration makes essentially no difference. 

```{r, fig.height= 10, fig.width=10}

clustree(so.fibroblasts, prefix = prefix_name, node_colour = "sc3_stability") + 
        ggtitle("Fibroblasts Clustree")
ggsave(paste0(directory, "/Subset_figures/Clustree_plot.png"), 
       width = 10, height = 10, bg = "white")
```

Plot UMAP for each clustering resolution

```{r, fig.width=10, fig.height=20}

resolutionList <- grep("_snn_res", colnames(so.fibroblasts@meta.data), value = TRUE)

plot_list <- list()

for (resolution in resolutionList){
      plot_list [[resolution]] <- DimPlot(object = so.fibroblasts, label = TRUE, reduction = "umap", 
                                          group.by = resolution, shuffle = TRUE)
      }

title <- ggdraw() + draw_label("UMAPs of multiple clustering resolutions", fontface='bold', size = 24)
p <- plot_grid(plotlist = plot_list, ncol = 2) 
p <- plot_grid(title, p, ncol=1, rel_heights=c(0.05, 1))

ggsave(paste0(directory, "/Subset_figures/UMAP_compare_resolutions.png"), 
       width = 10, height = 16, bg = "white")

p

```


Select resolution 

```{r} 
resolution <- ini$display_resolution
so.fibroblasts[["seurat_clusters"]] <- so.fibroblasts[[paste0(prefix_name, resolution)]]
Idents(so.fibroblasts) <- so.fibroblasts$seurat_clusters
levels(Idents(so.fibroblasts))
```


UMAP split by microanatomy

```{r, fig.height=8, fig.width=8}
DimPlot(object = so.fibroblasts, label = TRUE, reduction = "umap", shuffle = TRUE, 
             split.by = "microanatomical_site", ncol = 2)+
    theme(panel.background = element_rect(colour = "black", linewidth = 1))+
    ggtitle(paste0("Fibroblast UMAP split my microanatomy at resolution ", resolution))
ggsave(paste0(directory, "/Subset_figures/UMAP_microanatomy.png"), 
       width = 10, height = 10, bg = "white")

```

UMAP split by orig.ident

```{r, fig.height=16, fig.width=8}
DimPlot(object = so.fibroblasts, label = TRUE, reduction = "umap", shuffle = TRUE, 
             split.by = "orig.ident", ncol = 3)+
    theme(panel.background = element_rect(colour = "black", linewidth = 1))+
    ggtitle(paste0("Fibroblast UMAP split by orig.ident at resolution ", resolution))
ggsave(paste0(directory, "/Subset_figures/UMAP_orig.ident.png"), 
       width = 8, height = 16, bg = "white")

```

UMAP split by patient

```{r, fig.height=8, fig.width=10}
DimPlot(object = so.fibroblasts, reduction = "umap", shuffle = TRUE, 
             split.by = "patient", ncol = 3, label = TRUE)+
    theme(panel.background = element_rect(colour = "black", linewidth = 1))+
    ggtitle(paste0("Fibroblast UMAP split by patient at resolution ", resolution))
ggsave(paste0(directory, "/Subset_figures/UMAP_patient.png"), 
       width = 10, height = 7, bg = "white")
```

UMAP split by patient - each cluster separately

```{r, fig.height=6, fig.width=8}
# set the colours
colours <- hue_pal()(length(levels(Idents(so.fibroblasts))))
names(colours) <- levels(Idents(so.fibroblasts))

for (cluster_id in levels(Idents(so.fibroblasts))){
    #print(cluster_id)
    so.subset <- subset(so.fibroblasts, idents = cluster_id)
    DimPlot(so.subset, label = TRUE, reduction = "umap", shuffle = TRUE, 
             split.by = "patient", ncol = 3, cols = colours)+
    ggtitle(paste0("Fibroblast UMAP cluster ", cluster_id, " per patient res ", resolution))
    ggsave(paste0(directory, "/Subset_figures/UMAP_cluster_", cluster_id, "_by_patient_", resolution, ".png"), 
       width = 8, height = 6, bg = "white")
}


```

Update the naming of earlier clustering with louvain or leiden

```{r}
# it is not possible to directly change metadata column names
# create a df with new column names
metadata <- so.fibroblasts[[]]
names <- colnames(so.fibroblasts[[]])
if (ini$integration_method == "harmony"){
    if (ini$cluster_method == "louvain"){
        names <- str_replace(names, "^soupX", "louvain_soupX")
        colnames(metadata) <- names
        metadata <- metadata %>% select(starts_with("louvain"))
    } else if (ini$cluster_method == "leiden"){
        names <- str_replace(names, "^soupX", "leiden_soupX")
        colnames(metadata) <- names
        metadata <- metadata %>% select(starts_with("leiden"))
    }   
} else if (ini$integration_method == "scVI"){
    if (ini$cluster_method == "louvain"){
        names <- str_replace(names, "^X_scVI", "louvain_X_scVI")
        colnames(metadata) <- names
        metadata <- metadata %>% select(starts_with("louvain"))
    } else if (ini$cluster_method == "leiden"){
        names <- str_replace(names, "^X_scVI", "leiden_X_scVI")
        colnames(metadata) <- names
        metadata <- metadata %>% select(starts_with("leiden"))
    }   
}


# remove old columns from metadata

resolutionList <- grep("_snn_res", colnames(so.fibroblasts@meta.data), value = TRUE)

for (resolution in resolutionList){
      so.fibroblasts[[resolution]] <- NULL
      }

# add the newly labelled columns

so.fibroblasts <- AddMetaData(so.fibroblasts, metadata)

colnames(so.fibroblasts[[]])


```



### Visualise QC metrics 

```{r, message = FALSE, fig.width=10, fig.height=15}
p1 <- VlnPlot(so.fibroblasts, features = "sum", assay = "RNA", pt.size = 0)+
    scale_y_log10() +
    scale_fill_viridis_d()+
    theme(legend.position="none")+
    theme_cowplot()+
    ggtitle("nCounts")

p2 <- VlnPlot(so.fibroblasts, features = "detected", assay = "RNA", pt.size = 0)+
    scale_y_log10() +
    scale_fill_viridis_d()+
    theme(legend.position="none")+
    theme_cowplot()+
    ggtitle("nFeatures")

p3 <- VlnPlot(so.fibroblasts, features = "subsets_mito_percent", assay = "RNA", pt.size = 0)+
    scale_fill_viridis_d()+
    theme(legend.position="none")+
    theme_cowplot()+
    ggtitle("Percent mitochondrial reads")

p4 <- VlnPlot(so.fibroblasts, features = "decontX_contamination", assay = "RNA", pt.size = 0)+
    scale_fill_viridis_d()+
    theme(legend.position="none")+
    theme_cowplot()+
    ggtitle("decontX score")

p <- plot_grid(p1, p2, p3, p4, ncol = 1)
ggsave(paste0(directory, "/Subset_figures/QC_metrics_across_clusters.png"), 
       p, device = ini$file_type, width = 10, height = 15, bg = "white")
p

```


Plot QC metrics on UMAP

```{r, fig.height=8, fig.width=10, message = FALSE}
p1<- FeaturePlot(so.fibroblasts, features = "sum", reduction = "umap")+ggtitle ("nCounts")+
    scale_color_continuous(type = "viridis", limits = c(0,10000))
p2<- FeaturePlot(so.fibroblasts, features = "detected", reduction = "umap") + ggtitle("nFeatures")+
    scale_color_continuous(type = "viridis", limits = c(0,5000))
p3<- FeaturePlot(so.fibroblasts, features = "subsets_mito_percent", reduction = "umap") + ggtitle ("Percent mito reads")+
    scale_color_continuous(type = "viridis")
p4<- FeaturePlot(so.fibroblasts, features = "decontX_contamination", reduction = "umap")+
    scale_colour_gradientn(colours = viridis(256, option = "D"), name = "decontX score")+
        ggtitle("decontX_contamination")
p <- plot_grid(p1, p2, p3, p4)

ggsave(paste0(directory, "/Subset_figures/QC_metrics_UMAP.png"), 
       p, device = ini$file_type, width = 10, height = 8, bg = "white")
p

```

### FindMarkers


Run FindAllMarkers on the soupX assay for each calculated resolution.

```{r}

find_markers <- function(resolution){
    print(resolution)
    # set the idents to the resolution
    Idents(so.fibroblasts) <- so.fibroblasts[[resolution]] %>% pull()
    # how many clusters are there?
    print(length(unique(Idents(so.fibroblasts))))
    
    markers <-  FindAllMarkers(so.fibroblasts,
                           assay = "soupX",
                           only.pos = TRUE, 
                           min.pct = 0.25, 
                           logfc.threshold = 0.25
                        )
    write.table(markers, 
            paste0(directory, "/Marker_lists/Markers_", resolution, ".txt"), 
                quote = FALSE, sep = "\t")
    return(markers)
        
}

# create a list of resolutions
resolutionList <- grep("snn_res", colnames(so.fibroblasts@meta.data), value = TRUE)

# find markers at each resolution
found_markers <- list()
for (resolution in resolutionList){
      found_markers[[resolution]] <- find_markers(resolution)
}

# using parallel computing
#foreach (resolution = seq(0.05, 5, by = 0.05), .packages = c("Seurat", "tidyverse")) %dopar% {
#    found_markers[[resolution]] <- find_markers(resolution)
#}

```



Calculate the top 10 markers for each cluster by log2FC

```{r}

top10_markers <- list()
for (resolution in resolutionList){
        # only do this if there were marker genes found
        if (length(found_markers[[resolution]]$gene > 0)){
      top10_markers[[resolution]] <- found_markers[[resolution]] %>% 
          group_by(cluster) %>% 
          slice_max(n=10, order_by = abs(avg_log2FC))
    }
      
}



#found_markers[["leiden_X_scVI_snn_res.0.3"]] %>% 
#          group_by(cluster) %>% 
#          slice_max(n=10, order_by = abs(avg_log2FC))

```

Plot the top 10 markers as a dotplot and heatmap

```{r}

for (resolution in resolutionList){
    # only do this if there were marker genes found
    if (length(found_markers[[resolution]]$gene > 0)){
        # set the idents to the resolution
        Idents(so.fibroblasts) <- so.fibroblasts[[resolution]] %>% pull()
        
        res <- str_remove(resolution, "soupX_snn_res.")
        DotPlot(so.fibroblasts,
                 features = unique(top10_markers[[resolution]]$gene),
                 assay = "soupX") + 
        scale_colour_viridis(direction = -1) + 
        coord_flip()+
        ggtitle(paste0("Top 10 markers at resolution ", res))
        
        ggsave(paste0(directory, "/Dotplots/Top10markers_", res, ".png"), width = 10, height = 12)
        ggsave(paste0(directory, "/Dotplots/Top10markers_", res, ".svg"), width = 10, height = 12)
        
        DoHeatmap(subset(so.fibroblasts), 
                   features = unique(top10_markers[[resolution]]$gene),
                   assay = "soupX") + 
            scale_fill_viridis()+
            ggtitle(paste0("Heatmap of top 10 markers at resolution ", res))
        
        ggsave(paste0(directory, "/Heatmaps/Top10markers_", res, ".png"), width = 12, height = 12)
        ggsave(paste0(directory, "/Heatmaps/Top10markers_", res, ".svg"), width = 12, height = 12)
    }
}


```



Addendum: Which are the most highly soupX genes?

### Which genes contribute most to the soup?

```{r, fig.width=12, fig.height=10, warning=FALSE, message = FALSE}

dir.create(paste0(directory, "/SoupX_figures/Highest_ambient_genes/"))
dir.create(paste0(directory, "/SoupX_figures/SoupX_umap/"))

contributing_genes <- function(so){
    
    # calculate highest contributing genes
    subtraction <- so@assays$RNA@counts - so@assays$soupX@counts
    subtraction_colmeans <- colMeans(subtraction) ## average ambient reads per cell
    subtraction_rowmeans <- rowMeans(subtraction) ## average ambient reads per feature
    ## fraction of ambient reads, for each feature, per sample
    subtraction_fraction <- sweep(subtraction, 2, colSums(so@assays$RNA@counts), '/')
    subtraction_fraction_rowsums <- rowSums(subtraction_fraction) ## genes
    subtraction_fraction_colsums <- colSums(subtraction_fraction) ## cells
    
    highest_contributors_ambiencereads <- sort(subtraction_rowmeans, decreasing = T)[1:50] ## the highest contributors (in absolute number of reads)
    
    # dotplots of highest contributing genes
    DefaultAssay(so) <- "RNA"
    p_RNA <- DotPlot(so, 
             features = rev(names(highest_contributors_ambiencereads))) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("RNA assay") +
    coord_flip()
    
    DefaultAssay(so) <- "soupX"
    p_soupX <- DotPlot(so, 
             features = rev(names(highest_contributors_ambiencereads))) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("soupX assay") + 
    coord_flip()
    
    p <- plot_grid(p_RNA, p_soupX, ncol = 2)
    title <- ggdraw() + draw_label(so@project.name, fontface='bold', size = 16)
    p <- plot_grid(title, p, ncol=1, rel_heights=c(0.05, 1))
    
    ggsave(paste0(directory, "/SoupX_figures/Highest_ambient_genes.png"), p, 
                width = 16, height = 14, bg = "white")

    # add soupX fraction to seurat object
    soupX_fraction <- subtraction_fraction_colsums # the ambient score for each cell
    metadata <- so[[]]
    metadata <- cbind(metadata, soupX_fraction)
    so <- AddMetaData(so, metadata)
    
    # plot umap coloured by soupX ambinent score, decontX score, cluster
    p3 <- DimPlot(so, reduction = "umap")
    p1 <- FeaturePlot(so, features = "soupX_fraction", reduction = "umap")
    p2 <- FeaturePlot(so, features = "decontX_contamination", reduction = "umap")
    # plot VlnPlot of soupX fraction
    p4 <- VlnPlot(so, features = "soupX_fraction")
    p <- plot_grid(p1, p2, p3, p4)
    title <- ggdraw() + draw_label("Ambient RNA detection", fontface='bold', size = 16)
    p <- plot_grid(title, p, ncol=1, rel_heights=c(0.05, 1))
    
    ggsave(paste0(directory, "/SoupX_figures/SoupX_umap.png"), p, 
                width = 16, height = 14, bg = "white")
    
}
contributing_genes(so.fibroblasts)

```


Save the object

```{r}
dir.create(paste0(directory, "/RDS_objects.dir/"))
saveRDS(so.fibroblasts, paste0(directory, "/RDS_objects.dir/Achilles_fibroblast_subset.rds"))
sessionInfo()
```

