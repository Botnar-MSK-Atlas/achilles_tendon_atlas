---
title: "Fibroblast fine annotation"
author: "Carla Cohen"
date: "`r Sys.Date()`"
output: html_document
---
# Fibroblast annotation  
A script to perform a summary of the fine annotation of the fibroblast subsets in the Achilles data.

This script follows the scVI integration of the whole Achilles dataset, subsetting of Fibroblasts, then reintegration with scVI. 

Preliminary analysis of the clustering and multiple resolutions was performed: 20250128_12-47_Subset_Fibroblast.dir
This produced lists of DE genes and heatmaps. 

The exploratory analysis was done in Achilles_Fibroblast_Fine-annotation_scVI_0.2_soupX.Rmd

This script is for LOUVAIN at res 0.2 (others are all for leiden). 
In this version the extra soupX filtering was performed. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r}
library(tidyverse)
library(Seurat)
library(cowplot)
library(viridis)
library(scales)
library(readxl)
library(scDotPlot)
library(SingleCellExperiment)
library(ggsci)
library(data.table)


# set the resolution for the script
resolution <- 0.2

# make a new output folder for each run, with the date & time in the directory name
date <- Sys.Date() %>% str_replace_all("-", "")
time <- format(Sys.time(), "%X") %>% str_replace_all(":", "-") %>%
    str_sub(1, 5)
directory <- paste0(date,"_", time, "_Fine_annotation_fibroblasts.dir")
dir.create(directory, showWarnings = FALSE)
dir.create(paste0(directory, "/Marker_dotplots/"))
dir.create(paste0(directory, "/Annotation_figures/"))
dir.create(paste0(directory, "/Feature_Plots"))
dir.create(paste0(directory, "/Vln_Plots/"))

# microanatomy colours
Okabe_Ito <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000000")
ma.cols <-  c(Enth = Okabe_Ito[3], MB = Okabe_Ito[6], MTJ = Okabe_Ito[5], muscle = Okabe_Ito[7])
```

Read in the Achilles subset fibroblast object. 

```{r}
so.fibroblasts <- readRDS("20250131_12-34_Fine_annotation_fibroblasts_0.2.dir/RDS_objects.dir/Achilles_fibroblast_subset.rds")
Idents(so.fibroblasts) <- so.fibroblasts$fine_annotation_fibroblasts

```

## Plot the UMAP

```{r, fig.width=10, fig.height=5}
DimPlot(so.fibroblasts, reduction = "umap")
ggsave(paste0(directory, "/Annotation_figures/Annotated_UMAP_", resolution, ".png"), 
       width = 6, height = 5, bg = "white")
```


UMAP split by microanatomy

```{r, fig.height=8, fig.width=12}
DimPlot(object = so.fibroblasts, reduction = "umap", shuffle = TRUE, 
             split.by = "microanatomical_site", ncol = 2)+
    theme(panel.background = element_rect(colour = "black", linewidth = 1))+
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())+
    ggtitle(("UMAP split by microanatomy"))
ggsave(paste0(directory, "/Annotation_figures/UMAP_by_microanatomy_", resolution, ".png"), 
       width = 12, height = 8, bg = "white")
```

> Take home from microanatomy

Cluster 0, 1, 4, 6 are found across the tendon. 
Cluster 2 & 5 are MTJ/muscle specific. 
Cluster 3 is Enth specific

Bar chart of cell composition

```{r}

df <- so.fibroblasts[[]] %>% select(fine_annotation_fibroblasts, microanatomical_site)

df <- data.table(df)
df <- df[, .(COUNT = .N), by = names(df)]
colnames(df) <- c("fine_annotation_fibroblasts", "microanatomical_site", "proportion")

ggplot(df, aes(fill=microanatomical_site, y=proportion, x=fine_annotation_fibroblasts)) + 
    geom_bar(position="fill", stat="identity")+
    theme_classic()+
    scale_fill_manual(values = ma.cols)+
    coord_flip()+
    theme(axis.title.y = element_blank())

ggsave(paste0(directory, "/Annotation_figures/Cluster_fraction_microanatomy.png"), 
       width = 8, height = 6, bg = "white")
```

Plot it the other way around, so each bar is for a microanatomy

```{r}
df <- so.fibroblasts[[]] %>% select(fine_annotation_fibroblasts, microanatomical_site)

df <- data.table(df)
df <- df[, .(COUNT = .N), by = names(df)]
colnames(df) <- c("fine_annotation_fibroblasts", "microanatomical_site", "proportion")
df
ggplot(df, aes(fill=fine_annotation_fibroblasts, y=proportion, x=microanatomical_site)) + 
    geom_bar(position="fill", stat="identity")+
    theme_classic()+
    #scale_fill_manual(values = ma.cols)+
    # coord_flip()+
    theme(axis.title.y = element_blank())

ggsave(paste0(directory, "/Annotation_figures/Cluster_fraction_by_microanatomy.png"), 
       width = 8, height = 6, bg = "white")
```

Do this but get the proportion from the average contribution per patient (as per Jolet)

```{r}
df <- so.fibroblasts[[]] %>% select(fine_annotation_fibroblasts, microanatomical_site, patient)
df <- data.table(df)
df <- df[, .(COUNT = .N), by = names(df)]
df2 <- df %>% group_by(patient, microanatomical_site) %>% 
    summarise (n_cell = sum(COUNT))
df2 <- left_join(df, df2) %>% 
    # add a column of proportion
    mutate ("proportion" = (COUNT/n_cell)*100) %>%
    # get the mean proportion of cells per each microanatomical site
    group_by(microanatomical_site, fine_annotation_fibroblasts) %>% 
    summarise(mean(proportion))

colnames(df2) <- c("microanatomical_site", "fine_annotation_fibroblasts", "proportion")

ggplot(df2, aes(fill=fine_annotation_fibroblasts, y=proportion, x=microanatomical_site)) + 
    geom_bar(position="fill", stat="identity")+
    theme_classic()+
    #scale_fill_manual(values = ma.cols)+
    #coord_flip()+
    theme(axis.title.y = element_blank())

ggsave(paste0(directory, "/Annotation_figures/Cluster_fraction_by_microanatomy_patient_mean.png"), 
       width = 8, height = 6, bg = "white")
```





### UMAP split by patient

```{r, fig.height=8, fig.width=14}
DimPlot(object = so.fibroblasts, reduction = "umap", shuffle = TRUE, 
             split.by = "patient", ncol = 3)+
    theme(panel.background = element_rect(colour = "black", linewidth = 1))+
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())+
    ggtitle("UMAP split by patient")
ggsave(paste0(directory, "/Annotation_figures/UMAP_patient.png"), 
       width = 14, height = 7, bg = "white")
```

### What % of nuclei are from each patient?

```{r}
# make a df of patient percentages per cluster
df <- so.fibroblasts[[]] %>% select(fine_annotation_fibroblasts, patient)
df$fine_annotation_fibroblasts <- as.character(df$fine_annotation_fibroblasts)
df <- data.table(df)
df <- df[, .(COUNT = .N), by = names(df)]
df2 <- df %>% pivot_wider(names_from = patient, values_from = COUNT, values_fill = 0) %>% 
    column_to_rownames(var = "fine_annotation_fibroblasts")%>%
    mutate_at(vars(1:5), as.numeric) 

df2$my_row_sum <- rowSums(df2)
df2 <- df2 %>% mutate(across(where(is.numeric), ~ .x/my_row_sum*100)) # need to make columns numeric?
df2$my_row_sum <- NULL
df2$cell_type <- rownames(df2)

df2

# plot as bar chart and heatmap
df3 <- df2 %>% pivot_longer(1:5, names_to = "patient", values_to = "proportion")

ggplot(df3, aes(fill=patient, y=proportion, x=cell_type)) + 
    geom_bar(position="stack", stat = "identity")+
    coord_flip()+
    theme_classic()+
    theme(axis.title.y = element_blank())
ggsave(paste0(directory, "/Annotation_figures/Patient_proportion_barchart_", resolution, ".png"), 
       width = 8, height = 6, bg = "white")

ggplot(df3, aes(y=cell_type, x=patient, fill = proportion))+
    geom_tile()+
    scale_fill_viridis()
ggsave(paste0(directory, "/Annotation_figures/Patient_proportion_heatmap_", resolution, ".png"), 
       width = 8, height = 6, bg = "white")


```

No one patients contributes more than 80% of cells to a cluster.

### How are the proportions of cells represented across patietns. 

```{r, fig.width=8, fig.height=5}
# make a df of patient percentages per cluster
df <- so.fibroblasts[[]] %>% select(fine_annotation_fibroblasts, patient)
df$fine_annotation_fibroblasts <- as.character(df$fine_annotation_fibroblasts)
df <- data.table(df)
df <- df[, .(COUNT = .N), by = names(df)]
df


df2 <- df %>% pivot_wider(names_from = fine_annotation_fibroblasts, values_from = COUNT, values_fill = 0) %>% 
    column_to_rownames(var = "patient")%>%
    mutate_at(vars(1:ncol(df)), as.numeric) 

df2$my_row_sum <- rowSums(df2)
df2 <- df2 %>% mutate(across(where(is.numeric), ~ .x/my_row_sum*100)) # need to make columns numeric?
df2$my_row_sum <- NULL
df2$patient <- rownames(df2)

# plot as bar chart and heatmap
df3 <- df2 %>% pivot_longer(1:ncol(df2)-1, names_to = "cell_type", values_to = "proportion")

ggplot(df3, aes(fill=cell_type, y=proportion, x=patient)) + 
    geom_bar(position="stack", stat = "identity")+
    coord_flip()+
    theme_classic()+
    theme(axis.title.y = element_blank())
ggsave(paste0(directory, "/Annotation_figures/Patient_proportion_of_celltype_barchart_", resolution, ".png"), 
       width = 8, height = 6, bg = "white")

ggplot(df3, aes(y=patient, x=cell_type, fill = proportion))+
    geom_tile()+
    scale_fill_viridis()+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggsave(paste0(directory, "/Annotation_figures/Patient_proportion_heatmap_", resolution, ".png"), 
       width = 6, height = 6, bg = "white")


```

### How many cells are there per cluster?

```{r}
cell_numbers <- table(Idents(so.fibroblasts)) %>% as.data.frame()
colnames(cell_numbers) <- c("cluster", "frequency")
cell_numbers
```
```{r}
ggplot(cell_numbers, aes(x = cluster, y = frequency))+
    geom_bar(stat = "identity")+
    theme_cowplot()+
    coord_flip()+
    ggtitle("Number of cells per cluster")
ggsave(paste0(directory, "/Annotation_figures/Number_cells_per_cluster_", resolution, ".png"), 
       width = 6, height = 4, bg = "white")
```
> Clusters 0 and 1 are dominant. 
> The other minor clusters may have more specific functions or may be artefacts. NB cluster 6 only has 77 cells so might be hard to annotate. 
### Visualise QC metrics 

```{r, message = FALSE, fig.width=10, fig.height=20}
p1 <- VlnPlot(so.fibroblasts, features = "sum", assay = "RNA", pt.size = 0)+
    scale_y_log10() +
    theme(legend.position="none")+
    theme_cowplot()+
    theme(axis.text.x = element_blank())+
    ggtitle("nCounts")

p2 <- VlnPlot(so.fibroblasts, features = "detected", assay = "RNA", pt.size = 0)+
    scale_y_log10() +
    theme(legend.position="none")+
    theme_cowplot()+
    theme(axis.text.x = element_blank())+
    ggtitle("nFeatures")

p3 <- VlnPlot(so.fibroblasts, features = "subsets_mito_percent", assay = "RNA", pt.size = 0)+
    theme(legend.position="none")+
    theme_cowplot()+
    theme(axis.text.x = element_blank())+
    ggtitle("Percent mitochondrial reads")

p4 <- VlnPlot(so.fibroblasts, features = "decontX_contamination", assay = "RNA")+
    theme(legend.position="none")+
    theme_cowplot()+
    theme(axis.text.x = element_blank())+
    ggtitle("decontX score")

p5 <- VlnPlot(so.fibroblasts, features = "percent.ribo", assay = "RNA")+
    theme(legend.position="none")+
    theme_cowplot()+
    theme(axis.text.x = element_blank())+
    ggtitle("Percent ribosomal")

p6 <-  VlnPlot(so.fibroblasts, features = "soupX_fraction", assay = "RNA")+
    theme(legend.position="none")+
    theme_cowplot()+
    theme(axis.text.x = element_blank())+
    ggtitle("soupX fraction")

p <- plot_grid(p1, p2, p3, p4, p5, p6, ncol = 1)

ggsave(paste0(directory, "/Annotation_figures/QC_metrics_across_clusters.png"), 
       p, width = 10, height = 20, bg = "white")
p

```

### FindMarkers

Read in the markers calculated by the script "Fibroblasts_subset_recluster.Rmd" from 20250128_12-47_Subset_fibroblasts.dir

```{r, message = FALSE}
markers <- read.table(paste0("20250128_12-47_Subset_Fibroblast.dir/Marker_lists/Markers_louvain_X_scVI_snn_res.", resolution, ".txt"), 
                sep = "\t")

# add the identities to the markers table

unique(markers$cluster)
df <- so.fibroblasts[[]] %>% 
    select(louvain_X_scVI_snn_res.0.2, fine_annotation_fibroblasts) %>% 
    unique() %>% 
    rename("louvain_X_scVI_snn_res.0.2" = "cluster")
markers$cluster <- as.factor(markers$cluster)
markers <- left_join(markers, df,by = "cluster")
```


## Top markers dotplot with dendogram

scDotPlot
https://bioconductor.org/packages/devel/bioc/vignettes/scDotPlot/inst/doc/scDotPlot.html

Use the sce syntax. Seurat version not working, probably as am using seurat v4 not 5. 
```{r}

# convert to sce
sce <- as.SingleCellExperiment(so.fibroblasts)

# select the top 10 markers for each cluster
features_10 <- markers %>% group_by(fine_annotation_fibroblasts) %>%
    dplyr::slice(1:10) %>%
    dplyr::select(fine_annotation_fibroblasts, gene)

# remove duplicated rows
features_10 <- features_10[!duplicated(features_10$gene),]

# make features into a vector
features_10 <- features_10 %>%
    deframe()

# select the top 5 markers for each cluster
features_5 <- markers %>% group_by(fine_annotation_fibroblasts) %>%
    dplyr::slice(1:5) %>%
    dplyr::select(fine_annotation_fibroblasts, gene)

# remove duplicated rows
features_5 <- features_5[!duplicated(features_5$gene),]

# make features into a vector
features_5 <- features_5 %>%
    deframe()

# add marker genes to row data
rowData(sce)$Marker_10 <- features_10[match(rownames(sce), features_10)] %>% 
    names()
rowData(sce)$Marker_5 <- features_5[match(rownames(sce), features_5)] %>% 
    names()

```

Plot 10 most variable genes 

```{r, fig.width=8, fig.height=12}

n_colours <- length(unique(so.fibroblasts$fine_annotation_fibroblasts))

# plot the scaled data
sce %>%
    scDotPlot(features = features_10,
              scale = TRUE,
              group = "fine_annotation_fibroblasts",
              groupAnno = "fine_annotation_fibroblasts",
              featureAnno = "Marker_10",
              groupLegends = FALSE,
              annoColors = list("fine_annotation_fibroblasts" = pal_d3()(n_colours),
                                "Marker_10" = pal_d3()(n_colours)),
              annoWidth = 0.02)
ggsave(paste0(directory, "/Annotation_figures/Dotplot_with_dendogram_scaled_10.png"), width = 8, height = 12, bg = "white")

```

Plot 5 most variable genes 

```{r, fig.width=8, fig.height=8}

# plot the scaled data
sce %>%
    scDotPlot(features = features_5,
              scale = TRUE,
              group = "fine_annotation_fibroblasts",
              groupAnno = "fine_annotation_fibroblasts",
              featureAnno = "Marker_5",
              groupLegends = FALSE,
              annoColors = list("fine_annotation_fibroblasts" = pal_d3()(n_colours),
                                "Fibroblast subset" = pal_d3()(n_colours)),
              annoWidth = 0.02)
ggsave(paste0(directory, "/Annotation_figures/Dotplot_with_dendogram_scaled_5.png"), width = 8, height = 8, bg = "white")

```

### Summary dotplot

Favourite "fibroblasty" names, top 2-3 per cluster in order of preference  

0/2/4 - NEGR1, DCLK1, BMP5
1/3/5 - COMP, ITGA10, KLHL29
0 - VCAN+, CACNB2+, ISM1
1 -FBLN1, CILP, MMP3
2 - COL15A1, GREB1L, LRRTM4
3 - ACAN, COL2A1, SDK2
4 - TENM2, ITGA6, SHISA6
5 - THBS4, NCAM1, PIEZO2
6 - PRG4, CMKLR2, ITGB8



```{r, fig.width=12, fig.height=5}

Idents(so.fibroblasts) <- so.fibroblasts$fine_annotation_fibroblasts
summary_features <- c( "NEGR1", "DCLK1", "BMP5", 
                       "COMP", "ITGA10", "KLHL29", 
                       "VCAN", "CACNB2", "ISM1",
                      "MMP3", "FBLN1", "CILP",
                      "COL15A1", "GREB1L", "LRRTM4",
                      "ACAN", "COL2A1", "SDK2",
                      "TENM2", "ITGA6", "SHISA6",
                      "THBS4", "NCAM1", "PIEZO2",
                      "PRG4", "CMKLR2", "ITGB8") 

DotPlot(so.fibroblasts, features = summary_features, assay = "soupX") + 
    scale_colour_gradient2(low = "#f7f3f2", mid = "#f2390a", high = "#6e1e0a", midpoint = 1)+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 16))+
    theme(axis.text.y = element_text(size = 16))+
    theme(axis.title.x = element_blank())+
    theme(axis.title.y = element_blank())

ggsave(paste0(directory, "/Marker_dotplots/Annotation_markers.png"), width = 12, height = 5, bg = "white")

```

Plot broad annotation markers (two groups of fibroblasts)
```{r, fig.width=12, fig.height=8}

FeaturePlot(so.fibroblasts, features = summary_features[1:6], reduction = "umap",ncol = 3)

ggsave(paste0(directory, "/Feature_Plots/Broad_annotation_markers.png"), width = 12, height = 8, bg = "white")

```

Plot specific markers for each subset

```{r, fig.width=12, fig.height=25}

FeaturePlot(so.fibroblasts, features = summary_features[7:length(summary_features)], reduction = "umap", ncol = 3)

ggsave(paste0(directory, "/Feature_Plots/Specific_annotation_markers.png"), width = 12, height = 25, bg = "white")

```

Vln plots for broad features

```{r, fig.width=12, fig.height=8}

VlnPlot(so.fibroblasts, features = summary_features[1:6], assay = "soupX",ncol = 3)

ggsave(paste0(directory, "/Vln_Plots/Broad_annotation_markers.png"), width = 12, height = 8, bg = "white")

```
Vln plots for specific features

```{r, fig.width=12, fig.height=25}
# TODO get rid of the X axis labels
# might need to plot individually then recombine with cowplot

VlnPlot(so.fibroblasts, features = summary_features[7:length(summary_features)], assay = "soupX",ncol = 3)
ggsave(paste0(directory, "/Vln_Plots/Broad_annotation_markers.png"), width = 12, height = 25, bg = "white")

```

```{r, fig.width=12, fig.height=12}

top10_markers <- markers %>% 
          group_by(cluster) %>% 
          slice_max(n=10, order_by = abs(avg_log2FC))
DoHeatmap(so.fibroblasts, 
                   features = unique(top10_markers$gene),
                   assay = "soupX", 
          label = FALSE) + 
            scale_fill_viridis()
ggsave(paste0(directory, "/Annotation_figures/Annotated_heatmap.png"))
```

```{r}
DimPlot(so.fibroblasts, reduction = "umap", group.by = "fine_annotation_fibroblasts")
DimPlot(so.fibroblasts, reduction = "umap", group.by = "broad_annotation_fibroblasts")
```



```{r, fig.width=10, fig.height=5}
FeaturePlot(so.fibroblasts, features = c("DCLK1", "KLHL29"), reduction = "umap")
```



```{r}
sessionInfo()
```

