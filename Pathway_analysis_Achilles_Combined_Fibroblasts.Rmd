---
title: "Pathway analysis"
author: "Jolet Mimpen/Carla Cohen"
date: "2024-01-22"
output: html_document
---

# Pathway analysis
The aim of the script is to use pathway analysis to analyse the outputs of differential gene expression. 
Specifically this script is to analyse the results of the DEseq2 LRT test of Achilles data where muscle was included.  
Also where the fibroblasts are treated as one cluster. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Seurat)
library(SeuratObject)
library(BiocGenerics)
library(clusterProfiler)
library(msigdbr)
library(tidyverse)
library(svglite)

date <- Sys.Date() %>% str_replace_all("-", "")
time <- format(Sys.time(), "%X") %>% str_replace_all(":", "-") %>%
    str_sub(1, 5)
directory <- paste0(date,"_", time, "_Pathway_Analysis.dir/")
dir.create(directory)

dir.create(paste0(directory, "Figures"))
dir.create(paste0(directory, "Results"))

```

## Gene lists to test

### Read in gene clusters calculated by the DEseq2 LRT test
20240515_14-31_Pseudobulk.dir

```{r}
celltypes <- c("Adipocyte", "Fasttwitch", "Granulocytes", "Fibroblast", 
               "Macrophages", "Mural", "Tcells", "VEC")

clusters <- list()

for (i in seq(1:length(celltypes))){
    clusters[[i]] <- read.csv(paste0("20240515_14-31_Pseudobulk.dir/Cluster_results/", celltypes[[i]], "_df.csv"))
}
names(clusters) <- celltypes

```

#### Genes upregrulated across microanatomy  

Create lists of genes for the following groups:  
Fibroblast group 3-
Fasttwitch muscle group 3-
Macrophages group 2-
T cells group 3-
Granulocytes group 2-
Mural cells group 3-
VEC group 2-
Adipocyte group 1-

```{r}

# genelists
Fibroblast_3 <- clusters[["Fibroblast"]] %>% filter (cluster == 3) %>% pull (genes)
Fasttwitch_3 <- clusters[["Fasttwitch"]] %>% filter (cluster == 3) %>% pull (genes)
Macrophages_2 <- clusters[["Macrophages"]] %>% filter (cluster == 2) %>% pull (genes)
Tcells_3 <- clusters[["Tcells"]] %>% filter (cluster == 3) %>% pull (genes)
Granulocytes_2 <- clusters[["Granulocytes"]] %>% filter (cluster == 2) %>% pull (genes)
Mural_3 <- clusters[["Mural"]] %>% filter (cluster == 3) %>% pull (genes)
VEC_2 <- clusters[["VEC"]] %>% filter (cluster == 2) %>% pull (genes)
Adipocyte_1 <- clusters[["Adipocyte"]] %>% filter (cluster == 1) %>% pull (genes)

genelists_upregulated <- list(Adipocyte_1, Fasttwitch_3, Granulocytes_2, Fibroblast_3, Macrophages_2, 
                              Mural_3, Tcells_3, VEC_2 )
names(genelists_upregulated) <- names(clusters)

```

#### Genes downregulated across microanatomy  

Create lists of genes for the following groups:  
Fibroblasts 1
Fasttwitch muscle group 1
Macrophages group 3
T cells group N/A
Granulocytes group N/A 
Mural cells group 1
VEC group 1
Adipocyte group 3

```{r}

# genelists
Fibroblast_1 <- clusters[["Fibroblast"]] %>% filter (cluster == 1) %>% pull (genes)
Fasttwitch_1 <- clusters[["Fasttwitch"]] %>% filter (cluster == 1) %>% pull (genes)
Macrophages_3 <- clusters[["Macrophages"]] %>% filter (cluster == 3) %>% pull (genes)
Mural_1 <- clusters[["Mural"]] %>% filter (cluster == 1) %>% pull (genes)
VEC_1 <- clusters[["VEC"]] %>% filter (cluster == 1) %>% pull (genes)
Adipocyte_3 <- clusters[["Adipocyte"]] %>% filter (cluster == 3) %>% pull (genes)

genelists_downregulated <- list(Adipocyte_3, Fasttwitch_1, Fibroblast_1, Macrophages_3, 
                              Mural_1, VEC_1 )
names(genelists_downregulated) <- c("Adipocyte", "Fasttwitch", "Fibroblast", "Macrophages", 
                                  "Mural", "VEC")
```


#### Genes upregrulated in tendon compared to muscle  

Create lists of genes for the following groups:  
Fibroblast group 2
Fasttwitch muscle group 2
Macrophages group 5
VEC group 4
Adipocyte group 4

```{r}

# genelists
Fibroblast_2 <- clusters[["Fibroblast"]] %>% filter (cluster == 2) %>% pull (genes)
Fasttwitch_2 <- clusters[["Fasttwitch"]] %>% filter (cluster == 2) %>% pull (genes)
Macrophages_5 <- clusters[["Macrophages"]] %>% filter (cluster == 5) %>% pull (genes)
VEC_4 <- clusters[["VEC"]] %>% filter (cluster == 4) %>% pull (genes)
Adipocyte_4 <- clusters[["Adipocyte"]] %>% filter (cluster == 4) %>% pull (genes)

genelists_tendon_high <- list(Adipocyte_4, Fasttwitch_2, Fibroblast_2, Macrophages_5, VEC_4 )
names(genelists_tendon_high) <- c("Adipocyte", "Fasttwitch", "Fibroblast", "Macrophages", "VEC")

```

#### Genes upregrulated in muscle compared to tendon  

Create lists of genes for the following groups:  
Fibroblasts group 7&9

```{r}

# genelists
Fibroblast_7 <- clusters[["Fibroblast"]] %>% filter (cluster == 7) %>% pull (genes)
Fibroblast_9 <- clusters[["Fibroblast"]] %>% filter (cluster == 9) %>% pull (genes)
Fibroblast_7_9 <- c(Fibroblast_7, Fibroblast_9)

genelists_muscle_high <- list(Fibroblast_7_9)
names(genelists_muscle_high) <- c("Fibroblast")

```

## Background gene sets

Create a specific background gene set of all genes expressed in Seurat object per cell type  

### Create a set of background genes expressed in the tendon & muscle samples

```{r}
# Load seurat object
so.achilles <- readRDS("20240514_17-23_Final_annotation.dir/RDS_objects.dir/Achilles_integrated_annotated.rds")

```

Perform pseudobulk & get vector of expressed genes

```{r}
#Aggregation of counts to sample level
cts <- AggregateExpression(so.achilles, 
                    group.by = c("sample"),
                    assays = 'soupX',
                    slot = "counts",
                    return.seurat = FALSE)
cts <- as.data.frame(cts$soupX)
#cts

# keep genes where there are at least 10 counts 
# expressed_genes_all <- cts %>% filter_all(all_vars(.>2)) %>% rownames()
v <- rowSums(cts)
expressed_genes_all <- names(v[v>9])
length(expressed_genes_all) #35177 genes

```

### Create custom background gene lists for each cell type

Simplify cell names

```{r}
df <- data.frame("cell_annotation_combine_fibroblasts" = unique( so.achilles$cell_annotation_combine_fibroblasts))
df$cell_annotation <- c("Adipocyte", 
                        "Mural", 
                        "Fibroblast", 
                        "VEC", 
                        "Macrophages", 
                        "Tcells", 
                        "LEC", 
                        "Slowtwitch", 
                        "Nerve", 
                        "Fasttwitch", 
                        "Granulocytes", 
                        "Satellite", 
                        "Transitionalmuscle", 
                        "Bcells")
#df

cell_annotation <- left_join(so.achilles[[]], df)
rownames(cell_annotation) <- colnames(so.achilles)
cell_annotation <- cell_annotation %>% select("cell_annotation")

so.achilles <- AddMetaData(so.achilles, metadata = cell_annotation, col.name = "cell_annotation")
```

```{r}
#Aggregation of counts to sample level per cell type
cts <- AggregateExpression(so.achilles, 
                    group.by = c("cell_annotation", "sample"),
                    assays = 'soupX',
                    slot = "counts",
                    return.seurat = FALSE)

# transpose & convert to df
cts.t <- as.data.frame(t(cts$soupX))

# get values where to split
splitRows <- gsub('_.*', '', rownames(cts.t))

# split data.frame into a list of df for each cell type
cts.split <- split.data.frame(cts.t,
                 f = factor(splitRows), 
                 drop = TRUE)

# fix colnames and transpose function
rownames_change <- function(x){
  rownames(x) <- gsub('.*_(.*)', '\\1', rownames(x))
  return(x)
}

# create a list of df for each cell type
counts_list <- list()
for (i in 1:length(names(cts.split))){
    counts_list[[i]] <- t(rownames_change(cts.split[[i]]))
}

names(counts_list) <- names(cts.split)

```

Make a list of expressed genes for each cell type
```{r}
# keep genes where there are at least 10 counts across all samples
# can't be too specific as some samples don't express those genes

expressed_genes <- list()
for (i in 1:length(counts_list)){
    v <- rowSums(counts_list[[i]])
    expressed_genes[[i]] <- names(v[v>9])
    print(length(expressed_genes[[i]]))
    print(head(expressed_genes[[i]]))
}

names(expressed_genes) <- names(counts_list)

# print number of genes from 
```

## Pathway databases
Access the pathway databases required to perform the enrichment analysis  

### Make Hallmark reference list
```{r}
#import Hallmark pathway gene list
Hallmark_reference <- msigdbr(species = "Homo sapiens", category = "H") %>% 
  dplyr::select(gs_name, gene_symbol)

Hallmark_reference$gs_name <- gsub("_"," ", Hallmark_reference$gs_name)
Hallmark_reference$gs_name <- tolower(Hallmark_reference$gs_name)
Hallmark_reference$gs_name <- gsub("(^|[[:space:]])([[:alpha:]])", "\\1\\U\\2", Hallmark_reference$gs_name, perl=TRUE)
Hallmark_reference$gs_name <- gsub("Hallmark ","", Hallmark_reference$gs_name)
```


### Make GO reference list
```{r}
#import GO:BP pathway gene list
GOBP_reference <- msigdbr(species = "Homo sapiens", category = "C5", subcategory = "GO:BP") %>% 
  dplyr::select(gs_name, gene_symbol)

GOBP_reference$gs_name <- gsub("GOBP_","", GOBP_reference$gs_name)
GOBP_reference$gs_name <- gsub("_"," ", GOBP_reference$gs_name)
GOBP_reference$gs_name <- tolower(GOBP_reference$gs_name)
GOBP_reference$gs_name <- gsub("(^|[[:space:]])([[:alpha:]])", "\\1\\U\\2", GOBP_reference$gs_name, perl=TRUE)
```


### Run Pathway analysis
Hallmark and GOBP databases are used  
Select groupings for each cell type according to up-and down-regulation across microanatomy. 
Use the "enricher" function from clusterProfiler.  

Make a function to run the enricher function according to 
- gene list
- terms (GOBP/Hallmark)
- background gene set (custom cell)

```{r}

run_enricher <- function(genelist, description, terms, universe){
    
    results <- list()
    dir.create(paste0(directory, "Results/", description))
    #print(class(universe))
    if (class(universe) == "list"){
        my_universe <- universe[[i]]
    }else if (class(universe) == "character"){
        my_universe <- universe
    }else if (class(universe) == "NULL"){
        my_universe <- NULL
    }
    print(head(my_universe))

    for(i in 1:length(genelist)){
        current_celltype <- names(genelist[i])
        #print(current_celltype)
        genes <- genelist[[i]]
        #print(head(genes))
        
        results[[i]] <- enricher(genes, TERM2GENE = terms, universe = my_universe)
        
        saveRDS(results[[i]], 
                paste0(directory, "Results/", description, "/", current_celltype, ".RDS"))    
        
    }
    
    names(results) <- names(genelist)
    return(results)
}

upregulated_GOBP_custom_cell <- run_enricher(genelists_upregulated, "Upregulated_GOBP_custom_cell", 
            GOBP_reference, expressed_genes)
downregulated_GOBP_custom_cell <- run_enricher(genelists_downregulated, "Downregulated_GOBP_custom_cell", 
            GOBP_reference, expressed_genes)
tendon_high_GOBP_custom_cell <- run_enricher(genelists_tendon_high, "Tendon_high_GOBP_custom_cell", 
            GOBP_reference, expressed_genes)
muscle_high_GOBP_custom_cell <- run_enricher(genelists_muscle_high, "muscle_high_GOBP_custom_cell", 
            GOBP_reference, expressed_genes)

```
Function for plotting results

```{r}

plot_enricher <- function(enricher_result, description){
    dir.create(paste0(directory, "Figures/", description), showWarnings = FALSE)
    for (i in 1:length(enricher_result)){
        #print(names(enricher_result[i]))
        n_pathways <- enricher_result[[i]]@result %>% filter(p.adjust < 0.05) %>% rownames() %>% length()
        #print(n_pathways)
        #print(description)
        if (n_pathways > 0){
            dotplot(enricher_result[[i]])+
                ggtitle(paste0(names(enricher_result[i]), "_", description))
            ggsave(paste0(directory, "Figures/", description, "/", names(enricher_result[i]), ".png"))
        }else{
            print ("no significant pathways")
        }
        
    }
}

plot_enricher(upregulated_GOBP_custom_cell, "Upregulated_GOBP_custom_cell")
plot_enricher(downregulated_GOBP_custom_cell, "Downregulated_GOBP_custom_cell")
plot_enricher(tendon_high_GOBP_custom_cell, "Tendon_high_GOBP_custom_cell")
plot_enricher(muscle_high_GOBP_custom_cell, "Muscle_high_GOBP_custom_cell")
```

### Additional visualisation

Dotplot combining results from all cell types. 

```{r}
dir.create(paste0(directory, "Figures/Combined_dotplots/"))

plot_dotplot <- function(enrichment_results, comparison){
    #dir.create(paste0(directory, "Figures/Combined_dotplots/", comparison), showWarnings = FALSE)
    print(comparison)
    results <- list()
    for (i in 1:length(enrichment_results)){
        results[[i]] <- enrichment_results[[i]]@result
        results[[i]]$celltype <- names(enrichment_results)[[i]]
        results[[i]] <- results[[i]] %>% 
            filter(p.adjust < 0.05) %>% 
            arrange(desc(p.adjust))
    }
    results <- bind_rows(results)
    if (nrow(results) >0){
        # make cell type a factor
        results$celltype <- factor(results$celltype, levels = c("Fibroblast",
                                                                      "Fasttwitch", "VEC", "Mural", "Adipocyte", 
                                                                      "Macrophages", "Tcells", "Granulocytes"))
    
        filtered_res <- results %>% 
            mutate(new_col = -log10(p.adjust)) %>% 
            group_by(celltype) %>% 
            slice_min(order_by = p.adjust, n = 10) %>% 
            select(ID, GeneRatio, p.adjust, Count, celltype, new_col)
        
        # make IDs a factor
        pathways <- as.data.frame(sort(table(filtered_res$ID)))
        colnames(pathways) <- c("ID", "pathway_freq")
        filtered_res <- filtered_res %>% 
            left_join(pathways) %>%
            group_by(pathway_freq) %>%
            arrange(celltype)
        filtered_res$ID <- factor(filtered_res$ID, levels = rev(unique(filtered_res$ID)))    
                
            
        ggplot(filtered_res, aes(x = celltype, y = ID, size = Count, colour = new_col)) +
            geom_point()+
            #scale_colour_viridis()+
            theme_bw()+
            theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
            theme(axis.title.x = element_blank())+
            theme(axis.title.y = element_blank())+
            labs(colour = "-log10(p.adj)")+
            scale_y_discrete(position = "right")+
            ggtitle(comparison)
        
        ggsave (paste0(directory, "Figures/Combined_dotplots/", comparison, ".png"), 
                width = 8, height = 7)
        ggsave (paste0(directory, "Figures/Combined_dotplots/", comparison, ".svg"), 
                width = 8, height = 7)
    }else{
        print("no significant results")
    }

    
}

plot_dotplot(upregulated_GOBP_custom_cell, "Upregulated_GOBP_custom_cell")
plot_dotplot(downregulated_GOBP_custom_cell, "Downregulated_GOBP_custom_cell")
plot_dotplot(tendon_high_GOBP_custom_cell, "Tendon_high_GOBP_custom_cell")
plot_dotplot(muscle_high_GOBP_custom_cell, "Muscle_high_GOBP_custom_cell")

```



