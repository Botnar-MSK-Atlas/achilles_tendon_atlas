---
title: "Annotation-update_achilles-combined"
author: "Carla Cohen"
date: "`r Sys.Date()`"
output: html_document
---

# Annotation update for achilles  

This script is to perform annotation of the Achilles combined dataset 

It follows Annotation-achilles-combined.Rmd  
This script will end up being unique according to 
* the number of variable features used
* the assay used  



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r}
library(tidyverse)
library(Seurat)
library(cowplot)
library(yaml)
library(viridis)

# make a new output folder for each run, with the date & time in the directory name
date <- Sys.Date() %>% str_replace_all("-", "")
time <- format(Sys.time(), "%X") %>% str_replace_all(":", "-") %>%
    str_sub(1, 5)
directory <- paste0(date,"_", time, "_Annotation_update.dir")
dir.create(directory, showWarnings = FALSE)

#need to update yml file as appropriate
ini <- read_yaml("annotation_update.yml")


```
Print the parameters

```{r}
ini
```
### Parameters
Extract some names that depend on the normalisation method performed

```{r}
if (ini$normalisation_method == "SCTransform"){
        
        # save the reduction names
        pca_name <- "sct.pca"
        umap_name <- "sct.umap"
        
        # save the resolution prefix
        res_prefix <- "SCT_snn_res."
        
    } else if (ini$normalisation_method == "SCTransformv2"){
    
    # save the reduction names
     pca_name <- "sctv2.pca"
     umap_name <- "sctv2.umap"
     
     # save the resolution prefix
     res_prefix <- "SCTv2_snn_res."
    
    } else if (ini$normalisation_method == "LogNormalise"){
    
     # save the reduction names
     pca_name <- "lognorm.pca"
     umap_name <- "lognorm.umap"
     
     # save the resolution prefix
     res_prefix <- "RNA_snn_res."
     
    # Some prefixes change if decontX is used for normalisation
    if (ini$normalisation_assay == "decontXcounts"){
        res_prefix <- "decontXcounts_snn_res."
    }
    if (ini$normalisation_assay == "soupX"){
        res_prefix <- "soupX_snn_res."
    }    
}
 

print(ini$normalisation_method) 
print(pca_name)
print(umap_name)
print(res_prefix)
```
Read in the integrated Seurat object
NB if SCT is used this needs to come from the Annotation folder not the Integration folder.  
[specity for each analysis]
```{r}

so.harmony <- readRDS("20231106_14-21_Integration.dir/RDS_objects.dir/Achilles_harmony_SeuratObject.rds")
so.harmony

```

Use annotations from [specify annotation directory]  

# Resolution 0.1

Annotation at resolution 0.1

```{r}

# set a resolution
resolution <- 0.1
so.harmony[["seurat_clusters"]] <- so.harmony[[paste0(res_prefix, resolution)]]
Idents(so.harmony) <- so.harmony[[paste0(res_prefix, resolution)]]
levels(Idents(so.harmony))
```

## Add cell annotations

0 - fibroblasts
1 - skeletal muscle
2 - vascular endothelium
3 - macrophages
4 - mural cells
5 - adipocytes
6 - T cells
7 - lymphatic endothelium
8 - satellite cells
9 - granulocytes
10 - B cells
11 - nerve cells



```{r, fig.width = 10, fig.height=7}
so.harmony_0.1 <- so.harmony
so.harmony_0.1 <- RenameIdents(so.harmony, 
                           `0` = "Fibroblast", 
                           `1` = "Skeletal muscle", 
                           `2` = "Vascular endothelium",
                           `3` = "Macrophage", 
                           `4` = "Mural", 
                           `5` = "Adipocyte", 
                           `6` = "T cell", 
                           `7` = "Lymphatic endothelium", 
                           `8` = "Satellite cells",
                           `9` = "Granulocytes", 
                           `10` = "B cells",
                           `11` = "Nerve cells")

# add these Idents as a column in the metadata as well
so.harmony_0.1$cell_annotation <- Idents(so.harmony)

p <- DimPlot(so.harmony_0.1, label = TRUE, repel = TRUE, shuffle = TRUE,reduction = "harmony.umap")
    #scale_colour_viridis_d()
p

```

```{r}
ggsave(paste0(directory, "/Annotation_figures/UMAP_annotated_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 10, height = 7, bg = "white")
```

Save the annotated object

```{r, echo=FALSE}
dir.create (paste0(directory, "/RDS_objects.dir"))

#saveRDS(so.harmony_0.1, 
            #            paste0(directory, "/RDS_objects.dir/Achilles_integrated_annotated_", resolution, ".rds"))

```

# Resolution 0.2

Annotation at resolution 0.2

```{r}

# set a resolution
resolution <- 0.2
so.harmony[["seurat_clusters"]] <- so.harmony[[paste0(res_prefix, resolution)]]
Idents(so.harmony) <- so.harmony[[paste0(res_prefix, resolution)]]
levels(Idents(so.harmony))
```

## Add cell annotations

0 - slow twitch skeletal muscle
1 - fibroblast
2 - fibroblast 
3 - vascular endothelium
4 - macrophage
5 - mural
6 - fast-twitch skeletal muscle
7 - adipocyte
8 - T cells
9 - transitional skeletal muscle
10 - lyphatic endothelium
11 - satellite  
12 - granulocyte
13 - B cells
14 - nerve cells


```{r, fig.width = 10, fig.height=7}
so.harmony_0.2 <- so.harmony
so.harmony_0.2 <- RenameIdents(so.harmony, 
                           `0` = "Slow twitch skeletal muscle", 
                           `1` = "Fibroblast 1", 
                           `2` = "Fibroblast 2",
                           `3` = "Vascular endothelium", 
                           `4` = "Macrophage", 
                           `5` = "Mural", 
                           `6` = "Fast-twitch skeletal muscle", 
                           `7` = "Adipocyte", 
                           `8` = "T cells",
                           `9` = "Transitional skeletal muscle", 
                           `10` = "Lymphatic endothelium",
                           `11` = "Satellite cells",
                           `12` = "Granulocyte",
                           `13` = "B cells",
                           `14` = "Nerve cells")

# add these Idents as a column in the metadata as well
so.harmony_0.2$cell_annotation <- Idents(so.harmony)

p <- DimPlot(so.harmony_0.2, label = TRUE, repel = TRUE, shuffle = TRUE,reduction = "harmony.umap")
    #scale_colour_viridis_d()
p

```



```{r}
ggsave(paste0(directory, "/Annotation_figures/UMAP_annotated_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 10, height = 7, bg = "white")
```

Save the annotated object

```{r, echo=FALSE}
#saveRDS(so.harmony_0.2, 
  #            paste0(directory, "/RDS_objects.dir/Achilles_integrated_annotated_0.2.rds"))

```

Plot the decontX profile  

```{r}

FeaturePlot(so.harmony, features = "decontX_contamination", reduction = "harmony.umap")

```

What are the main genes expressed in cluster 9 (Unknown/ambient)
Read in the output of FindAllMarkers from the appropriate Annotation output

```{r}
markers_0.2 <- read.table("20231108_20-43_Annotation.dir/Marker_lists/Markers_0.2.txt")
markers_0.2$cluster %>% unique()
```

Select top 10 markers for each cluster  

```{r}

top10markers_0.2 <- markers_0.2 %>% 
    group_by(cluster) %>% 
    slice_max(n=10, order_by = abs(avg_log2FC))


```

```{r}
cluster9 <- top10markers_0.2 %>% filter(cluster == 9)
cluster9
```

```{r, fig.height=8, fig.width=8}
DotPlot(so.harmony, 
             features =cluster9$gene,
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Cluster 9 markers") + 
    coord_flip()
```

Plot decontX by cluster on Vln plot

```{r}
VlnPlot(so.harmony, features = "decontX_contamination", assay = "soupX", pt.size = 0)+
    #scale_y_log10() +
    scale_fill_viridis_d()+
    theme(legend.position="none")+
    theme_cowplot()+
    ggtitle("decontX contamination")
```
Make an object with cluster 9 removed. 

```{r}
so.harmony_0.2.rm9 <- subset(so.harmony_0.2, idents = "Unknown/ambient", invert = TRUE)
```
Plot the new umap

```{r, fig.width = 10, fig.height=7}
p <- DimPlot(so.harmony_0.2.rm9, label = TRUE, repel = TRUE, shuffle = TRUE,reduction = "harmony.umap")
    #scale_colour_viridis_d()
p
```
Now how does the ambient RNA look?

```{r}
FeaturePlot(so.harmony_0.2.rm9, features = "decontX_contamination", reduction = "harmony.umap")
```

Save the annotated object after removal of the ambient cluster.  
```{r, echo=FALSE}
saveRDS(so.harmony_0.2.rm9, 
            paste0(directory, "/RDS_objects.dir/Achilles_integrated_annotated_0.2.rds"))

```




# Resolution 0.3

Annotation at resolution 0.3

```{r}

# set a resolution
resolution <- 0.3
so.harmony[["seurat_clusters"]] <- so.harmony[[paste0(res_prefix, resolution)]]
Idents(so.harmony) <- so.harmony[[paste0(res_prefix, resolution)]]
levels(Idents(so.harmony))
```

## Add cell annotations

0 - slow twitch skeletal muscle
1 - fibroblast 1
2 - fibroblast 2
3 - vascular endothelium
4 - macrophages
5 - skeletal muscle
6 - mural cells
7 - adipocyte
8 - T cells
9 - transitional skeletal muscle
10 - fast twitch skeletal muscle
11 - lymphatic endothelium 
12 - satellite cells
13 - granulocytes
14 - fibroblasts  
15 - B cells
16 - nerve cells





```{r, fig.width = 10, fig.height=7}
so.harmony_0.3 <- so.harmony
so.harmony_0.3 <- RenameIdents(so.harmony_0.3, 
                           `0` = "Slow twitch skeletal muscle", 
                           `1` = "Fibroblast 1", 
                           `2` = "Fibroblast 2",
                           `3` = "Vascular endothelium", 
                           `4` = "Macrophage", 
                           `5` = "Skeletal muscle", 
                           `6` = "Mural", 
                           `7` = "Adipocyte", 
                           `8` = "T cells",
                           `9` = "Transitional skeletal muscle", 
                           `10` = "Fast twitch skeletal muscle",
                           `11` = "Lymphatic endothelium",
                           `12` = "Satellite cells",
                           `13` = "Granulocytes",
                           `14` = "Fibroblast 3",
                           `15` = "B cells", 
                           `16` = "Nerve cells")

# add these Idents as a column in the metadata as well
so.harmony_0.3$cell_annotation <- Idents(so.harmony)

p <- DimPlot(so.harmony_0.3, label = TRUE, repel = TRUE, shuffle = TRUE,reduction = "harmony.umap")
    #scale_colour_viridis_d()
p

```

```{r}
ggsave(paste0(directory, "/Annotation_figures/UMAP_annotated_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 10, height = 7, bg = "white")
```



Save the annotated object

```{r, echo=FALSE}
#saveRDS(so.harmony_0.3, 
            #            paste0(directory, "/RDS_objects.dir/Achilles_integrated_annotated_0.3.rds"))

```


Have I removed decontX counts already?

```{r}

FeaturePlot(so.harmony, features = "decontX_contamination", reduction = "harmony.umap")

```

