---
title: "Fibroblast comparison"
author: "Carla Cohen"
date: "`r Sys.Date()`"
output: html_document
---

A script to compare the two fibroblast subsets found in the Achilles tendon data. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r}
library(tidyverse)
library(Seurat)
library(cowplot)
library(yaml)
library(viridis)

# make a new output folder for each run, with the date & time in the directory name
date <- Sys.Date() %>% str_replace_all("-", "")
time <- format(Sys.time(), "%X") %>% str_replace_all(":", "-") %>%
    str_sub(1, 5)
directory <- paste0(date,"_", time, "_Fibroblast_comparison.dir")
dir.create(directory, showWarnings = FALSE)



```


Read in the Seurat object  
Resolution 0.2
Cluster of high ambient RNA removed

```{r}
so <- readRDS("20231110_11-27_Annotation_update.dir/RDS_objects.dir/Achilles_integrated_annotated_0.2.rds")
```

Plot the UMAP  

```{r, fig.width=10, fig.height=7}
p <- DimPlot(so, label = TRUE, repel = TRUE, shuffle = TRUE,reduction = "harmony.umap")
    #scale_colour_viridis_d()
p
```


Perform FindMarkers to specifically compare the two fibroblast clusters

```{r}
fibroblast_markers <- FindMarkers(so, 
                                  ident.1 = "Fibroblast 1",
                                  ident.2 = "Fibroblast 2",
                                  assay = "soupX",
                                  min.pct = 0.25)
                                  #min.diff.pct = 0.25, 
                                  #test.use = "MAST"
                                  
#in hamstring they used min.pct = 0.25 so try that to get more stringent results. 
fibroblast_markers #1450 genes at min.pct = 0.1, 623 genes at min.pct = 0.25
#143 genes with min.pct = 0.5
```

```{r, fig.width=12, fig.height=8}
  p <- EnhancedVolcano(fibroblast_markers,
                       lab = rownames(fibroblast_markers),
                       x = 'avg_log2FC',
                       y = 'p_val',
                       title = "Fibroblast 1 vs Fibroblast 2",
                       #drawConnectors = TRUE,
                       #pointSize = 1.0,
                       #FCcutoff = 1.0,
                       #selectLab = rownames(fibroblast_markers_top10)
                     )
p
```


```{r}
dir.create(paste0(directory, "/Fibroblast_comparison_figures"))
ggsave(paste0(directory, "/Fibroblast_comparison_figures/Volcano_plot_0.25.png"), 
       device = "png", width = 10, height = 7, bg = "white")
```


Draw a dot plot of the top 10 most differential markers

```{r, fig.height=}
fibroblast_markers_top10 <- fibroblast_markers %>%
    slice_max(n=40, order_by = abs(avg_log2FC)) %>%
    arrange(avg_log2FC)

```

```{r, fig.height=6, fig.width=10}

p1 <- DotPlot(so, 
             features = rownames(fibroblast_markers_top10)[20:40],
             assay = "soupX",
             idents = c("Fibroblast 1", "Fibroblast 2")) + 
    scale_colour_viridis(direction = -1, end = 0.75) +
    coord_flip()+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
    

p2 <- DotPlot(so, 
             features = rownames(fibroblast_markers_top10)[1:19],
             assay = "soupX",
             idents = c("Fibroblast 1", "Fibroblast 2")) + 
    scale_colour_viridis(direction = -1, end = 0.75) +
    coord_flip()+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
    
plot_grid(p1, p2)
```
```{r}
ggsave(paste0(directory, "/Fibroblast_comparison_figures/Fibroblast_dotplot.png"), 
       device = "png", width = 10, height = 7, bg = "white")
```

Rename the identities
Fibroblast 1 = NEGR1+ fibroblasts
Fibroblast 2 = ITGA10+ fibroblasts
Nerve cells = Nervous system cells

```{r}
so <- RenameIdents(so, 
                   `Fibroblast 1` = "NEGR1+ Fibroblast", 
                   `Fibroblast 2` = "ITGA10+ Fibroblast",
                    `Nerve cells` = "Nervous system cells")

Idents(so) %>% unique()
```
Plot the UMAP

```{r, fig.width=10, fig.height=7}
p <- DimPlot(so, label = TRUE, repel = TRUE, shuffle = TRUE,reduction = "harmony.umap")
    #scale_colour_viridis_d()
p
```
```{r}
ggsave(paste0(directory, "/Fibroblast_comparison_figures/UMAP_updated_Idents.png"), 
       device = "png", width = 10, height = 7, bg = "white")
```

Save the updated object

```{r}
dir.create(paste0(directory, "/RDS_objects.dir/"))
saveRDS(so, paste0(directory, "/RDS_objects.dir/Achilles_integrated_annotated_0.2.rds"))
```




Test out filtering with decontX < 0.5

```{r, fig.width=10, fig.height=7}
so.decontX <- subset(so, decontX_contamination < 0.3)
p <- DimPlot(so.decontX, label = TRUE, repel = TRUE, shuffle = TRUE,reduction = "harmony.umap")
    #scale_colour_viridis_d()
p

```



Plot the hamstring marker genes for PDGFRA+ fibroblasts and MKX+ fibroblasts


```{r}
p <- DotPlot(so, 
             features = c("PDGFRA", "NEGR1", "LRRTM4", "NOVA1", "KCND2", "ROBO2", 
                          "MKX", "PIEZO2", "HPSE2", "ENSG000000228566", "THBS4", "RGS6"),
             assay = "soupX",
             idents = c("Fibroblast 1", "Fibroblast 2")) + 
    scale_colour_viridis(direction = -1, end = 0.75) +
    coord_flip()+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p
    
```

```{r}
ggsave(paste0(directory, "/Fibroblast_comparison_figures/Fibroblast_hamstring_markers_1.png"), 
       device = "png", width = 10, height = 7, bg = "white")
```

```{r, fig.width=10, fig.height=8}
p1 <- DotPlot(so, 
             features = c("ABCA8", "COL15A1", "CD44", "DCLK1", "ELN", "FBN1", "FBLN1", 
             "FBLN2", "FBLN5", "KCND2", "NEGR1", "NOVA1", "PDGFRA", "VIT"),
             assay = "soupX",
             idents = c("Fibroblast 1", "Fibroblast 2")) + 
    scale_colour_viridis(direction = -1, end = 0.75) +
    coord_flip()+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
    ggtitle("Hamstring PDGFRA+ fibrblast markers")
p2 <- DotPlot(so, 
             features = c("CADM1", "COL11A1", "COL11A2", "COL12A1", "COL24A1", "COMP", "CPXM2",
             "FMOD", "MET", "MKX", "ITGA10", "PIEZO2", "THBS4", "THSD4", "TNMD"),
             assay = "soupX",
             idents = c("Fibroblast 1", "Fibroblast 2")) + 
    scale_colour_viridis(direction = -1, end = 0.75) +
    coord_flip()+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
    ggtitle("Hamstring MKX+ fibrblast markers")

plot_grid(p1, p2)
    
```

```{r}
ggsave(paste0(directory, "/Fibroblast_comparison_figures/Hamstring_fibroblast_markers_2.png"), 
       device = "png", width = 10, height = 7, bg = "white")
```

DimPlot by microanatomy


```{r, fig.width = 10, fig.height = 8, message = FALSE}

p <- DimPlot(so, reduction = "harmony.umap", pt.size = .1, split.by = "microanatomical_site", ncol = 2)+
    #scale_colour_viridis_d()+
    theme(panel.background = element_rect(colour = "black", linewidth = 1))
    ggtitle("microanatomical site")
p
```

```{r}
ggsave(paste0(directory, "/Fibroblast_comparison_figures/UMAP_by_microanatomy.png"), 
       device = "png", width = 10, height = 7, bg = "white")
```