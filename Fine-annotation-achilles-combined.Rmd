---
title: "Fine annotation"
author: "Carla Cohen"
date: "`r Sys.Date()`"
output: html_document
---

A script to compare the two fibroblast subsets found in the Achilles tendon data. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r}
library(tidyverse)
library(Seurat)
library(cowplot)
library(yaml)
library(viridis)
library(EnhancedVolcano)
library(ggVennDiagram)

# make a new output folder for each run, with the date & time in the directory name
date <- Sys.Date() %>% str_replace_all("-", "")
time <- format(Sys.time(), "%X") %>% str_replace_all(":", "-") %>%
    str_sub(1, 5)
directory <- paste0(date,"_", time, "_Fine_annotation.dir")
dir.create(directory, showWarnings = FALSE)



```


Read in the Seurat object  
Cluster of high ambient RNA removed

```{r}
so <- readRDS("20240118_13-26_Annotation_update.dir/RDS_objects.dir/Achilles_integrated_annotated.rds")
```

Set the resolution to 0.2

```{r}
resolution <- 0.2
Idents(so) <- so$cell_annotation_0.2
```


Plot the UMAP  

```{r, fig.width=10, fig.height=7}
p <- DimPlot(so, label = TRUE, repel = TRUE, shuffle = TRUE,reduction = "harmony.umap")
    #scale_colour_viridis_d()
p
```


Perform FindMarkers to specifically compare the two fibroblast clusters

```{r}
fibroblast_markers <- FindMarkers(so, 
                                  ident.1 = "Fibroblast 1",
                                  ident.2 = "Fibroblast 2",
                                  assay = "soupX",
                                  min.pct = 0.25)
                                  #min.diff.pct = 0.25, 
                                  #test.use = "MAST"
                                  
#in hamstring they used min.pct = 0.25 so try that to get more stringent results. 
fibroblast_markers #1450 genes at min.pct = 0.1, 623 genes at min.pct = 0.25
#143 genes with min.pct = 0.5
```

```{r, fig.width=12, fig.height=8}
  p <- EnhancedVolcano(fibroblast_markers,
                       lab = rownames(fibroblast_markers),
                       x = 'avg_log2FC',
                       y = 'p_val',
                       title = "Fibroblast 1 vs Fibroblast 2",
                       #drawConnectors = TRUE,
                       #pointSize = 1.0,
                       #FCcutoff = 1.0,
                       #selectLab = rownames(fibroblast_markers_top10)
                     )
p
```


```{r}
dir.create(paste0(directory, "/Fibroblast_comparison_figures"))
ggsave(paste0(directory, "/Fibroblast_comparison_figures/Volcano_plot_0.25.png"), 
       device = "png", width = 10, height = 7, bg = "white")
```


Draw a dot plot of the top 10 most differential markers

```{r}
#fibroblast_markers_top10 <- fibroblast_markers %>%
#    slice_max(n=40, order_by = abs(avg_log2FC)) %>%
#    arrange(avg_log2FC)

fibroblast_markers_top10 <- slice_max(fibroblast_markers, n=40, order_by = abs(avg_log2FC))
fibroblast_markers_top10 <- arrange(fibroblast_markers_top10, avg_log2FC)
```

```{r, fig.height=6, fig.width=10}

p1 <- DotPlot(so, 
             features = rownames(fibroblast_markers_top10)[20:40],
             assay = "soupX",
             idents = c("Fibroblast 1", "Fibroblast 2")) + 
    scale_colour_viridis(direction = -1, end = 0.75) +
    coord_flip()+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
    

p2 <- DotPlot(so, 
             features = rownames(fibroblast_markers_top10)[1:19],
             assay = "soupX",
             idents = c("Fibroblast 1", "Fibroblast 2")) + 
    scale_colour_viridis(direction = -1, end = 0.75) +
    coord_flip()+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
    
plot_grid(p1, p2)
```
```{r}
ggsave(paste0(directory, "/Fibroblast_comparison_figures/Fibroblast_dotplot.png"), 
       device = "png", width = 10, height = 7, bg = "white")
```


Plot the markers from FindAllMarkers (read in results from Annotation script)

```{r}
markers <- read.table(paste0("20231108_20-43_Annotation.dir/Marker_lists/Markers_", resolution, ".txt"))
assign(paste0("markers_", resolution),  markers)


# select top 10 markers from each fibroblast cluster: 1,2
top10markers <- markers_0.2 %>% 
    group_by(cluster) %>% 
    slice_max(n=10, order_by = abs(avg_log2FC))

top10markers_fib <- top10markers %>% filter (cluster == 1 | cluster == 2)
```

```{r, fig.height=6, fig.width=8, message = FALSE}
DotPlot(so, features = top10markers_fib$gene, 
                     assay = "soupX",
             idents = c("Fibroblast 1", "Fibroblast 2"))+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
    scale_colour_viridis(direction = -1, end = 0.75) +
    coord_flip()
```


```{r}
ggsave(paste0(directory, "/Resolution_", resolution, "/Fibroblast_figures/Fibroblast_dotplot_", resolution, ".png"), 
       device = "png", width = 8, height = 6, bg = "white")
```


Plot the hamstring marker genes for PDGFRA+ fibroblasts and MKX+ fibroblasts


```{r}
p <- DotPlot(so, 
             features = c("PDGFRA", "NEGR1", "LRRTM4", "NOVA1", "KCND2", "ROBO2", 
                          "MKX", "PIEZO2", "HPSE2", "ENSG000000228566", "THBS4", "RGS6"),
             assay = "soupX",
             idents = c("Fibroblast 1", "Fibroblast 2")) + 
    scale_colour_viridis(direction = -1, end = 0.75) +
    coord_flip()+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p
    
```

```{r}
ggsave(paste0(directory, "/Fibroblast_comparison_figures/Fibroblast_hamstring_markers_1.png"), 
       device = "png", width = 10, height = 7, bg = "white")
```

```{r, fig.width=10, fig.height=8}
p1 <- DotPlot(so, 
             features = c("ABCA8", "COL15A1", "CD44", "DCLK1", "ELN", "FBN1", "FBLN1", 
             "FBLN2", "FBLN5", "KCND2", "NEGR1", "NOVA1", "PDGFRA", "VIT"),
             assay = "soupX",
             idents = c("Fibroblast 1", "Fibroblast 2")) + 
    scale_colour_viridis(direction = -1, end = 0.75) +
    coord_flip()+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
    ggtitle("Hamstring PDGFRA+ fibrblast markers")
p2 <- DotPlot(so, 
             features = c("CADM1", "COL11A1", "COL11A2", "COL12A1", "COL24A1", "COMP", "CPXM2",
             "FMOD", "MET", "MKX", "ITGA10", "PIEZO2", "THBS4", "THSD4", "TNMD"),
             assay = "soupX",
             idents = c("Fibroblast 1", "Fibroblast 2")) + 
    scale_colour_viridis(direction = -1, end = 0.75) +
    coord_flip()+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
    ggtitle("Hamstring MKX+ fibrblast markers")

plot_grid(p1, p2)
    
```

```{r}
ggsave(paste0(directory, "/Fibroblast_comparison_figures/Hamstring_fibroblast_markers_2.png"), 
       device = "png", width = 10, height = 7, bg = "white")
```

Plot some favourite fibroblast markers on a feature plot

```{r, fig.width=12, fig.height=12}
fibroblast_markers <- c("NEGR1", "ITGA10", "PRG4", "FGFR2", "NOX4", "PDGFRA", "MKX")
p1 <- DimPlot(so, label = TRUE, repel = TRUE, shuffle = TRUE, reduction = "harmony.umap")
p2 <- FeaturePlot(so, 
                 features = fibroblast_markers, 
                 reduction = "harmony.umap", 
                 ncol = 4)
title <- ggdraw() + draw_label("Favourite fibroblast markers", x = 0.2, fontface='bold', size = 16)
p2 <- plot_grid(title, p2, ncol=1, rel_heights=c(0.1, 1))

plot_grid(p1, p2, ncol = 1)
```
```{r}
ggsave(paste0(directory, "/Resolution_", resolution, "/Fibroblast_figures/Favourite_fibroblast_featureplot_", resolution, ".png"), 
       device = "png", width = 12, height = 12, bg = "white")
```

Plot the Top 10 fibroblast markers on a feature plot
```{r, fig.width=12, fig.height=12}
p <- FeaturePlot(so, 
                  features = top10markers_fib$gene,
                  reduction = "harmony.umap", 
                 ncol = 4)
title <- ggdraw() + draw_label("Top 10 fibroblast markers", x = 0.2, fontface='bold', size = 16)
p <- plot_grid(title, p, ncol=1, rel_heights=c(0.1, 1))
p
```
```{r}
ggsave(paste0(directory, "/Resolution_", resolution, "/Fibroblast_figures/Top10_fibroblast_featureplot_", resolution, ".png"), 
       device = "png", width = 12, height = 12, bg = "white")
```


Rename the identities
Fibroblast 1 = NEGR1+ fibroblasts
Fibroblast 2 = ITGA10+ fibroblasts
Nerve cells = Nervous system cells

```{r}
so <- RenameIdents(so, 
                   `Fibroblast 1` = "NEGR1hi Fibroblasts", 
                   `Fibroblast 2` = "ITGA10hi Fibroblasts",
                    `Adipocyte` = "Adipocytes",
                   `Mural cell` = "Mural cells", 
                   `Vascular endothelium` = "Vascular endothelial cells",
                   `Macrophage` = "Macrophages", 
                   `Lymphatic endothelium` = "Lymphatic endothelial cells",
                   `Slow twitch skeletal muscle` = "Slow-twitch skeletal muscle cells",
                   `Fast-twitch skeletal muscle` = "Fast-twitch skeletal muscle cells",
                   `Granulocyte` = "Granulocytes", 
                   `Satellite cell` = "Satellite cells", 
                   `Transitional skeletal muscle` = "Transitional skeletal muscle cells",
                   `Nerve cells` = "Nervous system cells")

# add column to metadata
so$cell_annotation_update <- Idents(so)

Idents(so) %>% unique()
```
Remove the ambient cluster

```{r}
so <- subset(so, idents = "Unknown/ambient", invert = TRUE)

```

Set colour scheme

```{r}
group.colors = c("#E25822",  # fibroblasts
                 "#499999",  # macrophages
                 "#F28E2B",  # VEC
                 "#4E79A7",  # mural
                 "#F3C300",  # adipocytes
                 "#E68FAC",  # T cells
                 "#8DB600",  # nerve
                 "#888888",  # LEC
                 "#A1CAF1",  # Dividing fib/mural
                 "#BE0032",  # DC
                 "#117733",  # Osteoblasts
                 "#332288",  # Granulocytes
                 "#A55194",  # Osteoclasts
                 "#661100")  # Dividing macrophages

cell.types = c("Fibroblasts", "Macrophages", "Vascular endothelial cells",  "Mural cells",  "Adipocytes", "T cells", "Nervous system cells", "Lymphatic endothelial cells", "Dividing fibroblasts / mural cells", "Dendritic cells", "Osteoblasts", "Granulocytes", "Osteoclasts", "Dividing macrophages")

names(group.colors) <- cell.types 

achilles.colours <- c("#E25822",  # NEGH1hi fib
                      "#499999",  # Macrophages
                      "#F28E2B",  # VEC
                      "#4E79A7",  # Slow-twitch
                      "#F3C300",  # Adipocytes
                      "#E68FAC",  # T cells
                      "#8DB600",  # Nerve
                      "#888888",  # LEC
                      "#A1CAF1",  # Mural
                      "#BE0032",  # ITGA10hi fib
                      "#117733",  # Granulocytes
                      "#332288",  # Transitional
                      "#A55194",  # Fast-twitch
                      "#661100",  # B cells
                      "#a0785a")  # Satellite cells

names(achilles.colours) <- c("NEGR1hi Fibroblasts", "Macrophages", "Vascular endothelial cells",  "Slow-twitch skeletal muscle cells",  "Adipocytes", "T cells", "Nervous system cells", "Lymphatic endothelial cells", "Mural cells", "ITGA10hi Fibroblasts", "Granulocytes", "Transitional skeletal muscle cells", "Fast-twitch skeletal muscle cells", "B cells", "Satellite cells")

df_quads_colours <- as.data.frame(group.colors)
df_achilles_colours <- as.data.frame(achilles.colours)


dir.create(paste0(directory, "/Colours/"))
write.table(df_achilles_colours, paste0(directory, "/Colours/Achilles_colours.txt"), sep = "\t", col.names = FALSE, quote = FALSE)
write.table(df_quads_colours, paste0(directory, "/Colours/Quads_colours.txt"), sep = "\t", col.names = FALSE, quote = FALSE)

```


Plot the UMAP

```{r, fig.width=10, fig.height=7}


p <- DimPlot(so, label = TRUE, repel = TRUE, shuffle = TRUE,reduction = "harmony.umap",
             cols = achilles.colours)

p
```
```{r}
ggsave(paste0(directory, "/Resolution_", resolution, "/UMAP_updated_Idents.png"), 
       device = "png", width = 10, height = 7, bg = "white")
```

DimPlot by microanatomy


```{r, fig.width = 12, fig.height = 10, message = FALSE}

p <- DimPlot(so, reduction = "harmony.umap", pt.size = .1, split.by = "microanatomical_site", ncol = 2, cols = achilles.colours)+
    theme(panel.background = element_rect(colour = "black", linewidth = 1))
    ggtitle("microanatomical site")
p
```

```{r}
ggsave(paste0(directory, "/Fibroblast_comparison_figures/UMAP_by_microanatomy.png"), 
       device = "png", width = 12, height = 10, bg = "white")
```

## Spatial analysis
To use this object as a reference for spatial analysis, we need to use a broader annotation. 

```{r}
df <- data.frame("cell_annotation_update" = unique( so.harmony$cell_annotation_update))
df$cell_annotation_spatial <- c("Adipocytes", "Endothelial cells", "Fibroblasts", "Endothelial cells", "Fibroblasts", "Immune cells", "Immune cells", "Endothelial cells", "Muscle cells", "Nervous system cells", "Muscle cells", "Immune cells", "Muscle cells", "Muscle cells", "Immune cells")
df

so$cell_annotation_spatial <- left_join(so.harmony[[]], df)

```

Colours for this less granular annotation

```{r}
spatial.colours <- c("#E25822",  # Fibroblasts
                      "#4E79A7",  # Muscle
                      "#F3C300",  # Adipocytes
                      "#E68FAC",  # Immune cells
                      "#8DB600",  # Nerve
                      "#888888"  # Endothelial
                     )  # 

names(spatial.colours) <- c("Fibroblasts", "Muscle cells", "Adipocytes",  "Immune cells",  "Nervous system cells", "Endothelial cells")
```

DimPlot by spatial annotations


```{r}

DimPlot(so.harmony, reduction = "harmony.umap", pt.size = .1, group.by = "cell_annotation_spatial", cols = spatial.colours)
    ggtitle("Annotations for spatial analysis")
```

```{r}
ggsave(paste0(directory, "/Fibroblast_comparison_figures/UMAP_by_spatial_annotation.png"), 
       device = "png", width = 12, height = 10, bg = "white")
```


Save the updated object

```{r}
dir.create(paste0(directory, "/RDS_objects.dir/"))
saveRDS(so, paste0(directory, "/RDS_objects.dir/Achilles_integrated_annotated.rds"))
```
