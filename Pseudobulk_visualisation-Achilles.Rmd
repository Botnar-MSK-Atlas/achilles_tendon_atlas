---
title: "Pseudobulk results visualisation"
author: "Carla Cohen"
date: "`r Sys.Date()`"
output: html_document
---

A script to visualise the results of the Pseudobulk/DEseq2-LRT test on Achilles data. 
This script is specifically to use the results wiht only 1 fibroblast group in the Achilles object. 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(cowplot)
library(svglite)

# make a new output folder for each run, with the date & time in the directory name
date <- Sys.Date() %>% str_replace_all("-", "")
time <- format(Sys.time(), "%X") %>% str_replace_all(":", "-") %>%
    str_sub(1, 5)
directory <- paste0(date,"_", time, "_Pseudobulk_visualisation.dir")
dir.create(directory, showWarnings = FALSE)

# microanatomy colours
Okabe_Ito <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000000")
ma.cols <-  c(Enth = Okabe_Ito[3], MB = Okabe_Ito[5], MTJ = Okabe_Ito[6], muscle = Okabe_Ito[7])

tol_muted <- c("#CC6677", "#332288", "#DDCC77", "#117733", "#88CCEE", "#882255", "#44AA99", "#999933", "#AA4499", "#DDDDDD")

# results directory
results_directory <- "20240515_14-31_Pseudobulk.dir"
```

How many DE genes were in each cell type compared to Enthesis?

```{r}
DE_Enth <- read.table(paste0(results_directory, "/DEseq2_results/Enth_results_summary.txt"), 
                       
                      header = TRUE, sep= "\t")
DE_Enth
```

```{r}
# pivot longer
DE_Enth.long <- DE_Enth %>% pivot_longer(3:5, values_to = "count", names_to = "type")
# merge column for cell annotation & comparison
DE_Enth.long <- DE_Enth.long %>% mutate (cell_annotation_comparison = paste(cell_annotation, comparison, sep = "_"))
DE_Enth.long

DE_Enth.long$cell_annotation_comparison <- factor(DE_Enth.long$cell_annotation_comparison, 
                                 levels = c("Fibroblast_MBvsEnth", "Fibroblast_MTJvsEnth", "Fibroblast_musclevsEnth", 
                                            "Fasttwitch_MBvsEnth", "Fasttwitch_MTJvsEnth", "Fasttwitch_musclevsEnth", 
                                            "Slowtwitch_MBvsEnth", "Slowtwitch_MTJvsEnth", "Slowtwitch_musclevsEnth" , 
                                            "Adipocyte_MBvsEnth", "Adipocyte_MTJvsEnth", "Adipocyte_musclevsEnth",
                                            "VEC_MBvsEnth", "VEC_MTJvsEnth", "VEC_musclevsEnth", 
                                            "LEC_MBvsEnth", "LEC_MTJvsEnth", "LEC_musclevsEnth", 
                                            "Mural_MBvsEnth", "Mural_MTJvsEnth", "Mural_musclevsEnth", 
                                            "Granulocytes_MBvsEnth", "Granulocytes_MTJvsEnth", "Granulocytes_musclevsEnth", 
                                            "Macrophages_MBvsEnth", "Macrophages_MTJvsEnth", "Macrophages_musclevsEnth", 
                                            "Tcells_MBvsEnth", "Tcells_MTJvsEnth", "Tcells_musclevsEnth")
)

```

```{r, fig.width=12, fig.height=6}
comparison.cols <-  c(tol_muted[2], tol_muted[4], tol_muted[6])
ggplot(DE_Enth.long, aes(x = cell_annotation_comparison, y = count))+
    geom_point(aes(colour = comparison, shape = type), size = 3)+
    theme_bw()+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
    scale_colour_manual(values = c("MBvsEnth" = comparison.cols[1], "MTJvsEnth" = comparison.cols[2], "musclevsEnth"=comparison.cols[3]))+
    theme(axis.title.x = element_blank())+
    ylab("Number of differentially expressed genes")+
    theme(axis.text.y = element_text(size = 12, colour = "black"))+
    theme(axis.title.y = element_text(size = 12, colour = "black"))
ggsave(paste0(directory, "/Number_DEgenes_vs_Enth.png"), width = 12, height = 6)
ggsave(paste0(directory, "/Number_DEgenes_vs_Enth.svg"), width = 12, height = 6)
```

```{r, fig.width=12, fig.height=6}
# plot with no labels
ggplot(DE_Enth.long, aes(x = cell_annotation_comparison, y = count))+
    geom_point(aes(colour = comparison, shape = type), size = 3)+
    theme_bw()+
    theme(axis.text.x = element_blank())+
    scale_colour_manual(values = c("MBvsEnth" = comparison.cols[1], "MTJvsEnth" = comparison.cols[2], "musclevsEnth"=comparison.cols[3]))+
    theme(axis.title.x = element_blank())+
    theme(axis.text.y = element_blank())+
    theme(axis.title.y = element_blank())+
    theme(legend.position="none")
ggsave(paste0(directory, "/Number_DEgenes_vs_Enth_nolabel.png"), width = 12, height = 5)
ggsave(paste0(directory, "/Number_DEgenes_vs_Enth_nolabel.svg"), width = 12, height = 5)
```


Plot only total number of DE genes

```{r, fig.width=12, fig.height=6}
ggplot(DE_Enth.long %>% filter(type=="Total.DEGs"), aes(x = cell_annotation_comparison, y = count))+
    geom_point(aes(colour = comparison, shape = type), size = 3)+
    theme_bw()+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
    scale_colour_manual(values = c("MBvsEnth" = comparison.cols[1], "MTJvsEnth" = comparison.cols[2], "musclevsEnth"=comparison.cols[3]))+
    theme(axis.title.x = element_blank())+
    ylab("Number of differentially expressed genes")+
    theme(axis.text.y = element_text(size = 12, colour = "black"))+
    theme(axis.title.y = element_text(size = 12, colour = "black"))
ggsave(paste0(directory, "/Total_Number_DEgenes_vs_Enth.png"), width = 12, height = 6)
ggsave(paste0(directory, "/Total_Number_DEgenes_vs_Enth.svg"), width = 12, height = 6)
```




How many DE genes were in each cell type compared to MTJ?

```{r}
DE_MTJ <- read.table(paste0(results_directory, "/DEseq2_results/MTJ_results_summary.txt"), 
                       
                      header = TRUE, sep= "\t")
DE_MTJ
```

```{r}
# pivot longer
DE_MTJ.long <- DE_MTJ %>% pivot_longer(3:5, values_to = "count", names_to = "type")
# merge column for cell annotation & comparison
DE_MTJ.long <- DE_MTJ.long %>% mutate (cell_annotation_comparison = paste(cell_annotation, comparison, sep = "_"))
DE_MTJ.long

DE_MTJ.long$cell_annotation_comparison <- factor(DE_MTJ.long$cell_annotation_comparison, 
                                 levels = c("Fibroblast_EnthvsMTJ", "Fibroblast_MBvsMTJ", "Fibroblast_musclevsMTJ",
                                            "Fasttwitch_EnthvsMTJ", "Fasttwitch_MBvsMTJ", "Fasttwitch_musclevsMTJ", 
                                            "Slowtwitch_EnthvsMTJ", "Slowtwitch_MBvsMTJ", "Slowtwitch_musclevsMTJ",
                                            "Adipocyte_EnthvsMTJ", "Adipocyte_MBvsMTJ", "Adipocyte_musclevsMTJ", 
                                            "VEC_EnthvsMTJ", "VEC_MBvsMTJ", "VEC_musclevsMTJ", 
                                            "LEC_EnthvsMTJ", "LEC_MBvsMTJ", "LEC_musclevsMTJ", 
                                            "Mural_EnthvsMTJ", "Mural_MBvsMTJ", "Mural_musclevsMTJ", 
                                            "Granulocytes_EnthvsMTJ","Granulocytes_MBvsMTJ", "Granulocytes_musclevsMTJ", 
                                            "Macrophages_EnthvsMTJ", "Macrophages_MBvsMTJ" , "Macrophages_musclevsMTJ", 
                                            "Tcells_EnthvsMTJ", "Tcells_MBvsMTJ", "Tcells_musclevsMTJ"))

```

```{r, fig.width=12, fig.height=6}
ggplot(DE_MTJ.long, aes(x = cell_annotation_comparison, y = count))+
    geom_point(aes(colour = comparison, shape = type), size = 3)+
    theme_bw()+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
    scale_colour_manual(values = c("EnthvsMTJ" = comparison.cols[1], "MBvsMTJ" = comparison.cols[2], "musclevsMTJ"=comparison.cols[3]))+
    theme(axis.title = element_blank())+
    ylab("Number of differentially expressed genes")+
    theme(axis.text.y = element_text(size = 12, colour = "black"))+
    theme(axis.title.y = element_text(size = 12, colour = "black"))
ggsave(paste0(directory, "/Number_DEgenes_vs_MB.png"), width = 12, height = 6)
ggsave(paste0(directory, "/Number_DEgenes_vs_MB.svg"), width = 12, height = 6)
```
Plot the cluster results

```{r}
fibroblast_cluster <- readRDS(paste0(results_directory, "/Cluster_results/Fibroblast_cluster_results.rds"))
fibroblast_cluster_plot <- readRDS(paste0(results_directory, "/Cluster_results/Fibroblast_plot.rds"))
fibroblast_cluster_plot +
            theme_classic()+
            theme(legend.position = "none")+
            #scale_colour_viridis_d(begin = 0.3)+
            scale_colour_manual(values = "#515154")+
            ggtitle("Fibroblast")


ggsave(paste0(directory, "/Fibroblast_clusters.png"), width = 10, height = 7)
ggsave(paste0(directory, "/Fibroblast_clusters.svg"), width = 10, height = 7)
```
# Visualise pathway analysis results
20240524_12-04_Pathway_Analysis.dir


```{r}
fibroblast_upregulated <- readRDS("20240524_12-49_Pathway_Analysis.dir/Results/Upregulated_GOBP_custom_cell/Fibroblast.RDS")
fibroblast_downregulated <- readRDS("20240524_12-49_Pathway_Analysis.dir/Results/Downregulated_GOBP_custom_cell/Fibroblast.RDS")
fibroblast_tendon <- readRDS("20240524_12-49_Pathway_Analysis.dir/Results/Tendon_high_GOBP_custom_cell/Fibroblast.RDS")
fibroblast_muscle <- readRDS("20240524_12-49_Pathway_Analysis.dir/Results/muscle_high_GOBP_custom_cell/Fibroblast.RDS")

fibroblast_upregulated_filtered <- fibroblast_upregulated@result %>% 
            filter(p.adjust < 0.05) %>% 
            arrange(desc(p.adjust))
fibroblast_upregulated_filtered$condition <- "upregulated"

fibroblast_downregulated_filtered <- fibroblast_downregulated@result %>% 
            filter(p.adjust < 0.05) %>% 
            arrange(desc(p.adjust))
fibroblast_downregulated_filtered$condition <- "downregulated"

fibroblast_tendon <- fibroblast_tendon@result %>% 
            filter(p.adjust < 0.05) %>% 
            arrange(desc(p.adjust))
fibroblast_tendon$condition <- "tendon_high"

fibroblast_muscle <- fibroblast_muscle@result %>% 
            filter(p.adjust < 0.05) %>% 
            arrange(desc(p.adjust))
# fibroblast_muscle$condition <- "tendon_high" NO SIGNIFICAN PATHWAYS

fibroblast_results <- bind_rows(fibroblast_upregulated_filtered, fibroblast_downregulated_filtered, fibroblast_tendon)

filtered_res <- fibroblast_results %>% 
            mutate(new_col = -log10(p.adjust)) %>% 
            group_by(condition) %>% 
            slice_min(order_by = p.adjust, n = 10) %>% 
            select(ID, GeneRatio, p.adjust, Count, condition, new_col)

# make condition a factor
filtered_res$condition <- factor(filtered_res$condition, levels = c("upregulated", "downregulated", "tendon_high"))


# make IDs a factor
pathways <- as.data.frame(sort(table(filtered_res$ID)))
colnames(pathways) <- c("ID", "pathway_freq")
filtered_res <- filtered_res %>% 
    left_join(pathways) %>%
    group_by(pathway_freq) %>%
    arrange(condition)
filtered_res$ID <- factor(filtered_res$ID, levels = rev(unique(filtered_res$ID))) 



ggplot(filtered_res, aes(x = condition, y = ID, size = Count, colour = new_col)) +
            geom_point()+
            #scale_colour_viridis()+
            theme_bw()+
            theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
            theme(axis.title.x = element_blank())+
            theme(axis.title.y = element_blank())+
            labs(colour = "-log10(p.adj)")+
            scale_y_discrete(position = "right")

ggsave(paste0(directory, "/Fibroblast_pathways.png"), width = 8, height = 6, bg = "white")
ggsave(paste0(directory, "/Fibroblast_pathways.svg"), width = 8, height = 6, bg = "white")

```




