---
title: "Immune fine annotation"
author: "Carla Cohen"
date: "`r Sys.Date()`"
output: html_document
---
# Immune annotation  
A script to perform fine annotation of the immune subsets in the Achilles data.

This script follows the scVI integration of the whole Achilles dataset, subsetting of immune cells, then reintegration with scVI. 

Preliminary analysis of the clustering and multiple resolutions was performed: 20250128_13-38_Subset_Immune.dir
This produced lists of DE genes and heatmaps. 

Now we need to perform fine annotation to see whether the immune subsets have any biological meaning. 

This script is for scVI louvain at res 1.6

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r}
library(tidyverse)
library(Seurat)
library(cowplot)
library(viridis)
library(scales)
library(readxl)
library(scDotPlot)
library(SingleCellExperiment)
library(ggsci)
library(data.table)
library(clustree)

# set the resolution for the script
resolution <- 1.6
clustering <- "louvain"

# make a new output folder for each run, with the date & time in the directory name
date <- Sys.Date() %>% str_replace_all("-", "")
time <- format(Sys.time(), "%X") %>% str_replace_all(":", "-") %>%
    str_sub(1, 5)
directory <- paste0(date,"_", time, "_Fine_annotation_immune_", resolution, ".dir")
dir.create(directory, showWarnings = FALSE)
dir.create(paste0(directory, "/Marker_dotplots/"))
dir.create(paste0(directory, "/Annotation_figures/"))
dir.create(paste0(directory, "/Feature_Plots"))
dir.create(paste0(directory, "/Top_20_Dotplots"))


# microanatomy colours
Okabe_Ito <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000000")
ma.cols <-  c(Enth = Okabe_Ito[3], MB = Okabe_Ito[5], MTJ = Okabe_Ito[6], muscle = Okabe_Ito[7])
```

Read in the Achilles subset immune object. 

```{r}
so.immune <- readRDS("20250128_13-38_Subset_Immune.dir/RDS_objects.dir/Achilles_Immune_subset.rds")
```


# Resolution 1.6

Annotation at resolution 1.6

Select a resolution and set seurat clusters to that resolution 


```{r} 
so.immune[["seurat_clusters"]] <- so.immune[[paste0(clustering, "_X_scVI_snn_res.", resolution)]]
Idents(so.immune) <- so.immune$seurat_clusters
levels(Idents(so.immune))
```

## Plot the UMAP at the chosen resolution  

```{r, fig.width=8, fig.height=6}
DimPlot(object = so.immune, label = TRUE, reduction = "umap", shuffle = TRUE)+
    ggtitle(paste0("Muscle UMAP at resolution ", resolution))
ggsave(paste0(directory, "/Annotation_figures/Unlabelled_UMAP_", resolution, ".png"), 
       width = 6, height = 5, bg = "white")
```



UMAP split by microanatomy

```{r, fig.height=8, fig.width=8}
p <- DimPlot(object = so.immune, label = TRUE, reduction = "umap", shuffle = TRUE, 
             split.by = "microanatomical_site", ncol = 2)+
    ggtitle(paste0("Muscle UMAP split my microanatomy at resolution ", resolution))
ggsave(paste0(directory, "/Annotation_figures/UMAP_by_microanatomy_", resolution, ".png"), 
       width = 8, height = 8, bg = "white")
p
```

> Take home from microanatomy

Overall maybe slightly fewer immune cells in muscle.

Bar chart of cell composition

```{r}

df <- so.immune[[]] %>% select(seurat_clusters, microanatomical_site)

#library(data.table)
df <- data.table(df)
df <- df[, .(COUNT = .N), by = names(df)]

ggplot(df, aes(fill=microanatomical_site, y=COUNT, x=seurat_clusters)) + 
    geom_bar(position="fill", stat="identity")+
    theme_classic()+
    scale_fill_manual(values = ma.cols)

ggsave(paste0(directory, "/Annotation_figures/Cluster_fraction_microanatomy.png"), 
       width = 8, height = 6, bg = "white")
```


### UMAP split by patient

```{r, fig.height=8, fig.width=10}
DimPlot(object = so.immune, reduction = "umap", shuffle = TRUE, 
             split.by = "patient", ncol = 3, label = TRUE)+
    theme(panel.background = element_rect(colour = "black", linewidth = 1))+
    ggtitle(paste0("UMAP split by patient at resolution ", resolution))
ggsave(paste0(directory, "/Annotation_figures/UMAP_patient.png"), 
       width = 10, height = 7, bg = "white")
```

### UMAP split by patient - each cluster separately

```{r, fig.height=6, fig.width=8}
# set the colours
colours <- hue_pal()(length(levels(Idents(so.immune))))
names(colours) <- levels(Idents(so.immune))

for (cluster_id in levels(Idents(so.immune))){
    #print(cluster_id)
    so.subset <- subset(so.immune, idents = cluster_id)
    DimPlot(so.subset, label = TRUE, reduction = "umap", shuffle = TRUE, 
             split.by = "patient", ncol = 3, cols = colours)+
    ggtitle(paste0("UMAP cluster ", cluster_id, " per patient res ", resolution))
    ggsave(paste0(directory, "/Annotation_figures/UMAP_cluster_", cluster_id, "_by_patient_", resolution, ".png"), 
       width = 8, height = 6, bg = "white")
}


```

All clusters contain cells from all patients. 

### What % of nuclei are from each patient?

```{r}
# make a df of patient percentages per cluster
df <- so.immune[[]] %>% select(seurat_clusters, patient)
df$seurat_clusters <- as.character(df$seurat_clusters)
df <- data.table(df)
df <- df[, .(COUNT = .N), by = names(df)]
df2 <- df %>% pivot_wider(names_from = patient, values_from = COUNT, values_fill = 0) %>% 
    column_to_rownames(var = "seurat_clusters")%>%
    mutate_at(vars(1:5), as.numeric) 

df2$my_row_sum <- rowSums(df2)
df2 <- df2 %>% mutate(across(where(is.numeric), ~ .x/my_row_sum*100)) # need to make columns numeric?
df2$my_row_sum <- NULL
df2$seurat_clusters <- rownames(df2)

df2

# plot as bar chart and heatmap
df3 <- df2 %>% pivot_longer(1:5, names_to = "patient", values_to = "proportion")

ggplot(df3, aes(fill=patient, y=proportion, x=seurat_clusters)) + 
    geom_bar(position="stack", stat = "identity")+
    theme_classic()
ggsave(paste0(directory, "/Annotation_figures/Patient_proportion_barchart_", resolution, ".png"), 
       width = 8, height = 6, bg = "white")

ggplot(df3, aes(y=seurat_clusters, x=patient, fill = proportion))+
    geom_tile()+
    scale_fill_viridis()
ggsave(paste0(directory, "/Annotation_figures/Patient_proportion_heatmap_", resolution, ".png"), 
       width = 8, height = 6, bg = "white")


```

Cluster 11 has > 90% cells from MSK1687 so will need to be merged with another cluster or interpreted with caution. 
This was missed previously. 

### UMAP split by patient with lower res annotation

```{r, fig.height=8, fig.width=14}
DimPlot(object = so.immune, reduction = "umap", shuffle = TRUE, 
             split.by = "patient", ncol = 3, group.by = "broad_annotation")+
    theme(panel.background = element_rect(colour = "black", linewidth = 1))+
    ggtitle("Muscle UMAP split by patient broad annotation")
ggsave(paste0(directory, "/Annotation_figures/UMAP_patient_broad_annotation.png"), 
       width = 14, height = 7, bg = "white")


```

```{r}
DimPlot(object = so.immune, reduction = "umap", shuffle = TRUE, 
             group.by = "broad_annotation")
ggsave(paste0(directory, "/Annotation_figures/UMAP_patient_broad_annotation.png"), 
       width = 14, height = 7, bg = "white")
```

### How many cells are there per cluster?

```{r}
cell_numbers <- table(Idents(so.immune)) %>% as.data.frame()
colnames(cell_numbers) <- c("cluster", "frequency")
cell_numbers
```
```{r}
ggplot(cell_numbers, aes(x = cluster, y = frequency))+
    geom_bar(stat = "identity")+
    theme_cowplot()+
    ggtitle("Number of cells per cluster")
ggsave(paste0(directory, "/Annotation_figures/Number_cells_per_cluster_", resolution, ".png"), 
       width = 6, height = 4, bg = "white")
```

 
### Visualise QC metrics 

```{r, message = FALSE, fig.width=10, fig.height=18}
p1 <- VlnPlot(so.immune, features = "sum", assay = "RNA", pt.size = 0)+
    scale_y_log10() +
    scale_fill_viridis_d()+
    theme(legend.position="none")+
    theme_cowplot()+
    ggtitle("nCounts")

p2 <- VlnPlot(so.immune, features = "detected", assay = "RNA", pt.size = 0)+
    scale_y_log10() +
    scale_fill_viridis_d()+
    theme(legend.position="none")+
    theme_cowplot()+
    ggtitle("nFeatures")

p3 <- VlnPlot(so.immune, features = "subsets_mito_percent", assay = "RNA", pt.size = 0)+
    scale_fill_viridis_d()+
    theme(legend.position="none")+
    theme_cowplot()+
    ggtitle("Percent mitochondrial reads")

p4 <- VlnPlot(so.immune, features = "decontX_contamination", assay = "RNA")+
    scale_fill_viridis_d()+
    theme(legend.position="none")+
    theme_cowplot()+
    ggtitle("decontX score")

p5 <- VlnPlot(so.immune, features = "percent.ribo", assay = "RNA")+
    scale_fill_viridis_d()+
    theme(legend.position="none")+
    theme_cowplot()+
    ggtitle("Percent ribosomal")

p <- plot_grid(p1, p2, p3, p4, p5, ncol = 1)

ggsave(paste0(directory, "/Annotation_figures/QC_metrics_across_clusters.png"), 
       p, width = 10, height = 18, bg = "white")
p

```

13 and 17 have the most ambient  

Plot QC metrics on UMAP

```{r, fig.height=12, fig.width=10, message = FALSE}
p1<- FeaturePlot(so.immune, features = "sum", reduction = "umap")+ggtitle ("nCounts")+
    scale_color_continuous(type = "viridis", limits = c(0,10000))
p2<- FeaturePlot(so.immune, features = "detected", reduction = "umap") + ggtitle("nFeatures")+
    scale_color_continuous(type = "viridis", limits = c(0,5000))
p3<- FeaturePlot(so.immune, features = "subsets_mito_percent", reduction = "umap") + ggtitle ("Percent mito reads")+
    scale_color_continuous(type = "viridis")
p4<- FeaturePlot(so.immune, features = "decontX_contamination", reduction = "umap")+
    scale_colour_gradientn(colours = viridis(256, option = "D"), name = "decontX score")+
        ggtitle("decontX_contamination")
p5 <- FeaturePlot(so.immune, features = "percent.ribo", reduction = "umap")+
    scale_colour_gradientn(colours = viridis(256, option = "D"), name = "percent.ribo")+
        ggtitle("Percent ribosomal")
p <- plot_grid(p1, p2, p3, p4, p5, ncol = 2)

ggsave(paste0(directory, "/Annotation_figures/QC_metrics_UMAP.png"), 
       p, width = 10, height = 12, bg = "white")
p

```


### FindMarkers

Read in the markers calculated by the script "Immune_subset_recluster.Rmd" from 20241218_12-18_Subset_Immune.dir

```{r, message = FALSE}
markers <- read.table(paste0("20250128_13-38_Subset_Immune.dir/Marker_lists/Markers_", clustering, "_X_scVI_snn_res.", resolution, ".txt"), 
                sep = "\t")

```


### Plot groups of known markers

These groups of markers are defined from the literature

Define the plotting function

```{r}
plot_dotplot <- function (so, genes, category, resolution, fig_width = 7, fig_height = 7){
    p <- DotPlot(so, 
             features = genes,
             assay = "soupX") + 
    scale_colour_viridis(direction = -1) +
    ggtitle(paste0(category, " markers: resolution ", resolution)) + 
    theme(plot.title = element_text(size = 14, face = "bold"))+
    coord_flip()
    
    ggsave(paste0(directory, "/Marker_dotplots/", category, "_", resolution, ".png"), bg = "white")
    p
}


```

###  general markers

```{r, fig.width=10, fig.height=12}
general_markers <- c("COL1A1", "COL1A2", "COL3A1", "DCN",
              "HMCN1", "NEGR1", "DCLK1", "KAZN", "BICC1", "PRICKLE1",
              "CLU", "COMP", "MMP3", "NOVA1", "CILP", "FBLN1", "PRG4",
              "F13A1", "CD163", "MRC1", "MSR1",
              "PECAM1", "PTPRB", "FLT1", "VWF",
              "NOTCH3", "PDGFRB", "MYO1B",
              "TRDN", "TTN", "NEB", "TNNT1", "LGR5", "ATP2A2",
              "PLIN1", "AQP7", "ADIPOQ",
              "CD247", "SKAP1", "THEMIS",
              "TNNT3", "MYH1", "MYH3",
              "POSTN", "CSMD2", "ADAM12", "FN1", "CEMIP",
              "HLA-DRA", "CD86", "CD74",
              "ASPM", "DIAPH3", "TOP2A",
              "MMRN1", "PROX1", "PKHD1L1",
              "FCN1", "LYZ", "AOAH",
              "BCL11A", "CUX2", "CLEC4C",
              "TENM2", "PTCH2", "APOD", "CNTN4", "ABCA10",
               "KIT", "CPA3", "IL18R1",
              "AK5", "ACP5", "MMP9")
plot_dotplot(so.immune, general_markers, "general", resolution, fig_width = 10, fig_height = 12)
```

## My Immune markers

```{r, fig.width=12, fig.height=12}
plot_immune_dotplots <- function (so, resolution){
    
    p1 <- DotPlot(so, 
             features =c("PTPRC", "CD247","IL7R", "CCR7", "THEMIS"),
             assay = "soupX") + 
    scale_colour_viridis(direction = -1) +
    ggtitle("T cell markers") + 
    coord_flip()
    
    p2 <- DotPlot(so, 
             features =c("MS4A1", "CD37", "BLNK", "CD38", "CD79A", "CD79B", "SDC1", "CD27", "CD78"),
             assay = "soupX") + 
    scale_colour_viridis(direction = -1) +
    ggtitle("B cell markers") + 
    coord_flip()
    
    p3 <- DotPlot(so, 
             features =c("CD14", "CD163", "CD163L1", "MERTK", "MRC1", "MSR1"),
             assay = "soupX") + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Macrophage markers") + 
    coord_flip()
    
    p4 <- DotPlot(so, 
             features =c("CD300A", "IRF7", "CLEC4C", "IL3RA", "NRP1", "HLA-DQA1", "CD74", "GPAT3", "CIITA", "HLA-DRB1"),
             assay = "soupX") + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Dendritic cell markers") + 
    coord_flip()
    
    p5 <- DotPlot(so, 
             features =c("KIT", "CDK15", "MS4A2", "IL18R1", "HPGD"),
             assay = "soupX") + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Granulocyte_markers") + 
    coord_flip()
    
    p6 <- DotPlot(so, 
             features =c("CD14", "VCAN", "NCF1", "MS4A6A", "FCN1",  # classical monocyte
                         "FCGR3A", "LST1", "RPS19", "MS4A7", "CSF1R", "CDKN1C", "LILRB2", "ITGAL"), #non-classical monocytes
             assay = "soupX") + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Monocyte_markers") + 
    coord_flip()
    
    #add an overall title and arrange the graphs on one page
    title <- ggdraw() + draw_label(paste0("Immune cell markers at resolution ", resolution), fontface='bold', size = 16)
    p <- plot_grid(p1, p2, p3, p4, p5, p6, ncol = 2)
    p <- plot_grid(title, p, ncol=1, rel_heights=c(0.05, 1))
    
    p

    
}

plot_immune_dotplots(so.immune, resolution)
ggsave(paste0(directory, "/Marker_dotplots/dotplot_immune_cell_markers_0.2.png"), 
       width = 12, height = 12, 
       bg = "white")
```

Jolet's immune markers

```{r, fig.width=16, fig.height=8}

immune_markers <- list ("T cells" = c("CD247", "SKAP1", "IL7R", "THEMIS", "ANK3"), 
                        "VCANhi DCs/mon" = c("VCAN", "FCN1", "LYZ"), 
                        "DCs" = c("HLA-DPB1", "HLA-DPA1", "HLA-DQA1", "HLA-DRA", "HLA-DRB1"), 
                        "CLEC10A DCs" = c("CLEC10A", "CD1C", "FCER1A", "IL1R2"),
                        "CLEC9Ahi DCs" = c("CLEC9A", "CADM1", "IDO1", "CLNK", "ZNF366"),
                        "NK cells" = c("NCAM1", "GNLY", "KLRD1", "CCL5", "MCTP2"),
                        "pDCs" = c("CLEC4C", "BCL11A", "CUX2", "IRF8", "PLAC8"),
                        "Granulocytes" = c("KIT", "CPA3", "IL18R1", "MS4A2", "GATA2"),
                        "Osteoclasts" = c("SPP1", "MMP9", "ACP5", "SIGLEC15", "AK5"), 
                        "B cells" = c("MS4A1", "CD37", "BLK", "FCRL1", "IGHM"), 
                        "Plasma cells" = c("CD38", "CD79A", "CD79B", "SDC1", "CD27")
                        )

macrophage_markers <- list ("MERTKhi LYVE1hi macrophages" = c("CD14", "CD163", "F13A1", "STAB1", "MERTK", "MRC1", "TLR2", "FGF13",  "SELENOP", "PDE4D", "NAV2", "ABCA6", "LYVE1", "MARCO"), 
                            "MERTKhi LYVE1lo macrophages" = c("CTSL", "CTSB", "TPRG1", "HMOX1", "ELL2", "CXCL2", "CXCL3", "CXCL8"),
                            "MERTKlo PTPRGhi macrophages" = c("PTPRG", "MIR99AHG", "PARD3", "KAZN",  "IFI44L"), 
                            "Dividing cells"= c("ASPM", "DIAPH3", "TOP2A", "RRM2", "CENPE")
)

DotPlot(so.immune, macrophage_markers, assay = "soupX")+
    scale_colour_viridis(direction = -1) +
    ggtitle(paste0("Immune markers: resolution ", resolution)) + 
    theme(plot.title = element_text(size = 14, face = "bold"))+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

DotPlot(so.immune, immune_markers, assay = "soupX")+
    scale_colour_viridis(direction = -1) +
    ggtitle(paste0("Immune markers: resolution ", resolution)) + 
    theme(plot.title = element_text(size = 14, face = "bold"))+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

```{r, fig.height=16, fig.width=16}
plot_muscle_markers <- function (so, resolution){
    p1 <- DotPlot(so, 
             features =c("TRDN", "DES", "ACTN2"),
             assay = "soupX") + 
    scale_colour_viridis(direction = -1) +
    ggtitle("General Muscle markers") + 
    coord_flip()
    
    p2 <- DotPlot(so, 
             features =c("TNNC2", "TNNI2", "TNNT3", "ACTN3", "HOMER1", "KCNQ5", "MYH1", "MYH3", "MYLK4", "MYBPC2"),
             assay = "soupX") + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Fast twitch markers") + 
    coord_flip()
    
    p3 <- DotPlot(so, 
             features =c("COL22A1", "ADAMTSL1", "CPM", "CSMD1", "FRAS1", "PZP", "RALYL", "SAMD5", "SORBS2", "SPAG16"),
             assay = "soupX") + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Transitional markers") + 
    coord_flip()
    
    p4 <- DotPlot(so, 
             features =c("TNNC1", "TNNI1", "TNNT1", "ATP2A2", "CCR3", "LGR5", "MYH7", "MYH7B", "NEK10", "TECRL"),
             assay = "soupX") + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Slow twitch markers") + 
    coord_flip()
    
    p5 <- DotPlot(so, 
             features =c("ACTA2", "MYH11", "TAGLN", "CRIP2", "MYL9", "RTL8C", "RERGL", "PLAC9", "MFAP4", "LGALS3BP"),
             assay = "soupX") + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Smooth muscle markers") + 
    coord_flip()
    
    p6 <- DotPlot(so, 
             features =c("PAX7", "CALCR", "CDH4", "CLCN5", "CTNND2", "GREM1"),
             assay = "soupX") + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Satellite cells markers") + 
    coord_flip()
        
 
    #add an overall title and arrange the graphs on one page
    title <- ggdraw() + draw_label(paste0("Muscle cell markers at resolution ", resolution), fontface='bold', size = 16)
    p <- plot_grid(p1, p2, p3, p4, p5, p6, nrow = 3)
    p <- plot_grid(title, p, ncol=1, rel_heights=c(0.05, 1))
    
    p
}

plot_muscle_markers(so.immune, resolution)
ggsave(paste0(directory, "/Marker_dotplots/Muscle_markers.png"), width = 16, height = 16, bg = "white")

```

Cluster 17 is slow twitch muscle

```{r, fig.width=16, fig.height=16}
plot_dotplots <- function (so, resolution){
    
    p1 <- DotPlot(so, 
             features =c("COL1A1", "COL1A2", "COL3A1", "COL3A2",  "DCN", "PRG4"),
             assay = "soupX") + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Fibroblast markers") + 
    coord_flip()
    
    p2 <- DotPlot(so,
             features =c("PECAM1", "PTPRB", "VWF", "ADGRL4", "CD34", "CDH5", "FLT1", "NOTCH4", "TEK"),
             assay = "soupX")  + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Vascular endothelial markers") + coord_flip()
    
    p3 <- DotPlot(so,
             features =c("EPHB4", "FLT4", "KDR", "LYVE1", "MMRN1", "NRG3", "PKHD1L1", "PROX1"),
             assay = "soupX")  + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Lymphatic endothelium markers") + coord_flip()
    
    p4 <- DotPlot(so, 
             features =c("TRDN", "DES", "ACTN2", "TNNC2", "TNNI2", "TNNT3", "TNNC1", "TNNI1", "TNNT1"),
             assay = "soupX")  + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Skeletal muscle markers") + 
    coord_flip()
    
    p5 <- DotPlot(so, 
             features =c("ABCA8", "COL15A1", "CD55", "DCLK1", "ELN", "FBN1", "FBLN1", 
                         "FBLN2", "FBLN5", "KCND2", "NEGR1", "NOVA1", "PDGFRA", "VIT"),
             assay = "soupX")  + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Mural cell markers") + 
    coord_flip()
    
   p6 <- DotPlot(so, 
             features =c("GPAM", "TMEM132C", "PLIN1", "PLIN4", "AQP7", "ADIPOQ", "PDE3B", "FABP4", "LIPE"),
             assay = "soupX") + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Adipocyte markers") + 
    coord_flip()
    
    p7 <- DotPlot(so, 
             features =c("NTRK3", "TENM2", "KANK4", "SLC2A1", "SLC22A3", "CLDN1"),
             assay = "soupX") + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Nerve-like cell markers") + 
    coord_flip()
    
    p8 <- DotPlot(so, 
             features =c("PAX7", "CALCR", "CDH4", "CLCN5", "CTNND2", "GREM1"),
             assay = "soupX") + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Satellite cell markers") + 
    coord_flip()

    #add an overall title and arrange the graphs on one page
    title <- ggdraw() + draw_label(paste0("Cell markers at resolution ", resolution), fontface='bold', size = 16)
    p <- plot_grid(p1, p2, p3, p4, p5, p6, p7, p8, ncol = 2)
    p <- plot_grid(title, p, ncol=1, rel_heights=c(0.05, 1))
    
    p
    
    
}

plot_dotplots(so.immune, resolution)
```

Cluster 13 might be ambient

## Feature plots

Cluster 15 seems to have markers for osteoclasts and MERTKhi LYVE1lo macrophages. 

#### Osteoclast markers

```{r, fig.width=12, fig.height=8}
FeaturePlot(subset(so.immune, idents = 15), features = c("SPP1", "MMP9", "ACP5", "SIGLEC15", "AK5"), reduction = "umap", ncol = 3, label = TRUE)
```


#### MERTKhi LYVE1lo macrophages

```{r, fig.width=12, fig.height=12}
FeaturePlot(subset(so.immune, idents = 15), 
            features = c("CTSL", "CTSB", "TPRG1", "HMOX1", "ELL2", "CXCL2", "CXCL3", "CXCL8"), reduction = "umap", ncol = 3, label = TRUE)

```

Doesn't seem like these are two seperate clusters. The osteoclast markers are less well represented so more likely macrophages. 


Cluster 13 has markers for endothelium and MERTKlo PTPRGhi macrophages, and fibroblasts

#### Endothelium

```{r, fig.width=12, fig.height=12}
FeaturePlot(subset(so.immune, idents = 13), 
            features = c("PECAM1", "PTPRB", "VWF", "ADGRL4", "CD34", "CDH5", "FLT1", "NOTCH4", "TEK"), reduction = "umap", ncol = 3, label = TRUE)

```
### MERTKlo PTPRGhi macrophages

```{r, fig.width=12, fig.height=8}
FeaturePlot(subset(so.immune, idents = 13), 
            features = c("PTPRG", "MIR99AHG", "PARD3", "KAZN",  "IFI44L"), reduction = "umap", ncol = 3, label = TRUE)

```

Cycling cells


```{r, fig.width=12, fig.height=8}
FeaturePlot(subset(so.immune, idents = 13), 
            features = c("ASPM", "DIAPH3", "TOP2A", "RRM2", "CENPE"), reduction = "umap", ncol = 3, label = TRUE)

```

Call them MERTKlo PTPRGhi macrophages



### T cells
Which genes distinguish clusters 3, 8 and 10? (T cells)

```{r}

so.t_cells <- subset(so.immune, idents = c("3", "8", "10"))

markers_T <- FindAllMarkers(so.t_cells, assay = "soupX",
                            only.pos = TRUE, 
                            min.pct = 0.25, 
                            logfc.threshold = 0.25
                        )

markers_T_top10 <-  markers_T %>% 
        slice_max(n=20, order_by = abs(avg_log2FC))

DoHeatmap(so.t_cells, features = markers_T_top10$gene,
                   assay = "soupX") + 
            scale_fill_viridis()

``` 

These clusters do no seem to be  biologically distinct. Merge and call them all T cells. 


### Macrophages

Which genes distinguish clusters 0, 1, 2, 4, 6, 7? (MERTKhi LYVE1hi macrophages)

```{r}

so.mac <- subset(so.immune, idents = c("0", "1", "2", "4", "6", "7"))

markers_mac <- FindAllMarkers(so.mac, assay = "soupX",
                            only.pos = TRUE, 
                            min.pct = 0.25, 
                            logfc.threshold = 0.25
                        )

markers_mac_top10 <-  markers_T %>% 
        slice_max(n=20, order_by = abs(avg_log2FC))

DoHeatmap(so.mac, features = markers_mac_top10$gene,
                   assay = "soupX") + 
            scale_fill_viridis()

``` 

Ditto, these are indistinct

## Identities
Do some preliminary naming and merge idents 0,1 2, 4, 6, 7 (macrophages) and 3, 8, 10 (T cells)

0 - MERTKhi LYVE1hi macrophages
1 - MERTKhi LYVE1hi macrophages
2 - MERTKhi LYVE1hi macrophages
3 - T cells 
4 - MERTKhi LYVE1hi macrophages
5 - Granulocytes
6 - MERTKhi LYVE1hi macrophages
7 - MERTKhi LYVE1hi macrophages
8 - T cells 
9 - CLEC10A Dcs
10 - T cells 
11 - B cells  
12 - NK cells
13 - MERTKlo PTPRGhi macrophages 
14 - VCANhi DCs/Monocytes
15 - MERTKhi LYVE1lo macrophages
16 - Plasma cells
17 - slow twitch skeletal muscle
18 - CLEC9Ahi DCs



```{r, fig.width=10, fig.height=7}

so.immune <- RenameIdents(so.immune,
                          `0` = "MERTKhi LYVE1hi macrophages", 
                          `1` = "MERTKhi LYVE1hi macrophages",
                          `2` = "MERTKhi LYVE1hi macrophages",
                          `3` = "T cells",
                          `4` = "MERTKhi LYVE1hi macrophages",
                          `5` = "Granulocytes",
                          `6` = "MERTKhi LYVE1hi macrophages",
                          `7` = "MERTKhi LYVE1hi macrophages",
                          `8` = "T cells",
                          `9` = "CLEC10A DCs",
                          `10` = "T cells",
                          `11` = "B cells",
                          `12` = "NK cells", 
                          `13` = "MERTKlo PTPRGhi macrophages",
                          `14` = "Monocytes",
                          `15` = "MERKhi LYVE1lo macrophages",
                          `16` = "Plasma cells",
                          `17` = "Slow twitch skeletal muscle cells",
                          `18` = "CLEC9Ahi DCs")

DimPlot(so.immune, reduction = "umap", label = TRUE)+
    ggtitle("Fine annotation")
so.immune$fine_annotation_immune <- Idents(so.immune)

ggsave(paste0(directory, "/Annotation_figures/UMAP_annotated.png"), width = 6, height = 4, bg = "white")

```


Find Markers for these clusters

```{r}
markers <- FindAllMarkers(so.immune, 
                          assay = "soupX",
                           only.pos = TRUE, 
                           min.pct = 0.25, 
                           logfc.threshold = 0.25)
dir.create(paste0(directory, "/Marker_lists"))
write.table(markers, 
            paste0(directory, "/Marker_lists/Markers_annotated.txt"), 
                quote = FALSE, sep = "\t")
```



Heatmap with new annotations

```{r, fig.width=14, fig.height=14}

markers_top10 <- markers %>% group_by(cluster) %>% 
        slice_max(n=10, order_by = abs(avg_log2FC)) %>% 
        pull (gene)

DoHeatmap(so.immune, markers_top10, assay = "soupX") + 
            scale_fill_viridis()

```

## Top markers dotplot with dendogram

scDotPlot
https://bioconductor.org/packages/devel/bioc/vignettes/scDotPlot/inst/doc/scDotPlot.html

Use the sce syntax. Seurat version not working, probably as am using seurat v4 not 5. 
```{r}

# convert to sce
sce <- as.SingleCellExperiment(so.immune)

# select the top 10 markers for each cluster
features_10 <- markers %>% group_by(cluster) %>%
    dplyr::slice(1:10) %>%
    dplyr::select(cluster, gene)

# remove duplicated rows
features_10 <- features_10[!duplicated(features_10$gene),]

# make features into a vector
features_10 <- features_10 %>%
    deframe()

# select the top 5 markers for each cluster
features_5 <- markers %>% group_by(cluster) %>%
    dplyr::slice(1:5) %>%
    dplyr::select(cluster, gene)

# remove duplicated rows
features_5 <- features_5[!duplicated(features_5$gene),]

# make features into a vector
features_5 <- features_5 %>%
    deframe()

# select the top 20 markers for each cluster
features_20 <- markers %>% group_by(cluster) %>%
    dplyr::slice(1:20) %>%
    dplyr::select(cluster, gene)

# remove duplicated rows
features_20 <- features_20[!duplicated(features_20$gene),]

# make features into a vector
features_20 <- features_20 %>%
    deframe()

# add marker genes to row data
rowData(sce)$Marker_10 <- features_10[match(rownames(sce), features_10)] %>% 
    names()
rowData(sce)$Marker_5 <- features_5[match(rownames(sce), features_5)] %>% 
    names()
rowData(sce)$Marker_20 <- features_5[match(rownames(sce), features_20)] %>% 
    names()

```

Plot 10 most variable genes 

```{r, fig.width=8, fig.height=12}

ident_name <- "fine_annotation_immune"
n_colours <- nrow(unique(so.immune[[ident_name]]))

# plot the log counts
sce %>%
    scDotPlot(features = features_10,
              group = ident_name,
              groupAnno = ident_name,
              featureAnno = "Marker_10",
              groupLegends = FALSE,
              annoColors = list(ident_name = pal_d3()(n_colours),
                                "Marker_10" = pal_d3()(n_colours)),
              annoWidth = 0.02)
ggsave(paste0(directory, "/Annotation_figures/Dotplot_with_dendogram_logcounts_10_annotated.png"), width = 8, height = 12, bg = "white")

# plot the scaled data
sce %>%
    scDotPlot(features = features_10,
              scale = TRUE,
              group = ident_name,
              groupAnno = ident_name,
              featureAnno = "Marker_10",
              groupLegends = FALSE,
              annoColors = list(ident_name = pal_d3()(n_colours),
                                "Marker_10" = pal_d3()(n_colours)),
              annoWidth = 0.02)
ggsave(paste0(directory, "/Annotation_figures/Dotplot_with_dendogram_scaled_10_annotated.png"), width = 8, height = 12, bg = "white")

```

```{r, fig.width=8, fig.height=9}

# plot the log counts
sce %>%
    scDotPlot(features = features_5,
              group = ident_name,
              groupAnno = ident_name,
              featureAnno = "Marker_5",
              groupLegends = FALSE,
              annoColors = list(ident_name = pal_d3()(n_colours),
                                "Marker_5" = pal_d3()(n_colours)),
              annoWidth = 0.02)
ggsave(paste0(directory, "/Annotation_figures/Dotplot_with_dendogram_logcounts_annotated_5.png"), width = 8, height = 8, bg = "white")

# plot the scaled data
sce %>%
    scDotPlot(features = features_5,
              scale = TRUE,
              group = ident_name,
              groupAnno = ident_name,
              featureAnno = "Marker_5",
              groupLegends = FALSE,
              annoColors = list(ident_name = pal_d3()(n_colours),
                                "Marker_5" = pal_d3()(n_colours)),
              annoWidth = 0.02)
ggsave(paste0(directory, "/Annotation_figures/Dotplot_with_dendogram_scaled_annotated_5.png"), width = 8, height = 8, bg = "white")

```
# Summary of markers

Use this code to get a list of markers for each cluster

```{r}

cluster_markers <- list()
for (i in levels(Idents(so.immune))){
    cluster_markers[[i]] <- markers %>% 
        group_by(cluster) %>% 
        slice_max(n=20, order_by = abs(avg_log2FC)) %>% 
        filter(cluster == i) %>% pull (gene)
}
cluster_markers

write.csv(t(as.data.frame(cluster_markers)), paste0(directory, "/Marker_list_for_cellxgene_annotated.csv"), quote = FALSE)

```

UMAP split by microanatomy

```{r, fig.height=10, fig.width=14}
p <- DimPlot(object = so.immune, reduction = "umap", shuffle = TRUE, 
             split.by = "microanatomical_site", ncol = 2)+
    ggtitle(paste0("Muscle UMAP split my microanatomy at resolution ", resolution))
ggsave(paste0(directory, "/Annotation_figures/UMAP_by_microanatomy_annotated_", resolution, ".png"), 
       width = 8, height = 8, bg = "white")
p
```
Bar chart of cell composition

```{r}

df <- so.immune[[]] %>% select(fine_annotation_immune, microanatomical_site)

#library(data.table)
df <- data.table(df)
df <- df[, .(COUNT = .N), by = names(df)]

ggplot(df, aes(fill=microanatomical_site, y=COUNT, x=fine_annotation_immune)) + 
    geom_bar(position="fill", stat="identity")+
    theme_classic()+
    scale_fill_manual(values = ma.cols)+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+coord_flip()

ggsave(paste0(directory, "/Annotation_figures/Cluster_fraction_microanatomy_annotated.png"), 
       width = 8, height = 6, bg = "white")
```


## How to name the clusters?

Do FeaturePlots and DotPlots of the top 9 markers for each cluster

```{r, fig.width=10, fig.height=10}
dir.create(paste0(directory, "/Feature_Plots"))
dir.create(paste0(directory, "/Top_20_Dotplots"))
for (i in levels(Idents(so.immune))){
    FeaturePlot(so.immune, cluster_markers[[i]][1:9], reduction = "umap")
    ggsave(paste0(directory, "/Feature_Plots/Top9_cluster_", i, ".png"), width = 10, height = 10, bg = "white")
    
    DotPlot(so.immune, 
             features = cluster_markers[[i]],
             assay = "soupX") + 
    scale_colour_viridis(direction = -1) +
    ggtitle(paste0("Top 20 markers cluster", i)) + 
    theme(plot.title = element_text(size = 14, face = "bold"))+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+coord_flip()
    ggsave(paste0(directory, "/Top_20_Dotplots/Top20_cluster_", i, ".png"), width = 7, height =7, bg = "white")
}
```

Project annotations on the original umap

```{r, fig.width=10, fig.height=7}
DimPlot(so.immune, reduction = "umap.scvi", label = TRUE, repel = TRUE)
ggsave(paste0(directory, "/Annotation_figures/UMAP_annotated_original_dims.png"), width = 6, height = 4, bg = "white")
```


# Save the object

```{r}
dir.create(paste0(directory, "/RDS_objects.dir"))
saveRDS(so.immune, paste0(directory, "/RDS_objects.dir/Achilles_immune_subset.rds"))
```

```{r}
sessionInfo()
```

