---
title: "Pathway analysis"
author: "Jolet Mimpen/Carla Cohen"
date: "2024-01-22"
output: html_document
---

# Pathway analysis
The aim of the script is to use pathway analysis to analyse the outputs of differential gene expression. 
Specifically this script is to analyse the results of the DEseq2 LRT test of Achilles data where muscle was included.  
Also where the fibroblasts are treated as one cluster. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Seurat)
library(SeuratObject)
library(BiocGenerics)
library(clusterProfiler)
library(msigdbr)
library(tidyverse)
library(svglite)
library(org.Hs.eg.db)

date <- Sys.Date() %>% str_replace_all("-", "")
time <- format(Sys.time(), "%X") %>% str_replace_all(":", "-") %>%
    str_sub(1, 5)
directory <- paste0(date,"_", time, "_Pathway_Analysis.dir/")
dir.create(directory)

dir.create(paste0(directory, "Figures"))
dir.create(paste0(directory, "Results"))

subset_exp <- TRUE # whether to subset pathways to only experimentally validated

```

## Gene lists to test

### Read in gene clusters calculated by the DEseq2 LRT test
20250304_17-29_Pseudobulk.dir

```{r}
celltypes <- c("Adipocytes", "Skeletalmuscle", "Fibroblasts", 
               "Macrophages", "Mural","VEC")

clusters <- list()

for (i in seq(1:length(celltypes))){
    clusters[[i]] <- read.csv(paste0("20250304_17-29_Pseudobulk.dir/Cluster_results/", celltypes[[i]], "_df.csv"))
}
names(clusters) <- celltypes

```

#### Genes upregrulated across microanatomy  

Create lists of genes for the following groups:  
Fibroblast group 1
Macrophages group 1
Mural cells group 2
VEC group 1
Adipocyte group 1

```{r}

# genelists
Fibroblasts_1 <- clusters[["Fibroblasts"]] %>% filter (cluster == 1) %>% pull (genes)
Macrophages_1 <- clusters[["Macrophages"]] %>% filter (cluster == 1) %>% pull (genes)
Mural_2 <- clusters[["Mural"]] %>% filter (cluster == 2) %>% pull (genes)
VEC_1 <- clusters[["VEC"]] %>% filter (cluster == 1) %>% pull (genes)
Adipocytes_1 <- clusters[["Adipocytes"]] %>% filter (cluster == 1) %>% pull (genes)

genelists_upregulated <- list(Adipocytes_1, Fibroblasts_1, Macrophages_1, 
                              Mural_2, VEC_1 )
names(genelists_upregulated) <- c("Adipocytes", "Fibroblasts", "Macrophages", "Mural","VEC")
```

#### Genes downregulated across microanatomy  

Create lists of genes for the following groups:  
Fibroblasts 2
Skeletal muscle 2
Macrophages group 2
Mural cells group 3
VEC group 3
Adipocyte group 2

```{r}

# genelists
Fibroblasts_2 <- clusters[["Fibroblasts"]] %>% filter (cluster == 2) %>% pull (genes)
Skeletalmuscle_2 <- clusters[["Skeletalmuscle"]] %>% filter (cluster == 2) %>% pull (genes)
Macrophages_2 <- clusters[["Macrophages"]] %>% filter (cluster == 2) %>% pull (genes)
Mural_3 <- clusters[["Mural"]] %>% filter (cluster == 3) %>% pull (genes)
VEC_3 <- clusters[["VEC"]] %>% filter (cluster == 3) %>% pull (genes)
Adipocytes_2 <- clusters[["Adipocytes"]] %>% filter (cluster == 2) %>% pull (genes)

genelists_downregulated <- list(Adipocytes_2, Skeletalmuscle_2, Fibroblasts_2, Macrophages_2, 
                              Mural_3, VEC_3 )
names(genelists_downregulated) <- c("Adipocytes", "Skeletalmuscle", "Fibroblasts", "Macrophages", 
                                  "Mural", "VEC")
```


#### Genes upregrulated in tendon compared to muscle  

Create lists of genes for the following groups:  
Fibroblast group 4, 6, 8
Mural 1
Macrophages group 3


```{r}

# genelists
Fibroblast_468 <- clusters[["Fibroblasts"]] %>% filter (cluster == 4 | cluster == 6 | cluster == 8) %>% pull (genes)
Macrophages_3 <- clusters[["Macrophages"]] %>% filter (cluster == 3) %>% pull (genes)
Mural_3 <- clusters[["Mural"]] %>% filter (cluster == 3) %>% pull (genes)

genelists_tendon_high <- list(Fibroblast_468, Macrophages_3, Mural_3 )
names(genelists_tendon_high) <- c("Fibroblasts", "Macrophages", "Mural")

```

#### Genes upregrulated in muscle compared to tendon  

Create lists of genes for the following groups:  
Fibroblasts group 10, 5, 9

```{r}

# genelists
Fibroblast_1059 <- clusters[["Fibroblasts"]] %>% filter (cluster == 10 | cluster == 5 | cluster == 9) %>% pull (genes)

genelists_muscle_high <- list(Fibroblast_1059)
names(genelists_muscle_high) <- c("Fibroblasts")

```

## Background gene sets

Create a specific background gene set of all genes expressed in Seurat object per cell type  

### Create a set of background genes expressed in the tendon & muscle samples

```{r}
# Load seurat object
so.achilles <- readRDS("20250228_12-50_Fine_annotation.dir/RDS_objects.dir/Achilles_fine_annotation.rds")

```

Perform pseudobulk & get vector of all expressed genes

```{r}
#Aggregation of counts to sample level
cts <- AggregateExpression(so.achilles, 
                    group.by = c("sample"),
                    assays = 'soupX',
                    slot = "counts",
                    return.seurat = FALSE)
cts <- as.data.frame(cts$soupX)
#cts

# keep genes where there are at least 10 counts 
# expressed_genes_all <- cts %>% filter_all(all_vars(.>2)) %>% rownames()
v <- rowSums(cts)
expressed_genes_all <- names(v[v>9])
length(expressed_genes_all) #34956 genes

```

### Create custom background gene lists for each cell type

Simplify cell names

```{r}
df <- data.frame("broad_annotation" = levels(so.achilles$broad_annotation))

df$cell_annotation_pseudobulk <- c("Fibroblasts", "Skeletalmuscle", "VEC", "Macrophages", "Mural", "Adipocytes", 
                                   "Tcells", "LEC", "Satellite", "Granulocyte", "Bcells", "Nerve", "Plasma", "Ambient")

metadata <- so.achilles[[]]
metadata <- metadata %>% left_join(df, by = "broad_annotation")
so.achilles <- AddMetaData(so.achilles, metadata$cell_annotation_pseudobulk, "cell_annotation_pseudobulk")
```

```{r}
#Aggregation of counts to sample level per cell type
cts <- AggregateExpression(so.achilles, 
                    group.by = c("cell_annotation_pseudobulk", "sample"),
                    assays = 'soupX',
                    slot = "counts",
                    return.seurat = FALSE)

# transpose & convert to df
cts.t <- as.data.frame(t(cts$soupX))

# get values where to split
splitRows <- gsub('_.*', '', rownames(cts.t))

# split data.frame into a list of df for each cell type
cts.split <- split.data.frame(cts.t,
                 f = factor(splitRows), 
                 drop = TRUE)

# fix colnames and transpose function
rownames_change <- function(x){
  rownames(x) <- gsub('.*_(.*)', '\\1', rownames(x))
  return(x)
}

# create a list of df for each cell type
counts_list <- list()
for (i in 1:length(names(cts.split))){
    counts_list[[i]] <- t(rownames_change(cts.split[[i]]))
}

names(counts_list) <- names(cts.split)

```

Make a list of expressed genes for each cell type
```{r}
# keep genes where there are at least 10 counts across all samples
# can't be too specific as some samples don't express those genes

expressed_genes <- list()
for (i in 1:length(counts_list)){
    v <- rowSums(counts_list[[i]])
    expressed_genes[[i]] <- names(v[v>9])
    print(names(counts_list)[[i]])
    print(length(expressed_genes[[i]]))
    print(head(expressed_genes[[i]]))
}

names(expressed_genes) <- names(counts_list)

# print number of genes from 
```

## Pathway databases
Access the pathway databases required to perform the enrichment analysis  

### Make Hallmark reference list
```{r}
#import Hallmark pathway gene list
Hallmark_reference <- msigdbr(species = "Homo sapiens", category = "H") %>% 
  dplyr::select(gs_name, gene_symbol)

Hallmark_reference$gs_name <- gsub("_"," ", Hallmark_reference$gs_name)
Hallmark_reference$gs_name <- tolower(Hallmark_reference$gs_name)
Hallmark_reference$gs_name <- gsub("(^|[[:space:]])([[:alpha:]])", "\\1\\U\\2", Hallmark_reference$gs_name, perl=TRUE)
Hallmark_reference$gs_name <- gsub("Hallmark ","", Hallmark_reference$gs_name)
```


### Make GO reference list
```{r}
#import GO:BP pathway gene list
GOBP_reference <- msigdbr(species = "Homo sapiens", category = "C5", subcategory = "GO:BP") %>% 
  dplyr::select(gs_name, gene_symbol, gs_exact_source) %>% 
    dplyr::rename("go_id" = "gs_exact_source")

GOBP_reference$gs_name <- gsub("GOBP_","", GOBP_reference$gs_name)
GOBP_reference$gs_name <- gsub("_"," ", GOBP_reference$gs_name)
GOBP_reference$gs_name <- tolower(GOBP_reference$gs_name)
GOBP_reference$gs_name <- gsub("(^|[[:space:]])([[:alpha:]])", "\\1\\U\\2", GOBP_reference$gs_name, perl=TRUE)

if (subset_exp == TRUE){
    tb <- toTable(org.Hs.egGO2EG) # contains info on Evidence
    GOBP_reference <- GOBP_reference %>% left_join(tb, multiple = "all")
    
    # keep only pathways with experimental evidence
    non_exp <- c("ISS", "ISO", "ISA", "ISM", "IGC", "RCA", "ND", "IEA")
    positions <- which(GOBP_reference$Evidence %in% non_exp)
    GOBP_reference <- GOBP_reference[-positions,]
    dim(GOBP_reference) # 19614126        
}



```


### Run Pathway analysis
Hallmark and GOBP databases are used  
Select groupings for each cell type according to up-and down-regulation across microanatomy. 
Use the "enricher" function from clusterProfiler.  

Make a function to run the enricher function according to 
- gene list
- terms (GOBP/Hallmark)
- background gene set (custom cell)

```{r}

run_enricher <- function(genelist, description, terms, universe){
    
    results <- list()
    dir.create(paste0(directory, "Results/", description))
    #print(class(universe))
    if (class(universe) == "list"){
        my_universe <- universe[[i]]
    }else if (class(universe) == "character"){
        my_universe <- universe
    }else if (class(universe) == "NULL"){
        my_universe <- NULL
    }
    # print(head(my_universe))

    for(i in 1:length(genelist)){
        current_celltype <- names(genelist[i])
        #print(current_celltype)
        genes <- genelist[[i]]
        #print(head(genes))
        
        results[[i]] <- enricher(genes, TERM2GENE = terms, universe = my_universe)
        
        saveRDS(results[[i]], 
                paste0(directory, "Results/", description, "/", current_celltype, ".RDS"))    
        
    }
    
    names(results) <- names(genelist)
    return(results)
}

upregulated_GOBP_custom_cell <- run_enricher(genelists_upregulated, "Upregulated_GOBP_custom_cell", 
            GOBP_reference, expressed_genes)
downregulated_GOBP_custom_cell <- run_enricher(genelists_downregulated, "Downregulated_GOBP_custom_cell", 
            GOBP_reference, expressed_genes)
tendon_high_GOBP_custom_cell <- run_enricher(genelists_tendon_high, "Tendon_high_GOBP_custom_cell", 
            GOBP_reference, expressed_genes)
muscle_high_GOBP_custom_cell <- run_enricher(genelists_muscle_high, "muscle_high_GOBP_custom_cell", 
            GOBP_reference, expressed_genes)

```
Function for plotting results

```{r}

plot_enricher <- function(enricher_result, description){
    dir.create(paste0(directory, "Figures/", description), showWarnings = FALSE)
    for (i in 1:length(enricher_result)){
        #print(names(enricher_result[i]))
        n_pathways <- enricher_result[[i]]@result %>% filter(p.adjust < 0.05) %>% rownames() %>% length()
        #print(n_pathways)
        #print(description)
        if (n_pathways > 0){
            dotplot(enricher_result[[i]])+
                ggtitle(paste0(names(enricher_result[i]), "_", description))
            ggsave(paste0(directory, "Figures/", description, "/", names(enricher_result[i]), ".png"))
        }else{
            print ("no significant pathways")
        }
        
    }
}

plot_enricher(upregulated_GOBP_custom_cell, "Upregulated_GOBP_custom_cell")
plot_enricher(downregulated_GOBP_custom_cell, "Downregulated_GOBP_custom_cell")
plot_enricher(tendon_high_GOBP_custom_cell, "Tendon_high_GOBP_custom_cell")
plot_enricher(muscle_high_GOBP_custom_cell, "Muscle_high_GOBP_custom_cell")
```

### Additional visualisation

Dotplot combining results from all cell types. 

```{r}
dir.create(paste0(directory, "Figures/Combined_dotplots/"))
dir.create(paste0(directory, "Results/Combined_results/"))

plot_dotplot <- function(enrichment_results, comparison){
    print(comparison)
    results <- list()
    for (i in 1:length(enrichment_results)){
        results[[i]] <- enrichment_results[[i]]@result
        results[[i]]$celltype <- names(enrichment_results)[[i]]
        results[[i]] <- results[[i]] %>% 
            filter(p.adjust < 0.05) %>% 
            arrange(desc(p.adjust))
    }
    results <- bind_rows(results)
    if (nrow(results) >0){
        # make cell type a factor
        results$celltype <- factor(results$celltype, levels = c("Fibroblasts",
                                                                      "Skeletalmuscle", "VEC", "Mural", "Adipocytes", 
                                                                      "Macrophages"))
    
        filtered_res <- results %>% 
            mutate(new_col = -log10(p.adjust)) %>% 
            group_by(celltype) %>% 
            slice_min(order_by = p.adjust, n = 10) %>% 
            dplyr::select(ID, GeneRatio, p.adjust, Count, celltype, new_col)
        
        # make IDs a factor
        pathways <- as.data.frame(sort(table(filtered_res$ID)))
        colnames(pathways) <- c("ID", "pathway_freq")
        filtered_res <- filtered_res %>% 
            left_join(pathways) %>%
            group_by(pathway_freq) %>%
            arrange(celltype)
        filtered_res$ID <- factor(filtered_res$ID, levels = rev(unique(filtered_res$ID)))
        
        #print(head(filtered_res))
        write.table(filtered_res, 
                    paste0(directory, "Results/Combined_results/", comparison, ".txt"), 
                    sep = "\t", quote = FALSE)
                
            
        ggplot(filtered_res, aes(x = celltype, y = ID, size = Count, colour = new_col)) +
            geom_point()+
            #scale_colour_viridis()+
            theme_bw()+
            theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
            theme(axis.title.x = element_blank())+
            theme(axis.title.y = element_blank())+
            labs(colour = "-log10(p.adj)")+
            scale_y_discrete(position = "right")+
            ggtitle(comparison)
        
        ggsave (paste0(directory, "Figures/Combined_dotplots/", comparison, ".png"), 
                width = 8, height = 7)
        ggsave (paste0(directory, "Figures/Combined_dotplots/", comparison, ".svg"), 
                width = 8, height = 7)
    }else{
        print("no significant results")
    }

    
}

plot_dotplot(upregulated_GOBP_custom_cell, "Upregulated_GOBP_custom_cell")
plot_dotplot(downregulated_GOBP_custom_cell, "Downregulated_GOBP_custom_cell")
plot_dotplot(tendon_high_GOBP_custom_cell, "Tendon_high_GOBP_custom_cell")
plot_dotplot(muscle_high_GOBP_custom_cell, "Muscle_high_GOBP_custom_cell")

```

Dotplot combining results from up and downregulated in fibroblasts

```{r}
dir.create(paste0(directory, "Figures/Fibroblast_dotplots/"))
dir.create(paste0(directory, "Results/Fibroblast_results/"))


results_up <- upregulated_GOBP_custom_cell[["Fibroblasts"]]@result %>% 
            filter(p.adjust < 0.05) %>% 
            arrange(desc(p.adjust))
results_up$comparison <- "upregulated"
results_down <- downregulated_GOBP_custom_cell[["Fibroblasts"]]@result %>% 
            filter(p.adjust < 0.05) %>% 
            arrange(desc(p.adjust))
results_down$comparison <- "downregulated"

results_tendon <- tendon_high_GOBP_custom_cell[["Fibroblasts"]]@result %>% 
            filter(p.adjust < 0.05) %>% 
            arrange(desc(p.adjust))
results_tendon$comparison <- "tendon_high"

# NB muscle high has no sig results
results <- bind_rows(results_up, results_down, results_tendon)
# make comparison  a factor
results$comparison <- factor(results$comparison, levels = c("upregulated", "downregulated", "tendon_high"))
                             
filtered_res <- results %>% 
            mutate(new_col = -log10(p.adjust)) %>% 
            group_by(comparison) %>% 
            slice_min(order_by = p.adjust, n = 10) %>% 
            dplyr::select(ID, GeneRatio, p.adjust, Count, comparison, new_col)
        
# make IDs a factor
pathways <- as.data.frame(sort(table(filtered_res$ID)))
colnames(pathways) <- c("ID", "pathway_freq")
filtered_res <- filtered_res %>% 
            left_join(pathways) %>%
            group_by(pathway_freq) %>%
            arrange(comparison)
filtered_res$ID <- factor(filtered_res$ID, levels = rev(unique(filtered_res$ID)))

write.table(filtered_res, 
                    paste0(directory, "Results/Fibroblast_results/Fibroblasts_up_vs_down.txt"), 
                    sep = "\t", quote = FALSE)
                
            
ggplot(filtered_res, aes(x = comparison, y = ID, size = Count, colour = new_col)) +
            geom_point()+
            #scale_colour_viridis()+
            theme_bw()+
            theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
            theme(axis.title.x = element_blank())+
            theme(axis.title.y = element_blank())+
            labs(colour = "-log10(p.adj)")+
            scale_y_discrete(position = "right")
        
ggsave (paste0(directory, "Figures/Combined_dotplots/Fibroblasts_up_vs_down.png"), 
                width = 8, height = 7)
ggsave (paste0(directory, "Figures/Combined_dotplots/Fibroblasts_up_vs_down.svg"), 
                width = 8, height = 7)

```

