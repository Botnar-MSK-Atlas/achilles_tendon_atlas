---
title: "Fibroblasts pathway analysis"
author: "Carla Cohen"
date: "`r Sys.Date()`"
output: html_document
---

# Fibroblasts pathway analysis
Aim to perform pathway analysis on fibroblast subsets in order to assign putative functions. 

## Approaches
1. Pseuobulk then use enricher from clusterProfiler  
2. FindMarkers then use enricher from clusterProfiler
3. FindMarkers then use gost from gprofiler2 (ranked list)



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(Seurat)
library(cowplot)
library(viridis)
library(msigdbr)
library(clusterProfiler)
library(gprofiler2)
library(org.Hs.eg.db)

options(bitmapType='cairo') # required to get the gost graph to render

# make a new output folder for each run, with the date & time in the directory name
date <- Sys.Date() %>% str_replace_all("-", "")
time <- format(Sys.time(), "%X") %>% str_replace_all(":", "-") %>%
    str_sub(1, 5)
directory <- paste0(date,"_", time, "_Pathway_analysis_fibroblasts.dir")
dir.create(directory, showWarnings = FALSE)

subset_exp <- TRUE # whether to subset pathways to only experimentally validated
```

Read in the Achilles subset fibroblast object. 

```{r}
so.fibroblasts <- readRDS("20250228_12-50_Fine_annotation.dir/RDS_objects.dir/Achilles_fibroblast_subset.rds")
Idents(so.fibroblasts) <- so.fibroblasts$fine_annotation_fibroblasts
```


## 1. Pseudobulk and use enricher from clusterProfiler

Create a set of background genes expressed in the tendon & muscle samples

```{r}
#Aggregation of counts to sample level
cts <- AggregateExpression(so.fibroblasts, 
                    group.by = c("disease_status"), # pick a metafeature identical across samples
                    assays = 'soupX',
                    slot = "counts",
                    return.seurat = FALSE)
cts <- as.data.frame(cts$soupX)
#cts

# keep genes where there are at least 10 counts 
v <- rowSums(cts)
expressed_genes_all <- names(v[v>9])
length(expressed_genes_all) #28600 genes

```
Make GO reference list
```{r}
#import GO:BP pathway gene list
GOBP_reference <- msigdbr(species = "Homo sapiens", category = "C5", subcategory = "GO:BP") %>% 
  dplyr::select(gs_name, gene_symbol, gs_exact_source) %>% 
    dplyr::rename("go_id" = "gs_exact_source")

GOBP_reference$gs_name <- gsub("GOBP_","", GOBP_reference$gs_name)
GOBP_reference$gs_name <- gsub("_"," ", GOBP_reference$gs_name)
GOBP_reference$gs_name <- tolower(GOBP_reference$gs_name)
GOBP_reference$gs_name <- gsub("(^|[[:space:]])([[:alpha:]])", "\\1\\U\\2", GOBP_reference$gs_name, perl=TRUE)

if (subset_exp == TRUE){
    tb <- toTable(org.Hs.egGO2EG) # contains info on Evidence
    GOBP_reference <- GOBP_reference %>% left_join(tb, multiple = "all")
    
    # keep only pathways with experimental evidence
    non_exp <- c("ISS", "ISO", "ISA", "ISM", "IGC", "RCA", "ND", "IEA")
    positions <- which(GOBP_reference$Evidence %in% non_exp)
    GOBP_reference <- GOBP_reference[-positions,]
    dim(GOBP_reference) # 19614126        
}

```

Perform pseudobulk at cluster level. Create a list of df where each component is the pseudobulk expression in each cluster.
The backgrounds is all genes expressed in fibroblasts. 

```{r}

run_pseudobulk <- function(so){
    # 1. counts matrix - sample level

    #Aggregation of counts to sample level per cell type
    cts <- AggregateExpression(so, 
                        group.by = "fine_annotation_fibroblasts",
                        assays = 'soupX',
                        slot = "counts",
                        return.seurat = FALSE)
    
    # transpose & convert to df
    cts.t <- as.data.frame(t(cts$soupX))
    
    # split data.frame into a list of df for each cell type
    cts.split <- split.data.frame(cts.t,
                     f = rownames(cts.t))
    
    # create a list of df for each cell type
    counts_list <- list()
    for (i in 1:length(names(cts.split))){
        counts_list[[i]] <- t(cts.split[[i]]) %>% as.data.frame()
        colnames(counts_list[[i]]) <- "counts"
    }
    
    names(counts_list) <- names(cts.split)
    
    # get the top 200 genes for each cluster
    gene_list <- list()
    for (i in 1:length(names(cts.split))){
        gene_list[[i]] <- counts_list[[i]] %>% dplyr::arrange(desc(counts)) %>% slice_head(n = 200)
    }
    head(gene_list[[1]])
    names(gene_list) <- names(counts_list)
    
    return(list(gene_list, counts_list))
}

genes_counts <- run_pseudobulk(so.fibroblasts)
```

Run Pathway analysis using GOBP with "enricher" function from clusterProfiler. 

```{r}
run_enricher <- function (gene_list){
    dir.create(paste0(directory, "/Pseudobulk"))
    results <- list()
    
    # for(i in 1:length(gene_list[[1]])){
    for (i in names(genes_counts[[1]])){
        current_cluster <- names(gene_list[[1]][i])
        results[[i]] <- enricher(rownames(gene_list[[1]][[i]]), TERM2GENE = GOBP_reference, universe = expressed_genes_all)
        saveRDS(results[[i]], 
                paste0(directory, "/Pseudobulk/Cluster_", current_cluster, ".RDS"))    
            
    }
        
    names(results) <- names(gene_list[[2]])  
    return(results)
    
    for (i in 1:length(results)){
        dotplot(results[[i]])
        ggsave(paste0(directory, "/Pseudobulk/Cluster_", i, ".png"))
    }
}

enricher.results <- run_enricher(genes_counts)
```


Visualise the results
Make this generic for any type of analysis.  
Use analysis = "Pseudobulk", 


```{r, fig.width=8, fig.height=7}
visualise_enricher <- function (results, so, analysis){
    dir.create(paste0(directory, "/", analysis))
    dir.create(paste0(directory, "/", analysis, "/Plots"))

    # plot each fibroblast subset
    for (i in names(results)){
        print(i)
        n_results <- results[[i]]@result %>% filter (p.adjust <0.05) %>% nrow()
        #print(n_results)
        if (n_results > 0){
            dotplot(results[[i]])
            ggsave(paste0(directory, "/", analysis, "/Plots/Cluster_", i, ".png"))
    }
        }


    # Alternative grouped dotplot
    # group the results together
    res <- list()
    for (i in names(enricher.results)){
            res[[i]] <- enricher.results[[i]]@result
            res[[i]]$cluster <- i
            
            res[[i]] <- res[[i]] %>% 
                filter(p.adjust < 0.05) %>% 
                arrange(desc(p.adjust))
        }
    res <- bind_rows(res)

    # make cluster a factor
    res$cluster <- factor(res$cluster, levels = unique(res$cluster))
  
    # filter the results
    filtered_res <- res %>% 
                mutate(new_col = -log10(p.adjust)) %>% 
                group_by(cluster) %>% 
                slice_min(order_by = p.adjust, n = 10) %>% 
                dplyr::select(ID, GeneRatio, p.adjust, Count, cluster, new_col)
    
    write.table(filtered_res, paste0(directory, "/", analysis, "/Combined_results.txt"),
                sep = "\t", quote = FALSE)
    
    # make IDs a factor
    pathways <- as.data.frame(sort(table(filtered_res$ID)))
    colnames(pathways) <- c("ID", "pathway_freq")
    filtered_res <- filtered_res %>% 
        left_join(pathways) %>%
        group_by(pathway_freq) %>%
        arrange(cluster)
    filtered_res$ID <- factor(filtered_res$ID, levels = rev(unique(filtered_res$ID)))    
    
    # plot
    ggplot(filtered_res, aes(x = cluster, y = ID, size = Count, colour = new_col)) +
                geom_point()+
                #scale_colour_viridis()+
                theme_bw()+
                theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
                theme(axis.title.x = element_blank())+
                theme(axis.title.y = element_blank())+
                labs(colour = "-log10(p.adj)")+
                scale_y_discrete(position = "right")+
        ggtitle(analysis)
   # save        
    ggsave (paste0(directory, "/", analysis, "/Plots/Combined_dotplot.png"), 
                    width = 8, height = 10)
      
}
      
visualise_enricher(enricher.results, so.fibroblasts, "Pseudobulk")

```



## Pathway analysis using results of FindMarkers()

Read in the markers calculated by the script Achilles_fine_annotation.Rmd from 20250228_12-50_Fine_annotation.dir
TO DO: David suggests using a significance threshold and/or fewer markers to see how that affects the pathways. 

```{r, message = FALSE}

markers <- read.table(paste0("20250228_12-50_Fine_annotation.dir/Marker_lists/fine_annotation_fibroblasts.txt"), 
                sep = "\t")
top200_markers <- markers %>% group_by(cluster) %>% 
        filter(abs(avg_log2FC)>0.2) %>% 
        arrange(desc(abs(avg_log2FC))) %>% 
        slice_head(n = 200)

```

Run Pathway analysis using GOBP database with enricher function

```{r}
run_enricher_2 <- function(markers){
    
    dir.create(paste0(directory, "/Findmarkers_enricher"))
    results <- list()
        
    for(i in unique(markers$cluster)){
          genes <- markers %>% filter(cluster == i) %>% pull(gene)
          results[[i]] <- enricher(genes, TERM2GENE = GOBP_reference, universe = expressed_genes_all)
        #print("Enricher ran")
        saveRDS(results[[i]], paste0(directory, "/Findmarkers_enricher/Cluster_", i, ".RDS"))    
            
    }
        
    names(results) <- unique(markers$cluster)
    return(results)
    
}
enricher.results.2 <- run_enricher_2(top200_markers)
visualise_enricher(enricher.results.2, so.fibroblasts, "Findmarkers_enricher")
```


## Pathway analysis with gost (uses ranked list) on FindMarkers 
This is how Jolet did it in the quads paper.  

```{r, fig.width=10, fig.height=20}

run_gost <- function (background){
    
    # create a list of genes for each cluster filtered by padj<0.05
    markers_list <- list()
    for (i in unique(markers$cluster)){
        markers_list[[i]] <- markers %>% 
            group_by(cluster) %>% 
            arrange(desc(avg_log2FC)) %>% 
            filter (p_val_adj < 0.05) %>%
            filter(cluster == i) %>% 
            slice_head(n = 200) %>%
            pull (gene)
    }
    
    # run gost
    if (background == "universe"){
        gostres <- gost(query = markers_list, 
                    organism = "hsapiens",
                    ordered_query = TRUE, 
                    significant = TRUE,
                    )
    }else if (background == "custom"){
        gostres <- gost(query = markers_list, 
                organism = "hsapiens",
                ordered_query = TRUE, 
                significant = TRUE, 
                domain_scope = "custom", 
                custom_bg = expressed_genes_all
                )

    }
    
    dir.create(paste0(directory, "/Pathway_analysis_gost"))
    write.table(gostres$result[,1:13], paste0(directory, "/Pathway_analysis_gost/GOST_results_", background, ".txt"), 
                sep = "\t", quote = FALSE, col.names = TRUE, row.names = FALSE)

    
    return(gostres)
    
}

gostres_custom <- run_gost("custom")
gostres_universe <- run_gost("universe")


```

Plot GOBP results using gostplot and custom dotplot

```{r, fig.height=10, fig.width=8}


 plot_gost <- function (results, background){    
    # gostplot
    gostplot(results, capped = TRUE, interactive = FALSE)
    ggsave(paste0(directory, "/Pathway_analysis_gost/gostplot_", background, ".png"), 
           width = 10,  height = 20, bg = "white")

    # custom dotplot
    
res <- results$result %>% 
        filter(source == "GO:BP") %>%
        mutate(new_col = -log10(p_value)) %>% 
        group_by(query) %>% 
        slice_min(order_by = p_value, n = 10)
    
    # make cluster a factor
    res$query <- factor(res$query, levels = sort(unique(res$query)))
    
    # make term_name a factor
    pathways <- as.data.frame(sort(table(res$term_name)))
    colnames(pathways) <- c("term_name", "pathway_freq")
    res <- res %>% 
        left_join(pathways) %>%
        group_by(pathway_freq) %>%
        arrange(query)
    res$term_name <- factor(res$term_name, levels = rev(unique(res$term_name)))    
    
    
    ggplot(res, aes(x = query, y = term_name, size = query_size, colour = p_value)) +
                geom_point()+
                #scale_colour_viridis()+
                theme_bw()+
                theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
                theme(axis.title.x = element_blank())+
                theme(axis.title.y = element_blank())+
                labs(colour = "-log10(p.adj)")+
                scale_y_discrete(position = "right")+
     ggtitle(paste0("GOST_", background))
    
    
    ggsave (paste0(directory, "/Pathway_analysis_gost/Combined_dotplot_", background, ".png"), 
                    width = 8, height =10, bg = "white")
}
    
plot_gost(gostres_custom, "custom")
plot_gost(gostres_universe, "universe")
```



```{r}
sessionInfo()
```

