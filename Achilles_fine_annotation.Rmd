---
title: "Fine annotation of Achilles"
author: "Carla Cohen"
date: "`r Sys.Date()`"
output: html_document
---


A script to bring together the fine annotation subsets in the Achilles data.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
library(tidyverse)
library(Seurat)
library(cowplot)
library(yaml)
library(viridis)
library(svglite)

# make output folder for each run, with the date & time in the directory name
date <- Sys.Date() %>% str_replace_all("-", "")
time <- format(Sys.time(), "%X") %>% str_replace_all(":", "-") %>%
    str_sub(1, 5)
directory <- paste0(date,"_", time, "_Fine_annotation.dir")
dir.create(directory, showWarnings = FALSE)
dir.create(paste0(directory, "/UMAP/"))
dir.create(paste0(directory, "/DotPlot/"))
dir.create(paste0(directory, "/Marker_lists/"))


```

Load objects

```{r}
# whole object
so.achilles <- readRDS("20250127_16-05_Annotation_update.dir/RDS_objects.dir/Achilles_integrated_annotated.rds")

# fibroblast subset
so.fibroblast <- readRDS("20250131_12-34_Fine_annotation_fibroblasts_0.2.dir/RDS_objects.dir/Achilles_fibroblast_subset.rds")

# muscle subset
so.muscle <- readRDS("20250207_13-28_Fine_annotation_muscle_0.1.dir/RDS_objects.dir/Achilles_muscle_subset.rds")

# immune subset
so.immune <- readRDS("20250205_13-31_Fine_annotation_immune_1.6.dir/RDS_objects.dir/Achilles_immune_subset.rds")

# stromal subset
so.stromal <- readRDS("20250206_13-26_Fine_annotation_stromal_0.9.dir/RDS_objects.dir/Achilles_stromal_subset.rds")
```

Update naming of muscle cells 
 - from "MTJ" to "transitional"
 - from slow twitch to "slow-twitch skeletal muscle cells"
Update immune cells
- CLEC10A DCs to CLEC10Ahi DCs

```{r}
# TO DO

df <- so.muscle[[]] %>% select(fine_annotation_muscle)
df$fine_annotation_muscle <- str_replace(df$fine_annotation_muscle, "MTJ-specific", "Transitional skeletal muscle cells")
df$fine_annotation_muscle <- str_replace(df$fine_annotation_muscle, "Slow-twitch", "Slow-twitch skeletal muscle cells")
df$fine_annotation_muscle <- str_replace(df$fine_annotation_muscle, "Fast-twitch", "Fast-twitch skeletal muscle cells")
so.muscle$fine_annotation_muscle <- NULL
so.muscle <- AddMetaData(so.muscle, df)
Idents(so.muscle) <- so.muscle$fine_annotation_muscle

df <- so.immune[[]] %>% select(fine_annotation_immune)
df$fine_annotation_immune <- str_replace_all(df$fine_annotation_immune, "Slow twitch skeletal muscle cells", "Slow-twitch skeletal muscle cells")
df$fine_annotation_immune <- str_replace_all(df$fine_annotation_immune, "CLEC10A DCs", "CLEC10Ahi DCs")
so.immune$fine_annotation_immune <- NULL
so.immune <- AddMetaData(so.immune, df)
Idents(so.immune) <- so.immune$fine_annotation_immune
```



Plot separately

```{r, fig.width=14, fig.height=14}
Idents(so.achilles) <- so.achilles$broad_annotation
p1 <- DimPlot(so.achilles, reduction = "umap.scvi") + ggtitle("Broad annotation")
p2 <- DimPlot(so.fibroblast, reduction = "umap") + ggtitle("Fibroblasts")
p3 <- DimPlot(so.muscle, reduction = "umap") + ggtitle("Muscle")
p4 <- DimPlot(so.immune, reduction = "umap") + ggtitle("Immune")
p5 <- DimPlot(so.stromal, reduction = "umap") + ggtitle("Stromal")
plot_grid(p1, p2, p3, p4, p5, ncol = 2)
```

How many cells are in the subsets? We have removed highly ambient clusters in some cases

```{r}
print("Fibroblasts")
so.achilles[[]] %>% filter(broad_annotation == "Fibroblasts")%>% nrow()
ncol(so.fibroblast)

print("Muscle")
so.achilles[[]] %>% filter(broad_annotation == "Skeletal muscle cells")%>% nrow()
ncol(so.muscle)

print("Immune")
so.achilles[[]] %>% filter(broad_annotation == "Granulocytes" |
                               broad_annotation == "Macrophages" |
                               broad_annotation == "B cells" |
                               broad_annotation == "Plasma cells" |
                               broad_annotation == "T cells") %>% nrow()
ncol(so.immune)

print("Stromal")
so.achilles[[]] %>% filter(broad_annotation == "Adipocytes" |
                               broad_annotation == "Vascular endothelial cells" |
                               broad_annotation == "Lymphatic endothelial cells" |
                               broad_annotation == "Mural cells" ) %>% nrow()
ncol(so.stromal)


```



Rename idents of cells from the whole object to make it easier to remove cells that have been filtered out due to ambient contamination in the subsets. 

```{r}
df <- data.frame(broad_annotation = unique(so.achilles$broad_annotation))
df <- df %>% mutate(original_broad_annotation = paste0(broad_annotation, "_original"))
df <- so.achilles[[]] %>% left_join(df)
so.achilles <- AddMetaData(so.achilles, df$original_broad_annotation, col.name = "original_broad_annotation")
print("Fibroblasts")
so.fibroblast$fine_annotation_fibroblasts %>% levels()
print("Muscle")
so.muscle$fine_annotation_muscle %>% levels()
print("Immune")
so.immune$fine_annotation_immune%>% levels()
print("Stromal")
so.stromal$fine_annotation_stromal%>% levels()


```

Join the metadata of the objects and create a new column of fine annotations

```{r}
# get the metadata and add barcodes as a column
metadata <- so.achilles[[]]
metadata$barcodes <- rownames(metadata)

metadata.fb <- so.fibroblast[[]]
metadata.fb$barcodes <- rownames(metadata.fb)

metadata.muscle <- so.muscle[[]]
metadata.muscle$barcodes <- rownames(metadata.muscle)

metadata.immune <- so.immune[[]]
metadata.immune$barcodes <- rownames(metadata.immune)

metadata.stromal <- so.stromal[[]]
metadata.stromal$barcodes <- rownames(metadata.stromal)

# join the metadata df by the barcodes
df <- left_join(metadata, metadata.fb, by = "barcodes", suffix = c("", ".fb"))
df <- left_join(df, metadata.muscle, by = "barcodes", suffix = c("", ".muscle"))
df <- left_join(df, metadata.immune, by = "barcodes", suffix = c("", ".immune"))
df <- left_join(df, metadata.stromal, by = "barcodes", suffix = c("", ".stromal"))
df <- df %>% select(barcodes, original_broad_annotation, fine_annotation_fibroblasts, 
                    fine_annotation_muscle, fine_annotation_immune, fine_annotation_stromal)

# make a new column of fine annotation by filling in the values from the other annotations
df <- df %>% mutate(fine_annotation =
                  case_when(is.na(fine_annotation_fibroblasts) & 
                                is.na(fine_annotation_muscle) & 
                                is.na(fine_annotation_immune) &
                                is.na(fine_annotation_stromal) ~original_broad_annotation))

df <- df %>% mutate(fine_annotation = coalesce(fine_annotation, fine_annotation_fibroblasts, 
                                               fine_annotation_muscle, fine_annotation_immune, fine_annotation_stromal))

# keep only the new column and make barcodes the rownames
rownames(df) <- df$barcodes
df %>% filter(fine_annotation_immune == "Slow twitch skeletal muscle cells")

df <- df %>% select(fine_annotation)

# add this column to the so.achilles metadata
so.achilles <- AddMetaData(so.achilles, df)
Idents(so.achilles) <- "fine_annotation"

```



Remove the cells named "_original"
```{r}
positions <- grep("*_original", unique(so.achilles$fine_annotation))
cells_to_remove <- unique(so.achilles$fine_annotation)[positions]
so.achilles.clean <- subset(so.achilles, idents = cells_to_remove, invert = TRUE)

print("Number of cells removed due to ambient contamination")
dim(so.achilles)-dim(so.achilles.clean)

```

Plot the fine annotation before and after the removal of ambient cells

```{r, fig.width=14, fig.height=8}
my_pal <- DiscretePalette(n=length(unique(so.achilles$fine_annotation)), palette = "polychrome", shuffle = TRUE)
DimPlot(so.achilles, reduction = "umap.scvi", cols = my_pal)+ggtitle("Fine annotation")
DimPlot(so.achilles.clean, reduction = "umap.scvi", cols = my_pal)+ggtitle("Fine annotation")
DimPlot(so.achilles.clean, reduction = "harmony.umap", cols = my_pal)+ggtitle("Fine annotation")
```

# Calculate top markers for broad and fine annotations and for each subset


```{r}
# make a function using the so and the annotation column name

find_markers <- function(so, name){
    Idents(so) <- name
    markers <-  FindAllMarkers(so,
                           assay = "soupX",
                           only.pos = TRUE, 
                           min.pct = 0.25, 
                           logfc.threshold = 0.25
                        )
    write.table(markers, 
            paste0(directory, "/Marker_lists/", name, ".txt"), 
                quote = FALSE, sep = "\t")
}

find_markers(so.achilles.clean, "fine_annotation")
find_markers(so.achilles.clean, "broad_annotation")
find_markers(so.fibroblast, "fine_annotation_fibroblasts")
find_markers(so.muscle, "fine_annotation_muscle")
find_markers(so.immune, "fine_annotation_immune")
find_markers(so.stromal, "fine_annotation_stromal")
```







# Save the objects


```{r}
dir.create(paste0(directory, "/RDS_objects.dir"))
saveRDS(so.achilles.clean, paste0(directory, "/RDS_objects.dir/Achilles_fine_annotation.rds"))
saveRDS(so.immune, paste0(directory, "/RDS_objects.dir/Achilles_immune_subset.rds"))
saveRDS(so.fibroblast, paste0(directory, "/RDS_objects.dir/Achilles_fibroblast_subset.rds"))
saveRDS(so.muscle, paste0(directory, "/RDS_objects.dir/Achilles_muscle_subset.rds"))
saveRDS(so.stromal, paste0(directory, "/RDS_objects.dir/Achilles_stromal_subset.rds"))
```


```{r}
sessionInfo()
```


