---
title: "SCVI test"
author: "Carla Cohen"
date: "`r Sys.Date()`"
output: html_document
---

Aim to get scvi working via reticulate
Using this tutorial:

https://docs.scvi-tools.org/en/1.0.1/tutorials/notebooks/python_in_R.html


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(reticulate)
library(anndata)
#library(sceasy)

library(Seurat)
library(SeuratData)

reticulate::use_condaenv(condaenv = "integration-seuratv5-env", conda = "/project/ancestryhca/ccohen/mamba_installation/conda/condabin/conda", required = F)
```

## Import Python libraries
Now, we load the scanpy library via reticulate using the import() function. The convert boolean argument determines whether the output of Python functions is automatically converted to an R object equivalent via the py_to_r() function. Here, we set it to FALSE intentionally since often times we would like to retain the Python format for further manipulation in Python (e.g. with scanpy). Additionally, this keeps data type conversion more explicit, avoiding type confusion.

```{r}
sc <- import('scanpy', convert = FALSE)
```

Read in the Seurat object
```{r}
so <- readRDS("20231108_12-23_Integration.dir/RDS_objects.dir/Achilles_merge_SeuratObject.rds")
# subset to 5k cells
so <- so.merge[, sample(colnames(so.merge), size =5000, replace=F)]

```

Convert to adata format
(in the tutorial they use sceasy but I didn't get that to work previously)
```{r}
DefaultAssay(so) <- "RNA"
# create an Anndata object
adata <- anndata::AnnData(
    X = t(GetAssayData(so, slot = "counts")), # raw matrix, transposed for python
    obs = as.data.frame(so[[]]),  # cell metadata
    var = as.data.frame(rownames(so)), # gene metadata
    layers = list(
        counts = t(GetAssayData(so, slot = "counts")),
        logcounts = t(GetAssayData(so, slot = "data")),
        decontX = t(so@assays$decontXcounts$counts),
        soupX = t(so@assays$soupX$counts)
    ),
    obsm = list(
        pca = Embeddings(so, reduction = "lognorm.pca"),
        umap = Embeddings(so, reduction = "harmony.umap")
    )
    
)

adata
```

We can access the AnnData fields in the same way we call instance functions, with the $ syntax.

```{r}
adata$obs$head()
```

```{r}
head(py_to_r(adata$obs))
```

We can set fields in the AnnData object using the $ syntax. Here, we run CPM normalization using scanpy and save it to a new layer in the AnnData object. For the sake of demonstration, we do not use the inplace update option that scanpy provides. Note, this only works well if using the AnnDataR6 object.
```{r}
X_norm <- sc$pp$normalize_total(adata, target_sum = 1e+09, inplace = FALSE)["X"]
adata$layers["X_norm"] <- X_norm
```

