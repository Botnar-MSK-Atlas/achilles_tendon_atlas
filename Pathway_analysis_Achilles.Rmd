---
title: "Pathway analysis"
author: "Jolet Mimpen/Carla Cohen"
date: "2024-01-22"
output: html_document
---

# Pathway analysis
The aim of the script is to use pathway analysis to analyse the outputs of differential gene expression. 
Specifically this script is to analyse the results of the DEseq2 LRT test of Achilles data where muscle was included.  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Seurat)
library(SeuratObject)
library(BiocGenerics)
library(clusterProfiler)
library(msigdbr)
library(tidyverse)
#library(enrichplot)

date <- Sys.Date() %>% str_replace_all("-", "")
time <- format(Sys.time(), "%X") %>% str_replace_all(":", "-") %>%
    str_sub(1, 5)
directory <- paste0(date,"_", time, "_Pathway_Analysis.dir/")
dir.create(directory)

```

## 1. Get gene lists

### Read in gene clusters calculated by the DEseq2 LRT test

```{r}
celltypes <- c("Adipocyte", "Fasttwitch", "Granulocytes", "ITGA10Fibroblasts", 
               "Macrophages", "Mural", "NEGR1Fibroblasts", "Tcells", "VEC")

clusters <- list()

for (i in seq(1:length(celltypes))){
    clusters[[i]] <- read.csv(paste0("20240421_20-48_Pseudobulk.dir/Cluster_results/", celltypes[[i]], "_df.csv"))
}
names(clusters) <- celltypes

```

#### Genes upregrulated across microanatomy  

Create lists of genes for the following groups:  
ITGA10 fibroblasts group 2
NEGR1 fibroblasts group 3
Fasttwitch muscle group 3
Macrophages group 2
T cells group 3
Granulocytes group 2
Mural cells group 3
VEC group 2
Adipocyte group 1

```{r}

# genelists
ITGA10Fibroblasts_2 <- clusters[["ITGA10Fibroblasts"]] %>% filter (cluster == 2) %>% pull (genes)
NEGR1Fibroblasts_3 <- clusters[["NEGR1Fibroblasts"]] %>% filter (cluster == 3) %>% pull (genes)
Fasttwitch_3 <- clusters[["Fasttwitch"]] %>% filter (cluster == 3) %>% pull (genes)
Macrophages_2 <- clusters[["Macrophages"]] %>% filter (cluster == 2) %>% pull (genes)
Tcells_3 <- clusters[["Tcells"]] %>% filter (cluster == 3) %>% pull (genes)
Granulocytes_2 <- clusters[["Granulocytes"]] %>% filter (cluster == 2) %>% pull (genes)
Mural_3 <- clusters[["Mural"]] %>% filter (cluster == 3) %>% pull (genes)
VEC_2 <- clusters[["VEC"]] %>% filter (cluster == 2) %>% pull (genes)
Adipocyte_1 <- clusters[["Adipocyte"]] %>% filter (cluster == 1) %>% pull (genes)

genelists_upregulated <- list(Adipocyte_1, Fasttwitch_3, Granulocytes_2, ITGA10Fibroblasts_2, Macrophages_2, 
                              Mural_3, NEGR1Fibroblasts_3, Tcells_3, VEC_2 )
names(genelists_upregulated) <- names(clusters)

```

#### Genes downregulated across microanatomy  

Create lists of genes for the following groups:  
ITGA10 fibroblasts group 4
NEGR1 fibroblasts group 1
Fasttwitch muscle group 1
Macrophages group 3
T cells group N/A
Granulocytes group N/A 
Mural cells group 1
VEC group 1
Adipocyte group 3

```{r}

# genelists
ITGA10Fibroblasts_4 <- clusters[["ITGA10Fibroblasts"]] %>% filter (cluster == 4) %>% pull (genes)
NEGR1Fibroblasts_1 <- clusters[["NEGR1Fibroblasts"]] %>% filter (cluster == 1) %>% pull (genes)
Fasttwitch_1 <- clusters[["Fasttwitch"]] %>% filter (cluster == 1) %>% pull (genes)
Macrophages_3 <- clusters[["Macrophages"]] %>% filter (cluster == 3) %>% pull (genes)
Mural_1 <- clusters[["Mural"]] %>% filter (cluster == 1) %>% pull (genes)
VEC_1 <- clusters[["VEC"]] %>% filter (cluster == 1) %>% pull (genes)
Adipocyte_3 <- clusters[["Adipocyte"]] %>% filter (cluster == 3) %>% pull (genes)

genelists_downregulated <- list(Adipocyte_3, Fasttwitch_1, ITGA10Fibroblasts_4, Macrophages_3, 
                              Mural_1, NEGR1Fibroblasts_1, VEC_1 )
names(genelists_downregulated) <- c("Adipocyte", "Fasttwitch", "ITGA10Fibroblasts", "Macrophages", 
                                  "Mural", "NEGR1Fibroblasts", "VEC")
```

#### Genes upregrulated in tendon compared to muscle  

Create lists of genes for the following groups:  
ITGA10 fibroblasts group 1, group 6
NEGR1 fibroblasts group 2, 7
Fasttwitch muscle group 2
Macrophages group 5
VEC group 4
Adipocyte group 4

```{r}

# genelists
ITGA10Fibroblasts_1 <- clusters[["ITGA10Fibroblasts"]] %>% filter (cluster == 1) %>% pull (genes)
ITGA10Fibroblasts_6 <- clusters[["ITGA10Fibroblasts"]] %>% filter (cluster == 6) %>% pull (genes)
ITGA10Fibroblasts_1_6 <- c(ITGA10Fibroblasts_1, ITGA10Fibroblasts_6)
NEGR1Fibroblasts_2 <- clusters[["NEGR1Fibroblasts"]] %>% filter (cluster == 2) %>% pull (genes)
NEGR1Fibroblasts_7 <- clusters[["NEGR1Fibroblasts"]] %>% filter (cluster == 7) %>% pull (genes)
NEGR1Fibroblasts_2_7 <- c(NEGR1Fibroblasts_2, NEGR1Fibroblasts_7)
Fasttwitch_2 <- clusters[["Fasttwitch"]] %>% filter (cluster == 2) %>% pull (genes)
Macrophages_5 <- clusters[["Macrophages"]] %>% filter (cluster == 5) %>% pull (genes)
VEC_4 <- clusters[["VEC"]] %>% filter (cluster == 4) %>% pull (genes)
Adipocyte_4 <- clusters[["Adipocyte"]] %>% filter (cluster == 4) %>% pull (genes)

genelists_tendon_high <- list(Adipocyte_4, Fasttwitch_2, ITGA10Fibroblasts_1_6, Macrophages_5, 
                              NEGR1Fibroblasts_2_7, VEC_4 )
names(genelists_tendon_high) <- c("Adipocyte", "Fasttwitch", "ITGA10Fibroblasts", "Macrophages", 
                                  "NEGR1Fibroblasts", "VEC")

```


#### Genes upregrulated in muscle compared to tendon  

Create lists of genes for the following groups:  
ITGA10 fibroblasts group 3
NEGR1 fibroblasts group 6, 8, 10

```{r}

# genelists
ITGA10Fibroblasts_3 <- clusters[["ITGA10Fibroblasts"]] %>% filter (cluster == 3) %>% pull (genes)
NEGR1Fibroblasts_6 <- clusters[["NEGR1Fibroblasts"]] %>% filter (cluster == 6) %>% pull (genes)
NEGR1Fibroblasts_8 <- clusters[["NEGR1Fibroblasts"]] %>% filter (cluster == 8) %>% pull (genes)
NEGR1Fibroblasts_10 <- clusters[["NEGR1Fibroblasts"]] %>% filter (cluster == 10) %>% pull (genes)
NEGR1Fibroblasts_6_8_10 <- c(NEGR1Fibroblasts_6, NEGR1Fibroblasts_8, NEGR1Fibroblasts_10)

genelists_muscle_high <- list(ITGA10Fibroblasts_3, NEGR1Fibroblasts_6_8_10)
names(genelists_muscle_high) <- c("ITGA10Fibroblasts", "NEGR1Fibroblasts")

```

## 2. Access pathway databases  

### Make Hallmark reference list
```{r}
#import Hallmark pathway gene list
Hallmark_reference <- msigdbr(species = "Homo sapiens", category = "H") %>% 
  dplyr::select(gs_name, gene_symbol)

Hallmark_reference$gs_name <- gsub("_"," ", Hallmark_reference$gs_name)
Hallmark_reference$gs_name <- tolower(Hallmark_reference$gs_name)
Hallmark_reference$gs_name <- gsub("(^|[[:space:]])([[:alpha:]])", "\\1\\U\\2", Hallmark_reference$gs_name, perl=TRUE)
Hallmark_reference$gs_name <- gsub("Hallmark ","", Hallmark_reference$gs_name)
```


### Make GO reference list
```{r}
#import GO:BP pathway gene list
GOBP_reference <- msigdbr(species = "Homo sapiens", category = "C5", subcategory = "GO:BP") %>% 
  dplyr::select(gs_name, gene_symbol)

GOBP_reference$gs_name <- gsub("GOBP_","", GOBP_reference$gs_name)
GOBP_reference$gs_name <- gsub("_"," ", GOBP_reference$gs_name)
GOBP_reference$gs_name <- tolower(GOBP_reference$gs_name)
GOBP_reference$gs_name <- gsub("(^|[[:space:]])([[:alpha:]])", "\\1\\U\\2", GOBP_reference$gs_name, perl=TRUE)
```

## 3. Create background gene lists

### Create a set of background genes expressed in the tendon & muscle samples

```{r}
# Load seurat object
so.achilles <- readRDS("/project/tendonhca/shared/chromium/analysis/20231006_achilles/20240119_11-02_Fine_annotation.dir/RDS_objects.dir/Achilles_integrated_annotated.rds")

```
### Create custom background gene lists for each cell type

Simplify cell names

```{r}
df <- data.frame("cell_annotation_update" = unique( so.achilles$cell_annotation_update))
df$cell_annotation <- c("Adipocyte", 
                        "Mural", 
                        "ITGA10Fibroblasts", 
                        "VEC", 
                        "NEGR1Fibroblasts", 
                        "Macrophages", 
                        "Tcells", 
                        "LEC", 
                        "Slowtwitch", 
                        "Nerve", 
                        "Fasttwitch", 
                        "Granulocytes", 
                        "Satellite", 
                        "Transitionalmuscle", 
                        "Bcells")
#df

cell_annotation <- left_join(so.achilles[[]], df)
rownames(cell_annotation) <- colnames(so.achilles)
cell_annotation <- cell_annotation %>% select("cell_annotation")

so.achilles <- AddMetaData(so.achilles, metadata = cell_annotation, col.name = "cell_annotation")
```

```{r}
#Aggregation of counts to sample level per cell type
cts <- AggregateExpression(so.achilles, 
                    group.by = c("cell_annotation", "sample"),
                    assays = 'soupX',
                    slot = "counts",
                    return.seurat = FALSE)

# transpose & convert to df
cts.t <- as.data.frame(t(cts$soupX))

# get values where to split
splitRows <- gsub('_.*', '', rownames(cts.t))

# split data.frame into a list of df for each cell type
cts.split <- split.data.frame(cts.t,
                 f = factor(splitRows), 
                 drop = TRUE)

# fix colnames and transpose function
rownames_change <- function(x){
  rownames(x) <- gsub('.*_(.*)', '\\1', rownames(x))
  return(x)
}

# create a list of df for each cell type
counts_list <- list()
for (i in 1:length(names(cts.split))){
    counts_list[[i]] <- t(rownames_change(cts.split[[i]]))
}

names(counts_list) <- names(cts.split)

```

Make a list of expressed genes for each cell type
```{r}
# keep genes where there are at least 10 counts across all samples
# can't be too specific as some samples don't express those genes

expressed_genes <- list()
for (i in 1:length(counts_list)){
    v <- rowSums(counts_list[[i]])
    expressed_genes[[i]] <- names(v[v>9])
    print(length(expressed_genes[[i]]))
    print(head(expressed_genes[[i]]))
}

names(expressed_genes) <- names(counts_list)


```

## 4. Run Pathway analysis
Hallmark and GOBP databases are used  
Select groupings for each cell type according to up-and down-regulation across microanatomy. 
Use the "enricher" function from cluserProfiler.  

Make a function to run the enricher function according to 
- gene list
- terms (GOBP/Hallmark)
- background gene set (universe)

```{r}

run_enricher <- function(genelist, description, terms, universe){
    
    results <- list()
    dir.create(paste0(directory, "Results/", description))
    print(class(universe))
    if (class(universe) == "list"){
        my_universe <- universe[[i]]
    }else if (class(universe) == "character"){
        my_universe <- universe
    }else if (class(universe) == "NULL"){
        my_universe <- NULL
    }
    print(head(my_universe))

    for(i in 1:length(genelist)){
        current_celltype <- names(genelist[i])
        print(current_celltype)
        genes <- genelist[[i]]
        print(head(genes))
        
        results[[i]] <- enricher(genes, TERM2GENE = terms, universe = my_universe)
        
        #saveRDS(results[[i]], 
        #        paste0(directory, "Results/", description, "/", current_celltype, ".RDS"))    
        
    }
    
    names(results) <- names(genelist)
    return(results)
}

upregulated_GOBP_custom_cell <- run_enricher(genelists_upregulated, "Upregulated_GOBP_custom_cell", 
            GOBP_reference, expressed_genes)

downregulated_GOBP_custom_cell <- run_enricher(genelists_downregulated, "Downregulated_GOBP_custom_cell", 
            GOBP_reference, expressed_genes)

tendon_high_GOBP_custom_cell <- run_enricher(genelists_tendon_high, "Tendon_high_GOBP_custom_cell", 
            GOBP_reference, expressed_genes)

muscle_high_GOBP_custom_cell <- run_enricher(genelists_muscle_high, "muscle_high_GOBP_custom_cell", 
            GOBP_reference, expressed_genes)

upregulated_Hallmark_custom_cell <- run_enricher(genelists_upregulated, "Upregulated_Hallmark_custom_cell", 
            Hallmark_reference, expressed_genes)

downregulated_Hallmark_custom_cell <- run_enricher(genelists_downregulated, "Downregulated_Hallmark_custom_cell", 
            Hallmark_reference, expressed_genes)

tendon_high_Hallmark_custom_cell <- run_enricher(genelists_tendon_high, "Tendon_high_Hallmark_custom_cell", 
            Hallmark_reference, expressed_genes)

muscle_high_Hallmark_custom_cell <- run_enricher(genelists_muscle_high, "muscle_high_Hallmark_custom_cell", 
            Hallmark_reference, expressed_genes)


```

## 5. Plot results

```{r}

plot_enricher <- function(enricher_result, description){
    dir.create(paste0(directory, "Figures/", description), showWarnings = FALSE)
    for (i in 1:length(enricher_result)){
        print(names(enricher_result[i]))
        n_pathways <- enricher_result[[i]]@result %>% filter(p.adjust < 0.05) %>% rownames() %>% length()
        print(n_pathways)
        print(description)
        if (n_pathways > 0){
            dotplot(enricher_result[[i]])+
                ggtitle(paste0(names(enricher_result[i]), "_", description))
            ggsave(paste0(directory, "Figures/", description, "/", names(enricher_result[i]), ".png"))
        }else{
            print ("no significant pathways")
        }
        
    }
}

plot_enricher(upregulated_GOBP_custom_cell, "Upregulated_GOBP_custom_cell")
plot_enricher(downregulated_GOBP_custom_cell, "Downregulated_GOBP_custom_cell")
plot_enricher(tendon_high_GOBP_custom_cell, "Tendon_high_GOBP_custom_cell")
plot_enricher(muscle_high_GOBP_custom_cell, "Muscle_high_GOBP_custom_cell")

plot_enricher(upregulated_Hallmark_custom_cell, "Upregulated_Hallmark_custom_cell")
plot_enricher(downregulated_Hallmark_custom_cell, "Downregulated_Hallmark_custom_cell")
plot_enricher(tendon_high_Hallmark_custom_cell, "Tendon_high_Hallmark_custom_cell")
plot_enricher(muscle_high_Hallmark_custom_cell, "Muscle_high_Hallmark_custom_cell")

 
```

## 6.  Additional visualisation

Dotplot combining results from all cell types. 

```{r}

plot_dotplot <- function(enrichment_results, comparison){
    print(comparison)
    results <- list()
    for (i in 1:length(enrichment_results)){
        results[[i]] <- enrichment_results[[i]]@result
        results[[i]]$celltype <- names(enrichment_results)[[i]]
        results[[i]] <- results[[i]] %>% 
            filter(p.adjust < 0.05) %>% 
            arrange(desc(p.adjust))
    }
    results <- bind_rows(results)
    if (nrow(results) >0){
        # make cell type a factor
        results$celltype <- factor(results$celltype, levels = c("ITGA10Fibroblasts", "NEGR1Fibroblasts",
                                                                      "Fasttwitch", "VEC", "Mural", "Adipocyte", 
                                                                      "Macrophages", "Tcells", "Granulocytes"))
    
        filtered_res <- results %>% 
            mutate(new_col = -log10(p.adjust)) %>% 
            group_by(celltype) %>% 
            slice_min(order_by = p.adjust, n = 10) %>% 
            select(ID, GeneRatio, p.adjust, Count, celltype, new_col)
        
        # make IDs a factor
        pathways <- as.data.frame(sort(table(filtered_res$ID)))
        colnames(pathways) <- c("ID", "pathway_freq")
        filtered_res <- filtered_res %>% 
            left_join(pathways) %>%
            group_by(pathway_freq) %>%
            arrange(celltype)
        filtered_res$ID <- factor(filtered_res$ID, levels = rev(unique(filtered_res$ID)))    
                
            
        ggplot(filtered_res, aes(x = celltype, y = ID, size = Count, colour = new_col)) +
            geom_point()+
            #scale_colour_viridis()+
            theme_bw()+
            theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
            theme(axis.title.x = element_blank())+
            theme(axis.title.y = element_blank())+
            labs(colour = "-log10(p.adj)")+
            scale_y_discrete(position = "right")+
            ggtitle(comparison)
        
        ggsave (paste0(directory, "/Figures/Combined_dotplots/", comparison, ".png"), 
                width = 8, height = 7)
    }else{
        print("no significant results")
    }

    
}

plot_dotplot(upregulated_GOBP_custom_cell, "Upregulated_GOBP_custom_cell")
plot_dotplot(downregulated_GOBP_custom_cell, "Downregulated_GOBP_custom_cell")
plot_dotplot(tendon_high_GOBP_custom_cell, "Tendon_high_GOBP_custom_cell")
plot_dotplot(muscle_high_GOBP_custom_cell, "Muscle_high_GOBP_custom_cell")

plot_dotplot(upregulated_Hallmark_custom_cell, "Upregulated_Hallmark_custom_cell")
plot_dotplot(downregulated_Hallmark_custom_cell, "Downregulated_Hallmark_custom_cell")
plot_dotplot(tendon_high_Hallmark_custom_cell, "Tendon_high_Hallmark_custom_cell")
plot_dotplot(muscle_high_Hallmark_custom_cell, "Muscle_high_Hallmark_custom_cell")
    
```
Tree plot
Could be useful another time but not as useful as the combined plot here.  
https://yulab-smu.top/biomedical-knowledge-mining-book/enrichplot.html#tree-plot


```{r, fig.width=15, fig.height=8}
#go_results <- GOBP_upregulated[["NEGR1Fibroblasts"]]
#go_results_x <- pairwise_termsim(go_results)
#treeplot(go_results_x)
```

```{r}
sessionInfo()
```

