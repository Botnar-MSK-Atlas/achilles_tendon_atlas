---
title: "Annotation of integrated data"
author: "Carla Cohen"
date: "`r Sys.Date()`"
output: html_document
---

Script to annotate cell clusters on integrated data from achilles tendon. 

Follows Integration-achilles.Rmd. 

This version of the script is to analyse the integrated data with more stringent filtering and 2000 variable features.

The script performs FindMarkers to identify genes which are uniquely expressed in each cluster.  
Then heatmaps and dotplots are done at three resolutions.  
These outputs can be used to assign cell types to each cluster.  



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)


library(tidyverse)
library(Seurat)
library(cowplot)
library(yaml)
library(viridis)

# make a new output folder for each run, with the date & time in the directory name
date <- Sys.Date() %>% str_replace_all("-", "")
time <- format(Sys.time(), "%X") %>% str_replace_all(":", "-") %>%
    str_sub(1, 5)
directory <- paste0(date,"_", time, "_Annotation.dir")
dir.create(directory, showWarnings = FALSE)

#need to update yml file as appropriate
ini <- read_yaml("annotation.yml")


```

Print the parameters

```{r}
ini
```


Read in the Seurat object

```{r}

so.harmony <- readRDS(paste0(ini$integration_date, "_Integration.dir/RDS_objects.dir/Achilles_harmony_SeuratObject.rds"))
so.harmony

```

### Parameters
Extract some names that depend on the normalisation method performed

```{r}
if (ini$normalisation_method == "SCTransform"){
        
        # save the reduction names
        pca_name <- "sct.pca"
        umap_name <- "sct.umap"
        
        # save the resolution prefix
        res_prefix <- "SCT_snn_res."
        
    } else if (ini$normalisation_method == "SCTransformv2"){
    
    # save the reduction names
     pca_name <- "sctv2.pca"
     umap_name <- "sctv2.umap"
     
     # save the resolution prefix
     res_prefix <- "SCTv2_snn_res."
    
    } else if (ini$normalisation_method == "LogNormalise"){
    
     # save the reduction names
     pca_name <- "lognorm.pca"
     umap_name <- "lognorm.umap"
     
     # save the resolution prefix
     res_prefix <- "RNA_snn_res."
     
    # Some prefixes change if decontX is used for normalisation
    if (ini$normalisation_assay == "decontXcounts"){
        res_prefix <- "decontXcounts_snn_res."
    }
    if (ini$normalisation_assay == "soupX"){
        res_prefix <- "soupX_snn_res."
    }    
}
 

print(ini$normalisation_method) 
print(pca_name)
print(umap_name)
print(res_prefix)
```

### Normalisation

Log normalisation was already performed in the Filtering workflow. 
Here we need to find variable features and perform scaling for downstream visualisation, if we are working with the SCT assay. 

```{r, message=FALSE}

if (ini$normalisation_method == "SCTransform"){
    
    DefaultAssay(so.harmony) <- "RNA"
    so.harmony <- so.harmony %>% 
           FindVariableFeatures(nfeatures = 3000) %>% 
           ScaleData() 
    DefaultAssay(so.harmony) <- "SCT"
    
    # save the updated objects
    dir.create(paste0(directory, "RDS_objects.dir/SCTransform/"))
    saveRDS(so.harmony, 
            paste0(directory, "/RDS_objects.dir/SCTransform/Achilles_integrated_SCT.rds"))
}


```

# Resolution 0.1

Annotation at resolution 0.1

```{r}

# set a resolution
resolution <- 0.1
so.harmony[["seurat_clusters"]] <- so.harmony[[paste0(res_prefix, resolution)]]
Idents(so.harmony) <- so.harmony[[paste0(res_prefix, resolution)]]
levels(Idents(so.harmony))
```

## Plot the UMAP at the chosen resolution  

```{r}
p <- DimPlot(object = so.harmony, label = TRUE, reduction = "harmony.umap", shuffle = TRUE)+
    ggtitle(paste0("UMAP at resolution ", resolution))
p
```

```{r}
dir.create(paste0(directory, "/Annotation_figures/"))
ggsave(paste0(directory, "/Annotation_figures/Unlabelled_UMAP_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 6, height = 5, bg = "white")
```


### FindMarkers

Run FindAllMarkers on the RNA assay, if SCTransform v1 or log normalisation was used.
However, for SCTransformv2 you can run FindAllMarkers on the SCTv2 assay.
Save the output as a text file
This can be run on RNA, decontXassay or soupX assay  

```{r, message = FALSE}
dir.create(paste0(directory, "/Marker_lists/"), showWarnings = FALSE)



markers <-  FindAllMarkers(so.harmony,
                           assay = ini$markers_assay,
                           only.pos = ini$only_pos, 
                           min.pct = ini$min_pct, 
                           logfc.threshold = ini$logfc_threshold)
        
# save the output
write.table(markers, 
            paste0(directory, "/Marker_lists/Markers_", ini$resolution, ".txt"), 
                quote = FALSE, sep = "\t")


#NB Can read in the text files here if needed

```



Calculate the top 10 markers for each cluster by log2FC

```{r}

top10markers <- markers %>% 
    group_by(cluster) %>% 
    slice_max(n=10, order_by = abs(avg_log2FC))


```
Plot the top 10 markers as a dotplot

```{r, fig.height=20, fig.width=8, message = FALSE}

p <- DotPlot(so.harmony,
             features = unique(top10markers$gene),
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) + 
    coord_flip()+
    ggtitle(paste0("Top 10 markers at resolution ", resolution))

p



```

```{r}
dir.create(paste0(directory, "/Marker_dotplots/"))
ggsave(paste0(directory, "/Marker_dotplots/dotplot_top10_markers_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 10, height = 20, bg = "white")

```

Use the top 10 genes to plot a heatmap

```{r, fig.height=16, fig.width=8}

p <- DoHeatmap(subset(so.harmony, downsample = 500), # randomly select cells from each cluster, otherwise it's too big to plot
               features = unique(top10markers$gene),
               assay = ini$normalisation_assay) + 
        scale_fill_viridis()+ 
        ggtitle(paste0("Heatmap of top 10 markers at resolution ", resolution))

p


```
NB see the warning for which genes were omitted as they were not in the scaled data.  

```{r}
ggsave(paste0(directory, "/Annotation_figures/heatmap_top10_markers_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 12, height = 16, bg = "white")
```
### Plot groups of known markers

These groups of markers are defined by the hamstring analysis.  

Plots some general markers

```{r, fig.width=10, fig.height=20}

plot_general_markers <- function (so, resolution){
    p <- DotPlot(so.harmony, 
             features = c("COL1A1", "COL1A2", "COL3A1", "DCN",
              "HMCN1", "NEGR1", "DCLK1", "KAZN", "BICC1", "PRICKLE1",
              "CLU", "COMP", "MMP3", "NOVA1", "CILP", "FBLN1", "PRG4",
              "F13A1", "CD163", "MRC1", "MSR1",
              "PECAM1", "PTPRB", "FLT1", "VWF",
              "NOTCH3", "PDGFRB", "MYO1B",
              "TRDN", "TTN", "NEB", "TNNT1", "LGR5", "ATP2A2",
              "PLIN1", "AQP7", "ADIPOQ",
              "CD247", "SKAP1", "THEMIS",
              "TNNT3", "MYH1", "MYH3",
              "POSTN", "CSMD2", "ADAM12", "FN1", "CEMIP",
              "HLA-DRA", "CD86", "CD74",
              "ASPM", "DIAPH3", "TOP2A",
              "MMRN1", "PROX1", "PKHD1L1",
              "FCN1", "LYZ", "AOAH",
              "BCL11A", "CUX2", "CLEC4C",
              "TENM2", "PTCH2", "APOD", "CNTN4", "ABCA10",
               "KIT", "CPA3", "IL18R1",
              "AK5", "ACP5", "MMP9"),
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
    ggtitle(paste0("General markers resolution ", resolution)) +
    coord_flip()

p
}

plot_general_markers(so.harmony, 0.1)
```

```{r}

ggsave(paste0(directory, "/Marker_dotplots/dotplot_general_markers_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 10, height = 7, 
       bg = "white")

```


Plot some more refined markers after Jolet has discarded those that are not expressed  


```{r, fig.height=10, fig.width=8}
plot_updated_markers <- function (so, resolution){
    p <- DotPlot(so.harmony, 
             features =c("COL1A1", "COL1A2", "COL3A1", "DCN",
              "HMCN1", "NEGR1", "DCLK1", "KAZN", "BICC1", "PRICKLE1",
              "CLU", "COMP", "MMP3", "NOVA1", "CILP", "FBLN1", "PRG4",
              "TRDN", "TTN", "NEB", "TNNT1", "LGR5", "ATP2A2",
              "PECAM1", "PTPRB", "FLT1", "VWF",
              "PTPRC", "F13A1", "CD163", "MRC1", "MSR1",
              "PLIN1", "AQP7", "ADIPOQ",
              "NOTCH3", "PDGFRB", "MYO1B",
              "TNNT3", "MYH1", "MYH3",
              "CD247", "SKAP1", "THEMIS",
              "MMRN1", "PROX1", "PKHD1L1",
              "PAX7",
              "KIT", "CPA3", "IL18R1",
              "MS4A1", "CD37", "BLNK",
              "IL1RAPL2", "XKR4", "NRXN1",
                "ASPM", "DIAPH3", "TOP2A"),
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
    ggtitle(paste0("Updated markers resolution ", resolution)) + 
    coord_flip()
    
    p
}
plot_updated_markers(so.harmony, 0.1)

```

```{r}

ggsave(paste0(directory, "/Marker_dotplots/dotplot_updated_general_markers_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 10, height = 16, 
       bg = "white")

```

Plot a number of gene lists from the hamstring paper

```{r, fig.width=12, fig.height=16}
plot_dotplots <- function (so, resolution){
    
    p1 <- DotPlot(so.harmony, 
             features =c("COL1A1", "COL1A2", "COL3A1", "COL3A2",  "DCN", "PRG4"),
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Fibroblast markers") + 
    coord_flip()
    
    p2 <- DotPlot(so.harmony,
             features =c("PECAM1", "PTPRB", "VWF", "ADGRL4", "CD34", "CDH5", "FLT1", "NOTCH4", "TEK"),
             assay = ini$normalisation_assay)  + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Vascular endothelial markers") + coord_flip()
    
    p3 <- DotPlot(so.harmony,
             features =c("EPHB4", "FLT4", "KDR", "LYVE1", "MMRN1", "NRG3", "PKHD1L1", "PROX1"),
             assay = ini$normalisation_assay)  + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Lymphatic endothelium markers") + coord_flip()
    
    p4 <- DotPlot(so.harmony, 
             features =c("TRDN", "DES", "ACTN2", "TNNC2", "TNNI2", "TNNT3", "TNNC1", "TNNI1", "TNNT1"),
             assay = ini$normalisation_assay)  + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Skeletal muscle markers") + 
    coord_flip()
    
    p5 <- DotPlot(so.harmony, 
             features =c("ABCA8", "COL15A1", "CD55", "DCLK1", "ELN", "FBN1", "FBLN1", 
                         "FBLN2", "FBLN5", "KCND2", "NEGR1", "NOVA1", "PDGFRA", "VIT"),
             assay = ini$normalisation_assay)  + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Mural cell markers") + 
    coord_flip()
    
   p6 <- DotPlot(so.harmony, 
             features =c("GPAM", "TMEM132C", "PLIN1", "PLIN4", "AQP7", "ADIPOQ", "PDE3B", "FABP4", "LIPE"),
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Adipocyte markers") + 
    coord_flip()
    
    p7 <- DotPlot(so.harmony, 
             features =c("NTRK3", "TENM2", "KANK4", "SLC2A1", "SLC22A3", "CLDN1"),
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Nerve-like cell markers") + 
    coord_flip()
    
    p8 <- DotPlot(so.harmony, 
             features =c("PAX7", "CALCR", "CDH4", "CLCN5", "CTNND2", "GREM1"),
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Satellite cell markers") + 
    coord_flip()

    #add an overall title and arrange the graphs on one page
    title <- ggdraw() + draw_label(paste0("Cell markers at resolution ", resolution), fontface='bold', size = 16)
    p <- plot_grid(p1, p2, p3, p4, p5, p6, p7, p8, ncol = 2)
    p <- plot_grid(title, p, ncol=1, rel_heights=c(0.05, 1))
    
    p
    
    
}

plot_dotplots(so.harmony, 0.1)
```

```{r}

ggsave(paste0(directory, "/Marker_dotplots/dotplot_cell_markers_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 12, height = 16, 
       bg = "white")

```


```{r, fig.width=12, fig.height=12}
plot_immune_dotplots <- function (so, resolution){
    
    p1 <- DotPlot(so.harmony, 
             features =c("PTPRC", "CD247","IL7R", "CCR7", "THEMIS"),
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("T cell markers") + 
    coord_flip()
    
    p2 <- DotPlot(so.harmony, 
             features =c("MS4A1", "CD37", "BLNK", "CD38", "CD79A", "CD79B", "SDC1", "CD27", "CD78"),
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("B cell markers") + 
    coord_flip()
    
    p3 <- DotPlot(so.harmony, 
             features =c("CD14", "CD163", "CD163L1", "MERTK", "MRC1", "MSR1"),
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Macrophage markers") + 
    coord_flip()
    
    p4 <- DotPlot(so.harmony, 
             features =c("CD300A", "IRF7", "CLEC4C", "IL3RA", "NRP1", "HLA-DQA1", "CD74", "GPAT3", "CIITA", "HLA-DRB1"),
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Dendritic cell markers") + 
    coord_flip()
    
    p5 <- DotPlot(so.harmony, 
             features =c("KIT", "CDK15", "MS4A2", "IL18R1", "HPGD"),
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Granulocyte_markers") + 
    coord_flip()
    
    #add an overall title and arrange the graphs on one page
    title <- ggdraw() + draw_label(paste0("Immune cell markers at resolution ", resolution), fontface='bold', size = 16)
    p <- plot_grid(p1, p2, p3, p4, p5, ncol = 2)
    p <- plot_grid(title, p, ncol=1, rel_heights=c(0.05, 1))
    
    p

    
}

plot_immune_dotplots(so.harmony, 0.1)
```
```{r}
ggsave(paste0(directory, "/Marker_dotplots/dotplot_immune_cell_markers_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 12, height = 12, 
       bg = "white")
```

Plot specific muscle subtype genes

```{r, fig.height=8, fig.width=14}
plot_muscle_markers <- function (so, resolution){
    p1 <- DotPlot(so.harmony, 
             features =c("TRDN", "DES", "ACTN2"),
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("General Muscle markers") + 
    coord_flip()
    
    p2 <- DotPlot(so.harmony, 
             features =c("TNNC2", "TNNI2", "TNNT3", "ACTN3", "HOMER1", "KCNQ5", "MYH1", "MYH3", "MYLK4", "MYBPC2"),
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Fast twitch markers") + 
    coord_flip()
    
    p3 <- DotPlot(so.harmony, 
             features =c("COL22A1", "ADAMTSL1", "CPM", "CSMD1", "FRAS1", "PZP", "RALYL", "SAMD5", "SORBS2", "SPAG16"),
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Transitional markers") + 
    coord_flip()
    
    p4 <- DotPlot(so.harmony, 
             features =c("TNNC1", "TNNI1", "TNNT1", "ATP2A2", "CCR3", "LGR5", "MYH7", "MYH7B", "NEK10", "TECRL"),
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
    ggtitle("Slow twitch markers") + 
    coord_flip()
    
    #add an overall title and arrange the graphs on one page
    title <- ggdraw() + draw_label(paste0("Muscle cell markers at resolution ", resolution), fontface='bold', size = 16)
    p <- plot_grid(p1, p2, p3, p4, ncol = 2)
    p <- plot_grid(title, p, ncol=1, rel_heights=c(0.05, 1))
    
    p
}
plot_muscle_markers(so.harmony, 0.1)

```
```{r}
ggsave(paste0(directory, "/Marker_dotplots/dotplot_muscle_cell_markers_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 12, height = 12, 
       bg = "white")
```
# Resolution 0.2

Annotation at resolution 0.2

```{r}

# set a resolution
resolution <- 0.2
so.harmony[["seurat_clusters"]] <- so.harmony[[paste0(res_prefix, resolution)]]
Idents(so.harmony) <- so.harmony[[paste0(res_prefix, resolution)]]
levels(Idents(so.harmony))
```
## Plot the UMAP at the chosen resolution  

```{r}
p <- DimPlot(object = so.harmony, label = TRUE, reduction = "harmony.umap", shuffle = TRUE)+
    ggtitle(paste0("UMAP at resolution ", resolution))
p
```

```{r}
ggsave(paste0(directory, "/Annotation_figures/Unlabelled_UMAP_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 6, height = 5, bg = "white")
```


### FindMarkers

Run FindAllMarkers on the RNA assay, if SCTransform v1 or log normalisation was used.
However, for SCTransformv2 you can run FindAllMarkers on the SCTv2 assay.
Save the output as a text file
This is run on the RNA assay but using the decontX assay could be explored here. 

```{r}
markers <-  FindAllMarkers(so.harmony,
                           assay = ini$markers_assay,
                           only.pos = ini$only_pos, 
                           min.pct = ini$min_pct, 
                           logfc.threshold = ini$logfc_threshold)
        
# save the output
write.table(markers, 
            paste0(directory, "/Marker_lists/Markers_", resolution, ".txt"), 
                quote = FALSE, sep = "\t")


#NB Can read in the text files here if needed

```



Calculate the top 10 markers for each cluster by log2FC

```{r}

top10markers <- markers %>% 
    group_by(cluster) %>% 
    slice_max(n=10, order_by = abs(avg_log2FC))


```
Use the top 10 genes to plot a heatmap

```{r, fig.height=16, fig.width=8}

p <- DoHeatmap(subset(so.harmony, downsample = 500), # randomly select cells from each cluster, otherwise it's too big to plot
               features = unique(top10markers$gene),
               assay = ini$normalisation_assay) + 
        scale_fill_viridis() + 
        ggtitle(paste0("Heatmap of top 10 markers at resolution ", resolution))

p


```
NB see the warning for which genes were omitted as they were not in the scaled data.  

```{r}
dir.create(paste0(directory, "/Annotation_figures/"))
ggsave(paste0(directory, "/Annotation_figures/heatmap_top10_markers_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 12, height = 16, bg = "white")
```



### Plot groups of known markers

These groups of markers are defined by the hamstring analysis.  

Plot some more refined markers after Jolet has discarded those that are not expressed  
```{r, fig.height=10, fig.width=8}
plot_updated_markers(so.harmony, 0.2)
```

```{r}

ggsave(paste0(directory, "/Marker_dotplots/dotplot_updated_general_markers_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 10, height = 16, 
       bg = "white")

```
Plot a number of gene lists from the hamstring paper

```{r, fig.width=12, fig.height=16}
plot_dotplots(so.harmony, 0.2)
```

```{r}
ggsave(paste0(directory, "/Marker_dotplots/dotplot_cell_markers_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 12, height = 16, 
       bg = "white")
```


```{r, fig.width=12, fig.height=12}
plot_immune_dotplots(so.harmony, 0.2)
```

```{r}
ggsave(paste0(directory, "/Marker_dotplots/dotplot_immune_cell_markers_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 12, height = 12, 
       bg = "white")
```

Plot specific muscle subtype genes

```{r, fig.height=8, fig.width=14}
plot_muscle_markers(so.harmony, 0.2)

```
```{r}
ggsave(paste0(directory, "/Marker_dotplots/dotplot_muscle_cell_markers_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 12, height = 12, 
       bg = "white")
```


Does cluster 9 express COL22A1?

```{r, fig.with = 10, fig.height=6}
VlnPlot(so.harmony, features = "COL22A1")
```


# Resolution 0.3

Annotation at resolution 0.3

```{r}

# set a resolution
resolution <- 0.3
so.harmony[["seurat_clusters"]] <- so.harmony[[paste0(res_prefix, resolution)]]
Idents(so.harmony) <- so.harmony[[paste0(res_prefix, resolution)]]
levels(Idents(so.harmony))
```
### Plot the UMAP at resolution 0.3
```{r}
p <- DimPlot(object = so.harmony, label = TRUE, reduction = "harmony.umap", shuffle = TRUE)+
    ggtitle(paste0("UMAP at resolution ", resolution))
p
```

```{r}
ggsave(paste0(directory, "/Annotation_figures/Unlabelled_UMAP_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 6, height = 5, bg = "white")
```

### FindMarkers

Run FindAllMarkers on the RNA assay, if SCTransform v1 or log normalisation was used.
However, for SCTransformv2 you can run FindAllMarkers on the SCTv2 assay.
Save the output as a text file
This can be run on the RNA assay, decontX assay, or soupX assay  

```{r, message = FALSE}
markers <-  FindAllMarkers(so.harmony,
                           assay = ini$markers_assay,
                           only.pos = ini$only_pos, 
                           min.pct = ini$min_pct, 
                           logfc.threshold = ini$logfc_threshold)
        
# save the output
write.table(markers, 
            paste0(directory, "/Marker_lists/Markers_", resolution, ".txt"), 
                quote = FALSE, sep = "\t")


#NB Can read in the text files here if needed

```

Calculate the top 10 markers for each cluster by log2FC

```{r}

top10markers <- markers %>% 
    group_by(cluster) %>% 
    slice_max(n=10, order_by = abs(avg_log2FC))


```
Use the top 10 genes to plot a heatmap

```{r, fig.height=16, fig.width=8}

p <- DoHeatmap(subset(so.harmony, downsample = 500), # randomly select cells from each cluster, otherwise it's too big to plot
               features = unique(top10markers$gene),
               assay = ini$normalisation_assay) + 
        scale_fill_viridis()+ 
        ggtitle(paste0("Heatmap of top 10 markers at resolution ", resolution))

p


```

NB see the warning for which genes were omitted as they were not in the scaled data.  

```{r}
dir.create(paste0(directory, "/Annotation_figures/"))
ggsave(paste0(directory, "/Annotation_figures/heatmap_top10_markers_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 12, height = 16, bg = "white")
```



### Plot groups of known markers

These groups of markers are defined by the hamstring analysis.  

Plot some more refined markers after Jolet has discarded those that are not expressed  


```{r, message = FALSE, fig.height=10, fig.width=8}
plot_updated_markers(so.harmony, 0.3)
```
```{r}

ggsave(paste0(directory, "/Marker_dotplots/dotplot_updated_general_markers_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 10, height = 16, 
       bg = "white")

```
Plot a number of gene lists from the hamstring paper

```{r, fig.width=12, fig.height=16}
plot_dotplots(so.harmony, 0.3)
```

```{r}
ggsave(paste0(directory, "/Marker_dotplots/dotplot_cell_markers_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 12, height = 16, 
       bg = "white")
```


```{r, fig.width=12, fig.height=12}
plot_immune_dotplots(so.harmony, 0.3)
```

```{r}
ggsave(paste0(directory, "/Marker_dotplots/dotplot_immune_cell_markers_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 12, height = 12, 
       bg = "white")
```

```{r, fig.width=12, fig.height=12}
plot_muscle_markers(so.harmony, 0.3)
```

```{r}
ggsave(paste0(directory, "/Marker_dotplots/dotplot_muscle_cell_markers_", resolution, ".", ini$file_type), 
       device = ini$file_type, width = 12, height = 12, 
       bg = "white")
```

