---
title: "Microanatomy comparison"
author: "Carla Cohen"
date: "`r Sys.Date()`"
output: html_document
---

The aim of this notebook is to compare the achilles tendon microanatomies. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(Seurat)
library(cowplot)
library(yaml)
library(viridis)
library(Hmisc)


# make a new output folder for each run, with the date & time in the directory name
date <- Sys.Date() %>% str_replace_all("-", "")
time <- format(Sys.time(), "%X") %>% str_replace_all(":", "-") %>%
    str_sub(1, 5)
directory <- paste0(date,"_", time, "_Microanatomy.dir")
dir.create(directory, showWarnings = FALSE)

ini <- read_yaml("microanatomy.yml")

```

Print the parameters used
```{r}
ini
```


Read in the Seurat object

```{r}
# using until the Annotated object is saved
so.harmony <- readRDS("20240119_11-02_Fine_annotation.dir/RDS_objects.dir/Achilles_integrated_annotated.rds")

so.harmony
```
Set the colours
```{r}
achilles.colours <- c("#E25822",  # NEGH1hi fib
                      "#499999",  # Macrophages
                      "#F28E2B",  # VEC
                      "#4E79A7",  # Mural
                      "#F3C300",  # Adipocytes
                      "#E68FAC",  # T cells
                      "#8DB600",  # Nerve
                      "#888888",  # LEC
                      "#A1CAF1",  # Fast skm
                      "#BE0032",  # ITGA10hi fib
                      "#117733",  # slow skm
                      "#332288",  # granulocytes
                      "#A55194",  # 
                      "#661100",  # B cells
                      "#a0785a")  # Satellite cells

names(achilles.colours) <- c("NEGR1hi Fibroblasts", "Macrophages", "Vascular endothelial cells",  "Slow-twitch skeletal muscle cells",  "Adipocytes", "T cells", "Nervous system cells", "Lymphatic endothelial cells", "Mural cells", "ITGA10hi Fibroblasts", "Granulocytes", "Transitional skeletal muscle cells", "Fast-twitch skeletal muscle cells", "B cells", "Satellite cells")
```

Update the microanatomy metadata

```{r}
df <- data.frame("microanatomical_site" = c("Enth", "MB", "MTJ", "muscle"),
                 "microanatomy_long" = c("Enthesis", "Midbody", "MTJ", "Muscle"))

so.harmony$microanatomy_long <- left_join(so.harmony[[]], df)

```

Plot the UMAP separated by microanatomy

```{r, fig.height=10, fig.width=14}

p <- DimPlot(so.harmony, reduction = "harmony.umap", label = FALSE,
             split.by = "microanatomy_long", ncol = 2,
             cols = achilles.colours, 
             )+
        theme(panel.background = element_rect(colour = "black", linewidth = 1))
p


```


```{r}
dir.create(paste0(directory, "/Microanatomy_figures/"))
ggsave(paste0(directory, "/Microanatomy_figures/UMAP_microanatomy_comparison.", ini$file_type), 
       p, device = ini$file_type, width = 14, height = 10, bg = "white")
```

#### Patient contribution to cell numbers
How does cluster membership vary by sample?
See https://satijalab.org/seurat/archive/v3.0/interaction_vignette.html
```{r}
table(Idents(so.harmony), so.harmony$orig.ident)
```

```{r}
proportions_patient <- prop.table(table(Idents(so.harmony), so.harmony$orig.ident), margin = 1) %>% as.data.frame()
colnames(proportions_patient) <- c("cell_type", "sample", "proportion")
proportions_patient

# make sample a factor
proportions_patient <- proportions_patient %>%
  mutate(sample = fct_relevel(sample, c("MSK0785-Ach-Enth", "MSK1250-Ach-Enth", "MSK1284-Ach-Enth", 
                                        "MSK1556-Ach-Enth", "MSK1687-ACH-Enth","MSK1691-ACH-Enth",
                                        "MSK0785-Ach-MB", "MSK1250-Ach-MB2", "MSK1556-Ach-MB","MSK1687-ACH-MB",
                                        "MSK1691-ACH-MB",
                                        "MSK0785-Ach-MTJ", "MSK1250-Ach-MTJ", "MSK1556-Ach-MTJ",
                                        "MSK1687-ACH-MTJ", "MSK1691-ACH-MTJ",
                                        "MSK0785-Ach-muscle", "MSK1250-ACH-muscle", "MSK1556-ACH-muscle")))
                                       

```
```{r, fig.height = 8, fig.width=10}
pal <- c("#E25822",
                      "#499999", 
                      "#F28E2B", 
                      "#4E79A7",  
                      "#F3C300", 
                      "#E68FAC", 
                      "#8DB600",
                      "#888888",
                      "#A1CAF1", 
                      "#BE0032", 
                      "#117733", 
                      "#332288",  
                      "#A55194",
                      "#661100", 
                      "#a0785a", "#000000", "#f44336", "#ffac2a", "#d1b8c0") 
ggplot(proportions_patient, aes(fill=sample, y=proportion, x=cell_type)) +
    geom_bar(position="fill", stat="identity")+
   # scale_fill_viridis_d()+
    scale_fill_manual(values = pal)+
    theme_classic()+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


Average proportion of cells in each cluster

```{r}
df <- table(Idents(so.harmony), so.harmony$orig.ident) %>% 
    as.data.frame.matrix()

# add a row with the total number of cells per sample
df <- rbind(df, colSums(df))

# make a df with cell proportions
df.prop <- data.frame("celltype" = rownames(df))

for (sample in colnames(df)){
    df.prop[, sample] <- (df[, sample]/df["16", sample])*100
}

# remove the final row of 100%
df.prop <- df.prop %>% slice_head(n = (nrow(df.prop)-1))

#tidy the data
df.prop <- pivot_longer(df.prop, cols = c(!1), names_to = "sample", values_to = "percent")

# add column of metadata
metadata <- so.harmony[[]] %>% select(orig.ident, microanatomy_long, patient)
colnames(metadata) <- c("sample", "microanatomy", "patient")
df.prop <- df.prop %>% left_join(metadata, multiple = "first")
df.prop

# make the celltype a factor

df.prop <- df.prop %>%
  mutate(celltype = fct_relevel(celltype, rownames(df)[1:length(rownames(df))-1]))
                                       
df.prop
```
Plot using ggplot
```{r, fig.width=14, fig.height=5}
pal_microanatomy <- c("#E25822", # enthesis
                      "#499999", # MB
                      "#BE0032", # MTJ
                      "#8DB600") # muscle

names(pal_microanatomy) <- c("Enthesis", "Midbody", "MTJ", "Muscle")
                     

ggplot(df.prop, aes(x = celltype, y = percent, fill = microanatomy))+
    geom_boxplot(position=position_dodge(1))+
    #geom_dotplot(binaxis='y', stackdir='center', dotsize=0.5,
    #             position=position_dodge(1))+
    theme_classic()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12))
    
    
```
Split on multiple graphs

```{r, fig.width=14, fig.height=10}
p_fibroblast <- ggplot(df.prop %>% filter(celltype == "NEGR1hi Fibroblasts" | celltype == "ITGA10hi Fibroblasts"),
                       aes(x = celltype, y = percent, fill = microanatomy))+
    geom_boxplot(position=position_dodge(1))+
    theme_classic()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
          axis.title.x = element_blank())

p_muscle <- ggplot(df.prop %>% filter(celltype == "Slow-twitch skeletal muscle cells" | 
                                              celltype == "Fast-twitch skeletal muscle cells" |
                                              celltype == "Transitional skeletal muscle cells" |
                                            celltype == "Satellite cells"),
                       aes(x = celltype, y = percent, fill = microanatomy))+
    geom_boxplot(position=position_dodge(1))+
    theme_classic()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.x = element_blank())

p_immune <- ggplot(df.prop %>% filter(celltype == "Macrophages" | 
                                              celltype == "Granulocytes" |
                                              celltype == "T cells"), 
                       aes(x = celltype, y = percent, fill = microanatomy))+
    geom_boxplot(position=position_dodge(1))+
    theme_classic()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
          axis.title.x = element_blank())

p_endothelial <- ggplot(df.prop %>% filter(celltype == "Vascular endothelial cells" | 
                                              celltype == "Lymphatic endothelial cells" |
                                              celltype == "Mural cells"), 
                       aes(x = celltype, y = percent, fill = microanatomy))+
    geom_boxplot(position=position_dodge(1))+
    theme_classic()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
          axis.title.x = element_blank())

plot_grid(p_fibroblast, p_muscle, p_immune, p_endothelial)

```

## Dotplots to illustrate annotation

What is the relative size of the clusters?
```{r}
cluster_size <- table(Idents(so.harmony)) %>% as.data.frame() %>% arrange(desc(Freq))
colnames(cluster_size) <- c("celltype", "Freq")

cluster_size

# make a factor of these sizes
cell_type <- factor(cluster_size$celltype, levels = c(as.character(cluster_size$celltype), "Unknown/ambient"))
levels(cell_type)

levels(so.harmony$cell_annotation_update) <- levels(cell_type)
Idents(so.harmony) <- so.harmony$cell_annotation_update

cells <- as.character(levels(cell_type))
cells

so.harmony$cell_annotation_update <- factor(so.harmony$cell_annotation_update, levels = cells)

so.harmony[[]]

Idents(so.harmony) <- so.harmony$cell_annotation_update
```


```{r, fig.height=8, fig.width=14, message = FALSE}
markers <- c("COL1A1", "COL1A2", "DCN", #fibroblasts
             "PLIN1", "AQP7", "ADIPOQ", # adipocyte
              "TRDN", "TTN", "NEB", # muscle 
              "PECAM1", "PTPRB", "VWF", # VEC 
              "PTPRC", "CD163", "MRC1", # macrophage
              
              "NOTCH3", "PDGFRB", "MYO1B", # Mural
              "CD247", "SKAP1", "THEMIS", # T cell
              "MMRN1", "PROX1", "PKHD1L1", # LEC
              "PAX7","CALCR", "CDH4", # satellite cell
              "KIT", "CPA3", "IL18R1", # granulocyte
              "MS4A1", "CD37", "BLNK", # B cell
              "IL1RAPL2", "XKR4", "NRXN1") # Nervous system


DotPlot(so.harmony, 
             features =markers,
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
       theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
          axis.title.y = element_blank())
   

```
Make the dotplots with cluster numbers not cell types

```{r,fig.height=8, fig.width=14, message = FALSE}

so.harmony$soupX_snn_res.0.2 <- factor(so.harmony$soupX_snn_res.0.2, 
                                       levels = c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16))

Idents(so.harmony) <- so.harmony$soupX_snn_res.0.2

DotPlot(so.harmony, 
             features =markers,
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
       theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
          axis.title.y = element_blank())

```

Make the dotplots with original annotation

```{r,fig.height=8, fig.width=14, message = FALSE}
Idents(so.harmony) <- so.harmony$cell_annotation_0.3

DotPlot(so.harmony, 
             features =markers,
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
       theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
          axis.title.y = element_blank())

```

```{r, fig.width=10, fig.height=5}
FeaturePlot(so.harmony, 
                 features = c("NEGR1", "ITGA10"), 
                 reduction = "harmony.umap")
```

### Cellxgene marker lists

Cellxgene "fibroblast" computational markers


```{r, fig.width=14, fig.height=5}

fibroblast_genes <- Cs(DCN, COL6A2, COL1A2, LUM, COL6A3, COL6A1, C1S, FBLN1,
                       COL3A1, CCDC80, C1R, COL1A1, CFD, MFAP4, LAMA2, PCOLCE,
                       SERPINF1, ABCA6, ABCA8, MGP, FSTL1, COL5A2, FBN1, TNFAIP6,
                       PRRX1, DPT, CXCL12, GEM, ADH1B, SFRP2, CTSK, GSN, PLAC9,
                       FBLN5, IGFBP6, PDGFRA, ABCA9, C7_ENSG00000112936, LRP1, SRPX, 
                       CRISPLD2, CFH, OGN)

Idents(so.harmony) <- so.harmony$cell_annotation_update

DotPlot(so.harmony, 
             features =fibroblast_genes,
             assay = ini$normalisation_assay) + 
    scale_colour_viridis(direction = -1) +
       theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
          axis.title.y = element_blank())
```

### Old code not currently used


Question: what are the number of cells in each cluster for each microanatomy?

```{r}
#create a df with the relevant info
df <- so.harmony[[]] %>% dplyr::select (microanatomical_site, seurat_clusters)
df$identity <- Idents(so.harmony)
#df

# create a second df with numbers of cells per cluster per microanatomy
cell_numbers <- data.frame()

for (level in levels(df$seurat_clusters)){
    
    enth <- df %>% filter(seurat_clusters == level) %>% filter(microanatomical_site == "Enth") %>% nrow()
    mb <- df %>% filter(seurat_clusters == level) %>% filter(microanatomical_site == "MB") %>% nrow()
    mtj <- df %>% filter(seurat_clusters == level) %>% filter(microanatomical_site == "MTJ") %>% nrow()
    muscle <- df %>% filter(seurat_clusters == level) %>% filter(microanatomical_site == "muscle") %>% nrow()
    total <- df %>% filter(seurat_clusters == level) %>% nrow()
    ident <- df %>% filter(seurat_clusters == level) %>% slice_head(n=1) %>% pull (identity)

    column_number <- as.numeric(level) + 1

    cell_numbers[column_number, 1] <- level
    cell_numbers[column_number, 2] <- enth
    cell_numbers[column_number, 3] <- mb
    cell_numbers[column_number, 4] <- mtj
    cell_numbers[column_number, 5] <- muscle
    cell_numbers[column_number, 6] <- total
    cell_numbers[column_number, 7] <- ident

    
}

colnames(cell_numbers) <- c("cluster", "Enth", "MB", "MTJ", "Muscle", "Total", "Identity")

cell_numbers

```
 
Plot the total number of cells in each cluster
```{r}
p <-  ggplot(cell_numbers, aes (x = Identity, y = Total))+
    geom_col(fill = "#440154")+
    ggtitle("Number of cells per cluster")+
    theme(plot.title = element_text(size = 24))+
    theme_cowplot()+
    theme(axis.text.x = element_text(angle = 45, hjust=1))+
    theme(axis.title.x = element_blank())
p
```
```{r}
ggsave(paste0(directory, "/Microanatomy_figures/cell_count_per_cluster.", ini$file_type), 
       p, device = ini$file_type, width = 7, height = 7, bg = "white")
```
 
 
 
 
 Tidy the data!
 
```{r}
cell_number_tidy <- cell_numbers %>% 
    pivot_longer(2:5, values_to = "number_of_cells", names_to = "microanatomy")
cell_number_tidy
```
 


Plot number of cells per cluster by microanatomy

```{r, fig.width = 10, fig.height=6}
p <- ggplot(cell_number_tidy, aes(x = Identity, y = number_of_cells, fill = microanatomy))+
    geom_col(position = "dodge")+
    ggtitle("Number of cells per cluster by microanatomy")+
    theme(plot.title = element_text(size = 24))+
    scale_fill_viridis_d(begin = 0, end = 0.75)+
    theme_cowplot()+
    theme(axis.text.x = element_text(angle = 45, hjust=1))
p
```

```{r}
ggsave(paste0(directory, "/Microanatomy_figures/Cell_count_microanatomy.", ini$file_type), 
       p, device = ini$file_type, width = 14, height = 10, bg = "white")
```


What proportion of each cell type is represented within each cluster?

Make a df with cell fraction per microanatomy

```{r}
cell_fractions <- cell_numbers

cell_fractions$Enth_fraction <- cell_fractions$Enth/sum(cell_fractions$Enth)
cell_fractions$MB_fraction <- cell_fractions$MB/sum(cell_fractions$MB)
cell_fractions$MTJ_fraction <- cell_fractions$MTJ/sum(cell_fractions$MTJ)
cell_fractions$Muscle_fraction <- cell_fractions$Muscle/sum(cell_fractions$Muscle)

cell_fractions <- cell_fractions %>% dplyr::select(!c("Enth", "MB", "MTJ", "Muscle", "Total"))
cell_fractions

```
Tidy the data!
 
```{r}
cell_fraction_tidy <- cell_fractions %>% 
    pivot_longer(3:6, values_to = "fraction_of_cells", names_to = "microanatomy")
cell_fraction_tidy
```
Plot the fraction of cells per cluster by microanatomy

```{r, fig.width=10, fig.height=6}
p <- ggplot(cell_fraction_tidy, aes(x = Identity, y = fraction_of_cells, fill = microanatomy))+
    geom_col(position = "dodge")+
    ggtitle("Fraction of cells per cluster by microanatomy")+
    theme(plot.title = element_text(size = 24))+
    scale_fill_viridis_d(begin = 0, end = 0.75)+
    theme_cowplot()+
    theme(axis.text.x = element_text(angle = 45, hjust=1))
p
```

```{r}
ggsave(paste0(directory, "/Microanatomy_figures/Cell_fraction_microanatomy.", ini$file_type), 
       p, device = ini$file_type, width = 10, height = 6, bg = "white")
```

What fraction of each cluster comes from each microanatomy?

Downsample each microanatomy to 1000 cells

```{r, warning = FALSE}
# make a new seurat object
so.harmony.downsample <- so.harmony

# set the idents to microanatomical site
Idents(so.harmony.downsample) <- so.harmony.downsample[["microanatomical_site"]]

# downsample

# the so.harmony object has the following number of each microanatomy cell type
cat("Microanatomy representation in Seurat object")
table(so.harmony$microanatomical_site)
cat ("n")

# downsample the object to 2000 cells per microanatomy
so.harmony.downsample <- subset(so.harmony.downsample, downsample = 2000)
cat("Microanatomy representation in downsampled Seurat object")
table(so.harmony.downsample$microanatomical_site)

```


Plot the UMAP separated by microanatomy on downsampled object

```{r, fig.height=10, fig.width=14}

Idents(so.harmony.downsample) <- so.harmony.downsample$cell_annotation
p <- DimPlot(so.harmony.downsample, reduction = "harmony.umap", label = TRUE, 
             repel = TRUE, 
             split.by = "microanatomical_site", ncol = 2)+
        theme(panel.background = element_rect(colour = "black", linewidth = 1))
p
```



```{r}
ggsave(paste0(directory, "/Microanatomy_figures/UMAP_microanatomy_comparison_downsampled.", ini$file_type), 
       p, device = ini$file_type, width = 14, height = 10, bg = "white")
```

Question: what are the number of cells in each cluster for each microanatomy?

```{r}
#create a df.ds with the relevant info
df.ds <- so.harmony.downsample[[]] %>% dplyr::select (microanatomical_site, seurat_clusters)
df.ds$identity <- Idents(so.harmony.downsample)

# create a second df.ds with numbers of cells per cluster per microanatomy
cell_numbers.ds <- data.frame()

for (level in levels(df.ds$seurat_clusters)){
    
    enth <- df.ds %>% filter(seurat_clusters == level) %>% filter(microanatomical_site == "Enth") %>% nrow()
    mb <- df.ds %>% filter(seurat_clusters == level) %>% filter(microanatomical_site == "MB") %>% nrow()
    mtj <- df.ds %>% filter(seurat_clusters == level) %>% filter(microanatomical_site == "MTJ") %>% nrow()
    muscle <- df.ds %>% filter(seurat_clusters == level) %>% filter(microanatomical_site == "muscle") %>% nrow()
    total <- df.ds %>% filter(seurat_clusters == level) %>% nrow()
    ident <- df.ds %>% filter(seurat_clusters == level) %>% slice_head(n=1) %>% pull (identity)

    column_number <- as.numeric(level) + 1

    cell_numbers.ds[column_number, 1] <- level
    cell_numbers.ds[column_number, 2] <- enth
    cell_numbers.ds[column_number, 3] <- mb
    cell_numbers.ds[column_number, 4] <- mtj
    cell_numbers.ds[column_number, 5] <- muscle
    cell_numbers.ds[column_number, 6] <- total
    cell_numbers.ds[column_number, 7] <- ident

    
}

colnames(cell_numbers.ds) <- c("cluster", "Enth", "MB", "MTJ", "Muscle", "Total", "Identity")

cell_numbers.ds

```

Plot the total number of cells in each cluster after downsampling
```{r}
p <-  ggplot(cell_numbers.ds, aes (x = Identity, y = Total))+
    geom_col(fill = "#440154")+
    ggtitle("Number of cells per cluster after downsampling")+
    theme(plot.title = element_text(size = 24))+
    theme_cowplot()+
    theme(axis.text.x = element_text(angle = 45, hjust=1))+
    theme(axis.title.x = element_blank())
p
```

```{r}
ggsave(paste0(directory, "/Microanatomy_figures/cell_count_per_cluster_downsampled.", ini$file_type), 
       p, device = ini$file_type, width = 7, height = 7, bg = "white")
```

Tidy the data!
 
```{r}
cell_number_tidy.ds <- cell_numbers.ds %>% 
    pivot_longer(2:5, values_to = "number_of_cells", names_to = "microanatomy")
cell_number_tidy.ds
```
 


Plot number of cells per cluster by microanatomy

```{r, fig.width = 10, fig.height=6}
p <- ggplot(cell_number_tidy.ds, aes(x = Identity, y = number_of_cells, fill = microanatomy))+
    geom_col(position = "dodge")+
    ggtitle("Number of cells per cluster by microanatomy after downsampling")+
    theme(plot.title = element_text(size = 24))+
    scale_fill_viridis_d(begin = 0, end = 0.75)+
    theme_cowplot()+
    theme(axis.text.x = element_text(angle = 45, hjust=1))
p
```
```{r}
ggsave(paste0(directory, "/Microanatomy_figures/Cell_count_microanatomy_downsampled.", ini$file_type), 
       p, device = ini$file_type, width = 14, height = 10, bg = "white")
```